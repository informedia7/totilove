<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{pageTitle}} - Totilove</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#764ba2">
    <!-- Modern PWA meta tag (replaces deprecated apple-mobile-web-app-capable) -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Keep Apple-specific tags for iOS compatibility -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Totilove">
    
    <link rel="stylesheet" href="/assets/css/vendor/font-awesome.min.css">
    
    <!-- Layout CSS - Extracted from inline styles - Phase 1 CSS Extraction -->
    <link rel="stylesheet" href="/assets/css/new/03-layout.css">
    
    <!-- CSRF Token Management (auto-injects tokens into all requests) -->
    <!-- Industry standard: Cookie-based sessions + per-session CSRF tokens -->
    <script src="/assets/js/csrf-token.js"></script>
    
    <!-- New CSS Architecture (Compatibility Wrapper Strategy) -->
    <!-- Load order: Old CSS first (inline styles above), then new scoped CSS -->
    <!-- All new CSS is scoped to #app-root - old CSS remains untouched -->
    <!-- Conditionally loaded via asset-loader.js based on feature flags -->
    <script>
        // Inject feature flags for asset loader
        window.FEATURE_FLAGS = {{FEATURE_FLAGS_JSON}} || {
            useNewCSS: false,
            useNewJS: false,
            useNewComponents: false,
            enableAll: false
        };
    </script>
    <script>
        (function configurePresenceClient() {
            const presenceFlags = (window.FEATURE_FLAGS && window.FEATURE_FLAGS.presence) || {};
            const normalizedConfig = {
                socketEnabled: presenceFlags.socketEnabled !== false,
                streamingEnabled: presenceFlags.streamingEnabled !== false,
                sseFallbackEnabled: presenceFlags.sseFallbackEnabled !== false,
                metricsEnabled: presenceFlags.monitoringEnabled === true,
                redisEnabled: presenceFlags.redisEnabled !== false
            };
            window.PresenceConfig = Object.assign({}, normalizedConfig, window.PresenceConfig || {});
        })();
    </script>
    <script src="/assets/js/new/asset-loader.js"></script>
    
    <!-- PWA Initialization -->
    <script src="/assets/js/new/pwa-init.js"></script>
</head>
<body data-user-id="{{userId}}"
      data-user-real-name="{{real_name}}"
      data-user-email="{{userEmail}}"
      data-user-age="{{userAge}}"
      data-user-gender="{{userGenderRaw}}"
      data-user-location="{{userLocation}}"
      data-user-member-since="{{memberSince}}"
      data-user-last-active="{{lastActive}}">

    <!-- Compatibility Wrapper: All new CSS scoped to #app-root -->
    <!-- Old CSS continues to work - this wrapper only affects new scoped CSS -->
    <div id="app-root">
    
        <div class="profile-container" id="profile-container">
            <div id="loading" style="display: none;">Loading...</div>
            <div id="error" class="error-message" style="display:none;"></div>
            
            <!-- Profile Header (always visible) -->
            <div class="profile-header">
                <div class="profile-header-left">
                    <div class="profile-avatar" id="avatar" data-activity-link="true" role="link" tabindex="0" aria-label="View your activity feed">
                        {{if:userAvatar}}
                            <img src="{{userAvatar}}" alt="Profile Photo" id="layoutUserAvatar">
                        {{/if}}
                        <i class="fas fa-user profile-avatar-fallback" id="layoutUserAvatarFallback"></i>
                        <div class="online-dot"></div>
                    </div>
                    <div class="profile-main">
                        <h4 class="profile-real_name" id="real_name">{{real_name}}, {{userAge}}</h4>
                        <p class="profile-meta user-location" id="meta"><i class="fas fa-map-marker-alt"></i> {{userLocation}}</p>
                        {{if:aboutMe}}
                            <div class="profile-about-me">{{aboutMe}}</div>
                        {{/if}}
                    </div>
                </div>
                <div class="profile-header-right">
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="photo-count">{{photoCount}}</span>
                            <span class="stat-label">Photos</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="like-count">{{likeCount}}</span>
                            <span class="stat-label">Likes</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="view-count">{{viewCount}}</span>
                            <span class="stat-label">Views</span>
                        </div>
                        <div class="stat-item stat-item-position-relative-overflow-hidden" id="profile-completion-badge">
                            <div class="completion-fill-background" style="position: absolute; top: 0; left: 0; width: {{profileCompletionPercentage}}%; height: 100%; background: linear-gradient(90deg, #28a745 0%, #20c997 100%); transition: width 0.3s ease; z-index: 0;"></div>
                            <span class="stat-number stat-number-position-relative-z-index-1" id="completion-percentage">{{profileCompletionPercentage}}%</span>
                            <span class="stat-label stat-label-position-relative-z-index-1">My profile</span>
                        </div>
                        <div class="account-icon-wrapper account-icon-wrapper-position-relative-display-flex-align-items-center">
                            <i class="fas fa-user-circle user-account-icon" id="account-icon" style="color: {{accountIconColor}};"></i>
                            <div class="account-dropdown" id="account-dropdown" style="display: none;">
                                <a href="/account" class="dropdown-item">
                                    <i class="fas fa-user"></i>
                                    <span>My Account</span>
                                </a>
                                <a href="/logout" class="dropdown-item">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Hamburger Menu (right under header) -->
            <div class="mobile-menu-wrapper">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i> Menu
                </button>
                <div class="mobile-menu-container" id="mobile-menu-container">
                    <ul class="mobile-menu-list">
                        <a href="/profile-basic" class="mobile-menu-item {{profileActive}}">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                        <a href="/matches" class="mobile-menu-item {{matchesActive}}">
                            <i class="fas fa-heart"></i>
                            <span>Matches</span>
                        </a>
                        <a href="/search" class="mobile-menu-item {{searchActive}}">
                            <i class="fas fa-search"></i>
                            <span>Search</span>
                        </a>
                        <a href="/talk" class="mobile-menu-item {{talkActive}}">
                            <i class="fas fa-comments"></i>
                            <span>Talk</span>
                            <span class="talk-notification-badge" id="talk-notification-badge-mobile" style="display: none; margin-left: auto; background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem;">0</span>
                        </a>
                        <a href="/activity" class="mobile-menu-item {{activityActive}}">
                            <i class="fas fa-bell"></i>
                            <span>Activity</span>
                        </a>
                        <a href="/settings" class="mobile-menu-item {{settingsActive}}">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                        <a href="/account" class="mobile-menu-item {{accountActive}}">
                            <i class="fas fa-user-circle"></i>
                            <span>Account</span>
                        </a>
                    </ul>
                </div>
            </div>

            <!-- Main Tab Navigation (always visible) -->
            <div class="tab-navigation" id="tab-navigation">
                <div class="tab-buttons">
                    <a href="/profile-basic" class="tab-btn {{profileActive}}">
                        <i class="fas fa-user"></i>Profile
                    </a>
                    <a href="/matches" class="tab-btn {{matchesActive}}">
                        <i class="fas fa-heart"></i>Matches
                    </a>
                    <a href="/search" class="tab-btn {{searchActive}}">
                        <i class="fas fa-search"></i>Search
                    </a>
                    <a href="/talk" class="tab-btn {{talkActive}}">
                        <i class="fas fa-comments"></i>Talk
                        <span class="talk-notification-badge" id="talk-notification-badge" style="display: none;">0</span>
                    </a>
                    <a href="/activity" class="tab-btn {{activityActive}}">
                        <i class="fas fa-bell"></i>Activity
                    </a>
                    <a href="/settings" class="tab-btn {{settingsActive}}">
                        <i class="fas fa-cog"></i>Settings
                    </a>
                    <a href="/account" class="tab-btn {{accountActive}}">
                        <i class="fas fa-user-circle"></i>Account
                    </a>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                {{content}}
            </div>
        </div>
    
    </div> <!-- End #app-root wrapper -->

    <!-- Scripts -->
    {{if:presence.socketEnabled}}
        <script src="/socket.io/socket.io.js?v=1.0.1"></script>
    {{/if}}
    <script src="/assets/js/new/core/session-manager.js"></script>
    <script>
        (function bootstrapPresenceStack() {
            if (window.__disablePresenceEngine) {
                console.warn('[Presence] Loading skipped via window.__disablePresenceEngine flag');
                return;
            }
            if (window.__presenceScriptsLoaded) {
                console.debug('[Presence] Scripts already bootstrapped, skipping duplicate include');
                return;
            }
            window.__presenceScriptsLoaded = true;
            const sources = [
                '/assets/js/new/core/presence-engine.js?v=20260120'
            ];
            const loadNext = (index) => {
                if (index >= sources.length) {
                    return;
                }
                const script = document.createElement('script');
                script.src = sources[index];
                script.dataset.source = 'layout-presence-loader';
                script.defer = false;
                script.onload = () => loadNext(index + 1);
                script.onerror = (error) => {
                    console.error('[Presence] Failed to load', sources[index], error);
                    loadNext(index + 1);
                };
                document.body.appendChild(script);
            };
            loadNext(0);
        })();
    </script>
    <script src="/assets/js/new/core/stats-count.js"></script>
    <!-- User authentication data (CSP-safe: data attributes) - must load after body exists -->
    <script src="/assets/js/new/core/layout-user-data.js"></script>
    <script src="/assets/js/new/core/layout-main.js"></script>
    <script src="/assets/js/new/core/layout-init.js"></script>
</body>
</html>