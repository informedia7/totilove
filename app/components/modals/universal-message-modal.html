<!-- Universal Message Modal Component -->
<div class="universal-message-modal" id="universalMessageModal" role="dialog" aria-modal="true" aria-labelledby="messageModalTitle" aria-describedby="messageModalContent" tabindex="-1" style="display: none;">
    <div class="message-modal-window">
        <div class="message-modal-header">
            <div class="message-modal-title" id="messageModalTitle">Send New Message</div>
            <button class="message-modal-close-btn" id="closeUniversalMessageModalBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="message-modal-form">
            <div class="form-group">
                <div class="form-label">To: <span class="recipient-name" id="messageModalRecipient"></span></div>
            </div>

            <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                <label class="form-label" for="messageModalContent">Message:</label>
                <div class="rich-text-toolbar">
                    <button type="button" class="toolbar-btn" id="formatBoldBtn" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="toolbar-btn" id="formatItalicBtn" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="toolbar-btn" id="formatUnderlineBtn" title="Underline">
                        <i class="fas fa-underline"></i>
                    </button>
                    <div class="toolbar-separator"></div>
                    <button type="button" class="toolbar-btn" id="showEmojiPickerBtn" title="Emoji">
                        <i class="fas fa-smile"></i>
                    </button>
                </div>
                <div class="rich-text-editor" id="messageModalEditor" contenteditable="true" placeholder="Write your message here..."></div>
                <div id="messageModalCharCount" style="text-align:right;font-size:0.95rem;color:#888;margin-top:4px;">0/1000</div>
                <textarea class="form-input form-textarea" id="messageModalContent" style="display: none;"></textarea>
            </div>
        </div>

        <div class="message-modal-footer">
            <button class="cancel-btn" id="universalMessageCancelBtn">Cancel</button>
            <button class="send-btn" id="universalMessageSendBtn">
                <i class="fas fa-paper-plane"></i>
                <span id="messageModalSendBtnText">Send Message</span>
            </button>
        </div>
    </div>
</div>



    <!-- Include shared emoji picker utility -->
    <script src="/assets/js/emoji-picker.js"></script>

    <!-- Universal Message Confirmation Modal -->
<div id="universalMessageConfirmationModal" class="universal-message-confirmation-modal" role="dialog" aria-modal="true" aria-labelledby="universalConfirmationTitle" aria-describedby="universalConfirmationDetails" tabindex="-1" style="display: none;">
    <div class="universal-message-confirmation-content">
        <div class="confirmation-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="confirmation-body">
            <h4 id="universalConfirmationTitle">Message Sent Successfully!</h4>
            <p id="universalConfirmationDetails">Your message has been delivered.</p>
            <div class="message-details">
                <div class="detail-item">
                    <span class="detail-label">To:</span>
                    <span class="detail-value" id="universalConfirmationReceiver"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sent at:</span>
                    <span class="detail-value" id="universalConfirmationTimestamp"></span>
                </div>
            </div>
        </div>
        <div class="confirmation-actions">
            <button class="btn btn-primary" id="hideUniversalMessageConfirmationBtn">
                <i class="fas fa-check"></i>
                OK
            </button>
        </div>
    </div>
</div>

<style>
    /* Universal Message Modal Styles */
    .universal-message-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .message-modal-window {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .message-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .message-modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .message-modal-close-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .message-modal-close-btn:hover {
        background: #f0f0f0;
    }

    .message-modal-form {
        padding: 1.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-weight: 500;
        color: #333;
    }

    .recipient-name {
        font-weight: 600;
        color: #667eea;
    }

    .rich-text-toolbar {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
    }

    .toolbar-btn {
        background: none;
        border: none;
        padding: 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        color: #666;
        transition: all 0.2s;
    }

    .toolbar-btn:hover {
        background: #e9ecef;
        color: #333;
    }

    .toolbar-btn.active {
        background: #667eea;
        color: white;
    }

    .toolbar-separator {
        width: 1px;
        background: #ddd;
        margin: 0 0.25rem;
    }

    .rich-text-editor {
        min-height: 150px;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        outline: none;
        font-family: inherit;
        line-height: 1.5;
        overflow-y: auto;
    }

    .rich-text-editor:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .message-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid #eee;
    }

    .cancel-btn {
        background: #f8f9fa;
        border: 1px solid #ddd;
        color: #666;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .cancel-btn:hover {
        background: #e9ecef;
    }

    .send-btn {
        background: #667eea;
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .send-btn:hover {
        background: #5a6fd8;
    }

    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Universal Emoji Modal Styles */
    .universal-emoji-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
    }

    .universal-emoji-picker {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .universal-emoji-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .universal-emoji-header h3 {
        margin: 0;
        color: #333;
    }

    .universal-emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 0.5rem;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .emoji-item {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        font-size: 1.5rem;
        transition: background-color 0.2s;
        cursor: pointer;
    }

    .emoji-item:hover {
        background: #f0f0f0;
    }

    /* Universal Message Confirmation Modal Styles */
    .universal-message-confirmation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10002;
    }

    .universal-message-confirmation-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .confirmation-icon {
        font-size: 3rem;
        color: #00b894;
        margin-bottom: 1rem;
    }

    .confirmation-body h4 {
        margin: 0 0 1rem 0;
        color: #333;
    }

    .message-details {
        margin: 1rem 0;
        text-align: left;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        margin: 0.5rem 0;
    }

    .detail-label {
        font-weight: 500;
        color: #666;
    }

    .detail-value {
        color: #333;
    }

    .confirmation-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        border: none;
        font-size: 1rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5a6fd8;
    }

    .btn-secondary {
        background: #f8f9fa;
        color: #666;
        border: 1px solid #ddd;
    }

    .btn-secondary:hover {
        background: #e9ecef;
    }

    /* Animation for modals */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<script>
    // Universal Message Modal Variables
    let universalMessageData = {
        recipient: '',
        isReply: false,
        messageId: null,
        onSuccess: null,
        onError: null
    };

    // Match talk.html message limits for consistency
    const UNIVERSAL_MESSAGE_MAX_LENGTH = 2000; // Same as MESSAGE_CONFIG.MAX_LENGTH in talk.html
    
    // Load email verification check utility if not already loaded
    if (!window.checkEmailVerificationStatus) {
        const script = document.createElement('script');
        script.src = '/assets/js/email-verification-check.js';
        document.head.appendChild(script);
    }

    // Universal Message Modal Functions
    window.openUniversalMessageModal = async function(recipient, isReply = false, messageId = null, onSuccess = null, onError = null) {
        // Check email verification before opening modal
        if (window.checkEmailVerificationStatus) {
            const isVerified = await window.checkEmailVerificationStatus();
            if (!isVerified) {
                window.showVerificationMessage();
                return; // Don't open modal
            }
        }
        
        universalMessageData = {
            recipient: recipient,
            isReply: isReply,
            messageId: messageId,
            onSuccess: onSuccess,
            onError: onError,
            receiverId: null // Will be set by caller if available
        };
        
        // Store in window for external access
        window.universalMessageData = universalMessageData;
        
        // Set recipient name
        document.getElementById('messageModalRecipient').textContent = recipient;
        
        // Update modal title and button text
        const modalTitle = document.getElementById('messageModalTitle');
        const sendBtnText = document.getElementById('messageModalSendBtnText');
        
        if (isReply) {
            modalTitle.textContent = 'Reply to Message';
            sendBtnText.textContent = 'Send Reply';
        } else {
            modalTitle.textContent = 'Send New Message';
            sendBtnText.textContent = 'Send Message';
        }
        
        // Clear previous content
        document.getElementById('messageModalEditor').innerHTML = '';
        document.getElementById('messageModalContent').value = '';
        const charCountEl = document.getElementById('messageModalCharCount');
        if (charCountEl) {
            charCountEl.textContent = `0 / ${UNIVERSAL_MESSAGE_MAX_LENGTH}`;
            charCountEl.style.color = '#6c757d';
        }
        
        // Show modal
        const modal = document.getElementById('universalMessageModal');
        modal.style.display = 'flex';
        
        // Focus on editor
        setTimeout(() => {
            document.getElementById('messageModalEditor').focus();
        }, 100);
    }

    window.closeUniversalMessageModal = function() {
        const modal = document.getElementById('universalMessageModal');
        modal.style.display = 'none';
        
        // Reset data
        universalMessageData = {
            recipient: '',
            isReply: false,
            messageId: null,
            onSuccess: null,
            onError: null
        };
    }
    
    // Validate message content for the universal modal (uses backend badWordsFilter via /api/messages/validate)
    async function validateUniversalMessageContent(htmlContent) {
        const raw = htmlContent || '';
        // Strip HTML tags to get plain text for length/empty checks
        const textOnly = raw.replace(/<[^>]*>/g, '');
        const trimmed = textOnly.trim();
        
        if (!trimmed) {
            return { valid: false, error: 'Please enter a message' };
        }
        
        // Match talk.html limit (2000 characters)
        if (trimmed.length > UNIVERSAL_MESSAGE_MAX_LENGTH) {
            return { 
                valid: false, 
                error: `Message is too long. Maximum ${UNIVERSAL_MESSAGE_MAX_LENGTH} characters allowed.` 
            };
        }
        
        // Check for bad words via backend API (non-blocking: backend will enforce again on /send)
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000); // 2s timeout
            
            const response = await fetch('/api/messages/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: raw }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                const data = await response.json();
                if (data && (data.success === false || data.valid === false)) {
                    return {
                        valid: false,
                        error: data.error || 'Your message contains inappropriate language. Please revise your message.'
                    };
                }
            } else {
                const errorText = await response.text().catch(() => '');
                console.warn('Validation API returned error status for universal modal:', response.status, errorText);
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.warn('Bad words validation check failed for universal modal, backend will enforce:', error.message);
            }
        }
        
        // If everything is fine (or API failed), allow send; backend send endpoint will re-validate
        return { valid: true, sanitizedHtml: raw, plainText: trimmed };
    }
    
    window.sendUniversalMessage = async function() {
        const editor = document.getElementById('messageModalEditor');
        const content = editor.innerHTML.trim();
        const charCount = document.getElementById('messageModalCharCount');
        
        // Frontend validation (length, empty, bad words via backend)
        const validation = await validateUniversalMessageContent(content);
        if (!validation.valid) {
            showUniversalToast(validation.error, 'error');
            return;
        }
        
        // Get current user object - try multiple sources
        let currentUser = window.currentUser || window.sessionManager?.getCurrentUser();
        
        // Validate we have a current user with an ID
        if (!currentUser || !currentUser.id) {
            showUniversalToast('Please log in to send messages', 'error');
            console.error('‚ùå No current user found');
            return;
        }
        
        if (!universalMessageData.recipient) {
            showUniversalToast('No recipient specified', 'error');
            return;
        }
        
                            // Note: Self-message prevention is handled by the server-side API
        // The server will return an error if user tries to message themselves
        
        try {
            // Disable send button
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            // Prepare request data
            // Note: receiverUsername is used for backward compatibility with backend
            // The backend looks up by email, but we pass the recipient name
            // If receiverId is available, use it directly (more reliable)
            const requestData = {
                receiverUsername: universalMessageData.recipient, // Backend expects this field name but looks up by email
                receiverName: universalMessageData.recipient, // Also send as receiverName for clarity
                content: validation.sanitizedHtml || content,
                senderId: currentUser.id
            };
            
            // If receiverId is available, include it (this is more reliable than name lookup)
            if (universalMessageData.receiverId) {
                requestData.receiverId = universalMessageData.receiverId;
            }
            
            // Send message via API
            const response = await window.sessionManager.apiRequest('/api/messages/send', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-user-id': currentUser.id
                },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Show success confirmation
                    const receiverName = universalMessageData.recipient;
                    const isReply = universalMessageData.isReply;
                    
                    showUniversalToast(`‚úÖ ${isReply ? 'Reply' : 'Message'} sent successfully to ${receiverName}!`, 'success');
                    
                    // Show confirmation modal
                    showUniversalMessageConfirmation(receiverName, isReply);
                    
                    // Call success callback if provided
                    if (universalMessageData.onSuccess) {
                        universalMessageData.onSuccess(data);
                    }
                    
                    closeUniversalMessageModal();
                } else {
                    throw new Error(data.message || data.error || 'Failed to send message');
                }
            } else {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                
                // Check for email verification error
                if (errorData.requiresEmailVerification || errorData.code === 'EMAIL_VERIFICATION_REQUIRED') {
                    showUniversalToast('üìß Please verify your email address to send messages. Check your inbox for the verification email.', 'warning');
                    return;
                }
                
                throw new Error(errorData.error || errorData.message || `HTTP ${response.status}: Failed to send message`);
            }
        } catch (error) {
            // Check if error message contains email verification info
            if (error.message && (error.message.includes('verification') || error.message.includes('EMAIL_VERIFICATION'))) {
                showUniversalToast('üìß Please verify your email address to send messages. Check your inbox for the verification email.', 'warning');
            } else {
                showUniversalToast('Failed to send message. Please try again.', 'error');
            }
            
            // Call error callback if provided
            if (universalMessageData.onError) {
                universalMessageData.onError(error);
            }
        } finally {
            // Re-enable send button
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = false;
            const sendBtnText = document.getElementById('messageModalSendBtnText');
            const isReply = universalMessageData.isReply;
            sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i> <span id="messageModalSendBtnText">${isReply ? 'Send Reply' : 'Send Message'}</span>`;
        }
    }

    // Universal Rich Text Editor Functions
    window.formatModalText = function(command) {
        document.execCommand(command, false, null);
        updateModalToolbarState();
    }

    window.updateModalToolbarState = function() {
        const editor = document.getElementById('messageModalEditor');
        const toolbar = document.querySelector('.rich-text-toolbar');
        
        // Update toolbar button states
        toolbar.querySelectorAll('.toolbar-btn').forEach(btn => {
            const command = btn.getAttribute('onclick')?.match(/formatModalText\('(\w+)'\)/)?.[1];
            if (command) {
                if (document.queryCommandState(command)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        });
        
        // Update character count (match behavior from talk.html)
        const content = editor.textContent || editor.innerText || '';
        const charCount = document.getElementById('messageModalCharCount');
        const count = content.length;
        const maxLength = UNIVERSAL_MESSAGE_MAX_LENGTH;
        if (charCount) {
            charCount.textContent = `${count} / ${maxLength}`;
            
            // Change color when approaching limit (same thresholds as talk.html)
            if (count > maxLength * 0.9) {
                charCount.style.color = '#dc3545'; // Red
            } else if (count > maxLength * 0.75) {
                charCount.style.color = '#ffc107'; // Yellow
            } else {
                charCount.style.color = '#6c757d'; // Gray
            }
        }
        
        // Update hidden textarea for form submission
        document.getElementById('messageModalContent').value = editor.innerHTML;
    }

    // Emoji picker functions are now provided by the shared emoji-picker.js utility




    // Universal Message Confirmation Functions
    window.showUniversalMessageConfirmation = function(receiverName, isReply = false) {
        const modal = document.getElementById('universalMessageConfirmationModal');
        const receiverEl = document.getElementById('universalConfirmationReceiver');
        const timestampEl = document.getElementById('universalConfirmationTimestamp');
        const confirmationTitle = document.getElementById('universalConfirmationTitle');

        // Set the confirmation details
        receiverEl.textContent = receiverName;
        timestampEl.textContent = new Date().toLocaleString();
        confirmationTitle.textContent = isReply ? 'Reply Sent Successfully!' : 'Message Sent Successfully!';
        
        // Show modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (modal.style.display === 'flex') {
                hideUniversalMessageConfirmation();
            }
        }, 5000);
    }

    window.hideUniversalMessageConfirmation = function() {
        const modal = document.getElementById('universalMessageConfirmationModal');
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Universal Toast notification function
    window.showUniversalToast = function(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `universal-toast universal-toast-${type}`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#00b894' : type === 'error' ? '#e74c3c' : '#667eea'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10003;
            max-width: 300px;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        `;
        
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    // Initialize universal modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Universal message modal outside click
        const universalModal = document.getElementById('universalMessageModal');
        if (universalModal) {
            universalModal.addEventListener('click', function(e) {
                if (e.target === this) closeUniversalMessageModal();
            });
        }
        

        
        // Universal rich text editor event listeners
        const universalEditor = document.getElementById('messageModalEditor');
        if (universalEditor) {
            universalEditor.addEventListener('input', updateModalToolbarState);
            universalEditor.addEventListener('keyup', updateModalToolbarState);
            universalEditor.addEventListener('mouseup', updateModalToolbarState);
        }
        
        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (universalModal && universalModal.style.display === 'flex') {
                    closeUniversalMessageModal();
                }

            }
        });
    });
</script> 

<script>
// Accessibility & focus management for universal message modals
(function() {
    const focusableSelector = 'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])';

    const modals = [
        {
            id: 'universalMessageModal',
            close: () => (typeof closeUniversalMessageModal === 'function' ? closeUniversalMessageModal() : hideModalById('universalMessageModal'))
        },
        {
            id: 'universalMessageConfirmationModal',
            close: () => (typeof hideUniversalMessageConfirmation === 'function' ? hideUniversalMessageConfirmation() : hideModalById('universalMessageConfirmationModal'))
        }
    ];

    function hideModalById(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    }

    function setupModal(entry) {
        const modal = document.getElementById(entry.id);
        if (!modal) return;

        let previousFocus = null;
        let previousOverflow = null;
        let active = false;

        function trapFocus(e) {
            if (e.key !== 'Tab') return;
            const focusable = Array.from(modal.querySelectorAll(focusableSelector)).filter(el => el.offsetParent !== null);
            if (focusable.length === 0) {
                e.preventDefault();
                modal.focus();
                return;
            }
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey && document.activeElement === first) {
                e.preventDefault();
                last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
                e.preventDefault();
                first.focus();
            }
        }

        function handleKeydown(e) {
            if (e.key === 'Escape') {
                e.stopPropagation();
                entry.close?.();
                return;
            }
            trapFocus(e);
        }

        function onOpen() {
            if (active) return;
            active = true;
            previousFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
            previousOverflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';
            const wrapper = document.querySelector('.search-wrapper');
            if (wrapper) { wrapper.style.overflow = 'hidden'; }
            modal.addEventListener('keydown', handleKeydown, true);
            setTimeout(() => {
                const focusTarget = modal.querySelector(focusableSelector) || modal;
                focusTarget?.focus();
            }, 0);
        }

        function onClose() {
            if (!active) return;
            active = false;
            modal.removeEventListener('keydown', handleKeydown, true);
            document.body.style.overflow = previousOverflow;
            const wrapper = document.querySelector('.search-wrapper');
            if (wrapper) { wrapper.style.overflow = ''; }
            previousFocus?.focus?.();
        }

        const observer = new MutationObserver(() => {
            const isVisible = getComputedStyle(modal).display !== 'none';
            if (isVisible) {
                onOpen();
            } else {
                onClose();
            }
        });
        observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
        window.addEventListener('pagehide', () => observer.disconnect());
    }

    modals.forEach(setupModal);
})();
</script>
<script>
document.addEventListener('DOMContentLoaded',function(){
document.getElementById('closeUniversalMessageModalBtn')?.addEventListener('click',closeUniversalMessageModal);
document.getElementById('formatBoldBtn')?.addEventListener('click',()=>formatModalText('bold'));
document.getElementById('formatItalicBtn')?.addEventListener('click',()=>formatModalText('italic'));
document.getElementById('formatUnderlineBtn')?.addEventListener('click',()=>formatModalText('underline'));
document.getElementById('showEmojiPickerBtn')?.addEventListener('click',()=>showEmojiPicker('messageModalEditor'));
document.getElementById('universalMessageCancelBtn')?.addEventListener('click',closeUniversalMessageModal);
document.getElementById('universalMessageSendBtn')?.addEventListener('click',sendUniversalMessage);
document.getElementById('hideUniversalMessageConfirmationBtn')?.addEventListener('click',hideUniversalMessageConfirmation);
});
</script>