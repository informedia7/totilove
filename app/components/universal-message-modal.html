<!-- Universal Message Modal Component -->
<div class="universal-message-modal" id="universalMessageModal" style="display: none;">
    <div class="message-modal-window">
        <div class="message-modal-header">
            <div class="message-modal-title" id="messageModalTitle">Send New Message</div>
            <button class="message-modal-close-btn" onclick="closeUniversalMessageModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="message-modal-form">
            <div class="form-group">
                <div class="form-label">To: <span class="recipient-name" id="messageModalRecipient"></span></div>
            </div>

            <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                <label class="form-label" for="messageModalContent">Message:</label>
                <div class="rich-text-toolbar">
                    <button type="button" class="toolbar-btn" onclick="formatModalText('bold')" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="toolbar-btn" onclick="formatModalText('italic')" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="toolbar-btn" onclick="formatModalText('underline')" title="Underline">
                        <i class="fas fa-underline"></i>
                    </button>
                    <div class="toolbar-separator"></div>
                    <button type="button" class="toolbar-btn" onclick="showUniversalEmojiPicker()" title="Emoji">
                        <i class="fas fa-smile"></i>
                    </button>
                </div>
                <div class="rich-text-editor" id="messageModalEditor" contenteditable="true" placeholder="Write your message here..."></div>
                <div id="messageModalCharCount" style="text-align:right;font-size:0.95rem;color:#888;margin-top:4px;">0/1000</div>
                <textarea class="form-input form-textarea" id="messageModalContent" style="display: none;"></textarea>
            </div>
        </div>

        <div class="message-modal-footer">
            <button class="cancel-btn" onclick="closeUniversalMessageModal()">Cancel</button>
            <button class="send-btn" onclick="sendUniversalMessage()">
                <i class="fas fa-paper-plane"></i>
                <span id="messageModalSendBtnText">Send Message</span>
            </button>
        </div>
    </div>
</div>

<!-- Universal Emoji Picker Modal -->
<div id="universalEmojiPickerModal" class="universal-emoji-modal" style="display: none;">
    <div class="universal-emoji-picker">
        <div class="universal-emoji-header">
            <h3>Select Emoji</h3>
            <button class="close-btn" onclick="hideUniversalEmojiPicker()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="universal-emoji-grid" id="universalEmojiGrid">
            <!-- Emojis will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Universal Message Confirmation Modal -->
<div id="universalMessageConfirmationModal" class="universal-message-confirmation-modal" style="display: none;">
    <div class="universal-message-confirmation-content">
        <div class="confirmation-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="confirmation-body">
            <h4 id="universalConfirmationTitle">Message Sent Successfully!</h4>
            <p id="universalConfirmationDetails">Your message has been delivered.</p>
            <div class="message-details">
                <div class="detail-item">
                    <span class="detail-label">To:</span>
                    <span class="detail-value" id="universalConfirmationReceiver"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sent at:</span>
                    <span class="detail-value" id="universalConfirmationTimestamp"></span>
                </div>
            </div>
        </div>
        <div class="confirmation-actions">
            <button class="btn btn-primary" onclick="hideUniversalMessageConfirmation()">
                <i class="fas fa-check"></i>
                OK
            </button>
        </div>
    </div>
</div>

<style>
    /* Universal Message Modal Styles */
    .universal-message-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .message-modal-window {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .message-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .message-modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .message-modal-close-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .message-modal-close-btn:hover {
        background: #f0f0f0;
    }

    .message-modal-form {
        padding: 1.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-weight: 500;
        color: #333;
    }

    .recipient-name {
        font-weight: 600;
        color: #667eea;
    }

    .rich-text-toolbar {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
    }

    .toolbar-btn {
        background: none;
        border: none;
        padding: 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        color: #666;
        transition: all 0.2s;
    }

    .toolbar-btn:hover {
        background: #e9ecef;
        color: #333;
    }

    .toolbar-btn.active {
        background: #667eea;
        color: white;
    }

    .toolbar-separator {
        width: 1px;
        background: #ddd;
        margin: 0 0.25rem;
    }

    .rich-text-editor {
        min-height: 150px;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        outline: none;
        font-family: inherit;
        line-height: 1.5;
        overflow-y: auto;
    }

    .rich-text-editor:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .message-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid #eee;
    }

    .cancel-btn {
        background: #f8f9fa;
        border: 1px solid #ddd;
        color: #666;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .cancel-btn:hover {
        background: #e9ecef;
    }

    .send-btn {
        background: #667eea;
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .send-btn:hover {
        background: #5a6fd8;
    }

    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Universal Emoji Modal Styles */
    .universal-emoji-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
    }

    .universal-emoji-picker {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .universal-emoji-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .universal-emoji-header h3 {
        margin: 0;
        color: #333;
    }

    .universal-emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 0.5rem;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .emoji-item {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        font-size: 1.5rem;
        transition: background-color 0.2s;
        cursor: pointer;
    }

    .emoji-item:hover {
        background: #f0f0f0;
    }

    /* Universal Message Confirmation Modal Styles */
    .universal-message-confirmation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10002;
    }

    .universal-message-confirmation-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .confirmation-icon {
        font-size: 3rem;
        color: #00b894;
        margin-bottom: 1rem;
    }

    .confirmation-body h4 {
        margin: 0 0 1rem 0;
        color: #333;
    }

    .message-details {
        margin: 1rem 0;
        text-align: left;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        margin: 0.5rem 0;
    }

    .detail-label {
        font-weight: 500;
        color: #666;
    }

    .detail-value {
        color: #333;
    }

    .confirmation-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        border: none;
        font-size: 1rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5a6fd8;
    }

    .btn-secondary {
        background: #f8f9fa;
        color: #666;
        border: 1px solid #ddd;
    }

    .btn-secondary:hover {
        background: #e9ecef;
    }

    /* Animation for modals */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<script>
    // Universal Message Modal Variables
    let universalMessageData = {
        recipient: '',
        isReply: false,
        messageId: null,
        onSuccess: null,
        onError: null
    };

    // Load email verification check utility if not already loaded
    if (!window.checkEmailVerificationStatus) {
        const script = document.createElement('script');
        script.src = '/assets/js/new/shared/email-verification-check.js';
        document.head.appendChild(script);
    }

    // Universal Message Modal Functions
    window.openUniversalMessageModal = async function(recipient, isReply = false, messageId = null, onSuccess = null, onError = null) {
        // Check email verification before opening modal
        if (window.checkEmailVerificationStatus) {
            const isVerified = await window.checkEmailVerificationStatus();
            if (!isVerified) {
                window.showVerificationMessage();
                return;
            }
        }
        
        universalMessageData = {
            recipient: recipient,
            isReply: isReply,
            messageId: messageId,
            onSuccess: onSuccess,
            onError: onError
        };
        
        // Set recipient name
        document.getElementById('messageModalRecipient').textContent = recipient;
        
        // Update modal title and button text
        const modalTitle = document.getElementById('messageModalTitle');
        const sendBtnText = document.getElementById('messageModalSendBtnText');
        
        if (isReply) {
            modalTitle.textContent = 'Reply to Message';
            sendBtnText.textContent = 'Send Reply';
        } else {
            modalTitle.textContent = 'Send New Message';
            sendBtnText.textContent = 'Send Message';
        }
        
        // Clear previous content
        document.getElementById('messageModalEditor').innerHTML = '';
        document.getElementById('messageModalContent').value = '';
        document.getElementById('messageModalCharCount').textContent = '0/1000';
        
        // Show modal
        const modal = document.getElementById('universalMessageModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Focus on editor
        setTimeout(() => {
            document.getElementById('messageModalEditor').focus();
        }, 100);
    }

    function closeUniversalMessageModal() {
        const modal = document.getElementById('universalMessageModal');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        
        // Reset data
        universalMessageData = {
            recipient: '',
            isReply: false,
            messageId: null,
            onSuccess: null,
            onError: null
        };
    }

    async function sendUniversalMessage() {
        const editor = document.getElementById('messageModalEditor');
        const content = editor.innerHTML.trim();
        const charCount = document.getElementById('messageModalCharCount');
        
        if (!content || content === '') {
            showUniversalToast('Please enter a message', 'error');
            return;
        }
        
        if (content.length > 1000) {
            showUniversalToast('Message too long (max 1000 characters)', 'error');
            return;
        }
        
        // Get current user ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const currentUserId = urlParams.get('currentUser');
        
        if (!currentUserId || !universalMessageData.recipient) {
            showUniversalToast('Please log in to send messages', 'error');
            return;
        }
        
                            // Note: Self-message prevention is handled by the server-side API
        // The server will return an error if user tries to message themselves
        
        try {
            // Disable send button
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            // Prepare request data
            const requestData = {
                receiverUsername: universalMessageData.recipient,
                content: content,
                senderId: currentUserId
            };
            
            // Send message via API
            const response = await window.sessionManager.apiRequest('/api/messages/send', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-user-id': currentUserId
                },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Show success confirmation
                    const receiverName = universalMessageData.recipient;
                    const isReply = universalMessageData.isReply;
                    
                    showUniversalToast(`âœ… ${isReply ? 'Reply' : 'Message'} sent successfully to ${receiverName}!`, 'success');
                    
                    // Show confirmation modal
                    showUniversalMessageConfirmation(receiverName, isReply);
                    
                    // Call success callback if provided
                    if (universalMessageData.onSuccess) {
                        universalMessageData.onSuccess(data);
                    }
                    
                    closeUniversalMessageModal();
                } else {
                    throw new Error(data.message || data.error || 'Failed to send message');
                }
            } else {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                
                // Check for email verification error
                if (errorData.requiresEmailVerification || errorData.code === 'EMAIL_VERIFICATION_REQUIRED') {
                    showUniversalToast('ðŸ“§ Please verify your email address to send messages. Check your inbox for the verification email.', 'warning');
                    return;
                }
                
                throw new Error(errorData.error || errorData.message || `HTTP ${response.status}: Failed to send message`);
            }
        } catch (error) {
            // Check if error message contains email verification info
            if (error.message && (error.message.includes('verification') || error.message.includes('EMAIL_VERIFICATION'))) {
                showUniversalToast('ðŸ“§ Please verify your email address to send messages. Check your inbox for the verification email.', 'warning');
            } else {
                showUniversalToast('Failed to send message. Please try again.', 'error');
            }
            
            // Call error callback if provided
            if (universalMessageData.onError) {
                universalMessageData.onError(error);
            }
        } finally {
            // Re-enable send button
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = false;
            const sendBtnText = document.getElementById('messageModalSendBtnText');
            const isReply = universalMessageData.isReply;
            sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i> <span id="messageModalSendBtnText">${isReply ? 'Send Reply' : 'Send Message'}</span>`;
        }
    }

    // Universal Rich Text Editor Functions
    function formatModalText(command) {
        document.execCommand(command, false, null);
        updateModalToolbarState();
    }

    function updateModalToolbarState() {
        const editor = document.getElementById('messageModalEditor');
        const toolbar = document.querySelector('.rich-text-toolbar');
        
        // Update toolbar button states
        toolbar.querySelectorAll('.toolbar-btn').forEach(btn => {
            const command = btn.getAttribute('onclick')?.match(/formatModalText\('(\w+)'\)/)?.[1];
            if (command) {
                if (document.queryCommandState(command)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        });
        
        // Update character count
        const content = editor.textContent || editor.innerText || '';
        const charCount = document.getElementById('messageModalCharCount');
        const count = content.length;
        charCount.textContent = `${count}/1000`;
        
        // Update hidden textarea for form submission
        document.getElementById('messageModalContent').value = editor.innerHTML;
    }

    // Universal Emoji Picker Functions
    function showUniversalEmojiPicker() {
        console.log('Opening universal emoji picker...');
        const modal = document.getElementById('universalEmojiPickerModal');
        const grid = document.getElementById('universalEmojiGrid');
        
        if (!modal || !grid) {
            console.error('Universal emoji picker elements not found');
            return;
        }
        
        // Populate emoji grid
        const emojis = ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜Ÿ', 'ðŸ˜•', 'ðŸ™', 'â˜¹ï¸', 'ðŸ˜£', 'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ¥º', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ¤¯', 'ðŸ˜³', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ˜±', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜“', 'ðŸ¤—', 'ðŸ¤”', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤¥', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¯', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜®', 'ðŸ˜²', 'ðŸ¥±', 'ðŸ˜´', 'ðŸ¤¤', 'ðŸ˜ª', 'ðŸ˜µ', 'ðŸ¤', 'ðŸ¥´', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤‘', 'ðŸ¤ ', 'ðŸ’©', 'ðŸ‘»', 'ðŸ’€', 'â˜ ï¸', 'ðŸ‘½', 'ðŸ‘¾', 'ðŸ¤–', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾', 'â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ¤Ž', 'ðŸ’”', 'â£ï¸', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ', 'ðŸ‘', 'ðŸ‘Ž', 'ðŸ‘Œ', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ–•', 'ðŸ‘‡', 'â˜ï¸', 'ðŸ‘‹', 'ðŸ¤š', 'ðŸ–ï¸', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤Œ', 'ðŸ¤', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ–•', 'ðŸ‘‡', 'â˜ï¸', 'ðŸ‘‹', 'ðŸ¤š', 'ðŸ–ï¸', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤Œ', 'ðŸ¤'];
        
        // Clear previous content and add emojis
        grid.innerHTML = '';
        emojis.forEach(emoji => {
            const emojiDiv = document.createElement('div');
            emojiDiv.className = 'emoji-item';
            emojiDiv.textContent = emoji;
            emojiDiv.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                insertUniversalEmoji(emoji);
            });
            grid.appendChild(emojiDiv);
        });
        
        // Show modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        console.log('Universal emoji picker opened successfully');
    }

    function hideUniversalEmojiPicker() {
        const modal = document.getElementById('universalEmojiPickerModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }

    function insertUniversalEmoji(emoji) {
        const editor = document.getElementById('messageModalEditor');
        
        // Ensure the editor is focused
        editor.focus();
        
        // Get current selection
        const selection = window.getSelection();
        
        if (selection.rangeCount > 0) {
            // Insert at cursor position
            const range = selection.getRangeAt(0);
            const textNode = document.createTextNode(emoji);
            range.deleteContents();
            range.insertNode(textNode);
            range.collapse(false);
            range.selectNodeContents(textNode);
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
        } else {
            // Insert at end if no selection
            const textNode = document.createTextNode(emoji);
            editor.appendChild(textNode);
            
            // Set cursor after the emoji
            const range = document.createRange();
            range.setStartAfter(textNode);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }
        
        // Update the toolbar and character count
        updateModalToolbarState();
        
        // Hide the emoji picker
        hideUniversalEmojiPicker();
        
        // Keep focus on editor
        editor.focus();
        
        console.log('Universal emoji inserted successfully:', emoji);
    }

    // Universal Message Confirmation Functions
    function showUniversalMessageConfirmation(receiverName, isReply = false) {
        const modal = document.getElementById('universalMessageConfirmationModal');
        const receiverEl = document.getElementById('universalConfirmationReceiver');
        const timestampEl = document.getElementById('universalConfirmationTimestamp');
        const confirmationTitle = document.getElementById('universalConfirmationTitle');

        // Set the confirmation details
        receiverEl.textContent = receiverName;
        timestampEl.textContent = new Date().toLocaleString();
        confirmationTitle.textContent = isReply ? 'Reply Sent Successfully!' : 'Message Sent Successfully!';
        
        // Show modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (modal.style.display === 'flex') {
                hideUniversalMessageConfirmation();
            }
        }, 5000);
    }

    function hideUniversalMessageConfirmation() {
        const modal = document.getElementById('universalMessageConfirmationModal');
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Universal Toast notification function
    function showUniversalToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `universal-toast universal-toast-${type}`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#00b894' : type === 'error' ? '#e74c3c' : '#667eea'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10003;
            max-width: 300px;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        `;
        
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    // Initialize universal modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Universal message modal outside click
        const universalModal = document.getElementById('universalMessageModal');
        if (universalModal) {
            universalModal.addEventListener('click', function(e) {
                if (e.target === this) closeUniversalMessageModal();
            });
        }
        
        // Universal emoji picker outside click
        const universalEmojiModal = document.getElementById('universalEmojiPickerModal');
        if (universalEmojiModal) {
            universalEmojiModal.addEventListener('click', function(e) {
                if (e.target === this) hideUniversalEmojiPicker();
            });
            
            // Prevent clicks inside the emoji picker from closing it
            const emojiPicker = universalEmojiModal.querySelector('.universal-emoji-picker');
            if (emojiPicker) {
                emojiPicker.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }
        
        // Universal rich text editor event listeners
        const universalEditor = document.getElementById('messageModalEditor');
        if (universalEditor) {
            universalEditor.addEventListener('input', updateModalToolbarState);
            universalEditor.addEventListener('keyup', updateModalToolbarState);
            universalEditor.addEventListener('mouseup', updateModalToolbarState);
        }
        
        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (universalModal && universalModal.style.display === 'flex') {
                    closeUniversalMessageModal();
                }
                if (universalEmojiModal && universalEmojiModal.style.display === 'flex') {
                    hideUniversalEmojiPicker();
                }
            }
        });
    });
</script> 