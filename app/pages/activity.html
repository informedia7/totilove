<!-- Include Universal Message Modal (must be loaded before activity script) -->
{{include:modals/universal-message-modal}}

<!-- Include User Profile Modal -->
{{include:modals/user-profile-modal}}

<!-- Include User Report Modal -->
{{include:modals/user-report-modal}}

<!-- Block Confirmation Modal -->
<div id="blockConfirmModal" class="block-confirm-modal" style="display: none;">
    <div class="block-confirm-overlay"></div>
    <div class="block-confirm-content">
        <div class="block-confirm-icon">
            <i class="fas fa-ban"></i>
        </div>
        <h3 class="block-confirm-title">Block User?</h3>
        <p class="block-confirm-message">Are you sure you want to block <strong id="blockUsername">this user</strong>? They will no longer be able to contact you or see your profile in search results.</p>
        <div class="block-confirm-actions">
            <button class="block-confirm-cancel" onclick="closeBlockConfirm()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="block-confirm-yes" onclick="confirmBlock()">
                <i class="fas fa-ban"></i> Block User
            </button>
        </div>
    </div>
</div>

<style>
.block-confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.block-confirm-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.block-confirm-content {
    position: relative;
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
    text-align: center;
}

@keyframes slideUp {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.block-confirm-icon {
    width: 70px;
    height: 70px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, #d63031, #e74c3c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
}

.block-confirm-title {
    font-size: 1.5rem;
    color: #2d3436;
    margin-bottom: 1rem;
    font-weight: 700;
}

.block-confirm-message {
    color: #636e72;
    line-height: 1.6;
    margin-bottom: 2rem;
    font-size: 1rem;
}

.block-confirm-message strong {
    color: #2d3436;
    font-weight: 600;
}

.block-confirm-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.block-confirm-cancel,
.block-confirm-yes {
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-size: 1rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.block-confirm-cancel {
    background: #dfe6e9;
    color: #2d3436;
}

.block-confirm-cancel:hover {
    background: #b2bec3;
}

.block-confirm-yes {
    background: linear-gradient(135deg, #d63031, #e74c3c);
    color: white;
}

.block-confirm-yes:hover {
    background: linear-gradient(135deg, #c0392b, #d63031);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(214, 48, 49, 0.3);
}
</style>

<!-- Unblock Confirmation Modal -->
<div id="unblockConfirmModal" class="unblock-confirm-modal" style="display: none;">
    <div class="unblock-confirm-overlay"></div>
    <div class="unblock-confirm-content">
        <div class="unblock-confirm-icon">
            <i class="fas fa-unlock"></i>
        </div>
        <h3 class="unblock-confirm-title">Unblock User?</h3>
        <p class="unblock-confirm-message">Are you sure you want to unblock <strong id="unblockUsername">this user</strong>? They will be able to contact you and see your profile in search results again.</p>
        <div class="unblock-confirm-actions">
            <button class="unblock-confirm-cancel" onclick="closeUnblockConfirm()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="unblock-confirm-yes" onclick="confirmUnblock()">
                <i class="fas fa-unlock"></i> Unblock User
            </button>
        </div>
    </div>
</div>

<style>
.unblock-confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.unblock-confirm-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.unblock-confirm-content {
    position: relative;
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
    text-align: center;
}

.unblock-confirm-icon {
    width: 70px;
    height: 70px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, #00b894, #00d2a0);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
}

.unblock-confirm-title {
    font-size: 1.5rem;
    color: #2d3436;
    margin-bottom: 1rem;
    font-weight: 700;
}

.unblock-confirm-message {
    color: #636e72;
    line-height: 1.6;
    margin-bottom: 2rem;
    font-size: 1rem;
}

.unblock-confirm-message strong {
    color: #2d3436;
    font-weight: 600;
}

.unblock-confirm-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.unblock-confirm-cancel,
.unblock-confirm-yes {
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-size: 1rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.unblock-confirm-cancel {
    background: #dfe6e9;
    color: #2d3436;
}

.unblock-confirm-cancel:hover {
    background: #b2bec3;
}

.unblock-confirm-yes {
    background: linear-gradient(135deg, #00b894, #00d2a0);
    color: white;
}

.unblock-confirm-yes:hover {
    background: linear-gradient(135deg, #00a885, #00b894);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
}
</style>

<!-- Activity Page -->
<script>
    // Inject user data from server template variables
    window.currentUser = {
        id: parseInt('{{userId}}') || null,
        real_name: '{{realName}}' || '',
        email: '{{userEmail}}' || ''
    };
    
    // Set authentication status
    window.isAuthenticated = window.currentUser.id && window.currentUser.id !== 'null' && window.currentUser.id !== '';

    // Load email verification check utility
    if (!window.checkEmailVerificationStatus) {
        const script = document.createElement('script');
        script.src = '/assets/js/email-verification-check.js';
        document.head.appendChild(script);
    }
    
    // Unblock confirmation modal functions
    function closeUnblockConfirm() {
        document.getElementById('unblockConfirmModal').style.display = 'none';
        ActivityManager.pendingUnblockUserId = null;
    }
    
    function confirmUnblock() {
        const userId = ActivityManager.pendingUnblockUserId;
        if (userId) {
            closeUnblockConfirm();
            ActivityManager.unblockUser(userId);
        }
    }
    
    // Close modal when clicking overlay
    document.addEventListener('DOMContentLoaded', function() {
        const overlay = document.querySelector('.unblock-confirm-overlay');
        if (overlay) {
            overlay.addEventListener('click', closeUnblockConfirm);
        }
    });
</script>

<style>
    @keyframes online-blink {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 2px #fff, 0 0 4px 1px #00b894;
            opacity: 1;
        }
        50% {
            transform: scale(1.07);
            box-shadow: 0 0 0 2.7px #fff, 0 0 7px 1.7px #00b894;
            opacity: 0.90;
        }
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .activity-container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .activity-header {
        margin-bottom: 2rem;
    }
    
    .activity-header h2 {
        color: var(--primary);
        margin-bottom: 1rem;
        font-size: 2rem;
        font-weight: 700;
    }
    
    .activity-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .activity-tab {
        padding: 0.5rem 1rem;
        border: 2px solid var(--primary);
        background: transparent;
        color: var(--primary);
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-width: 50px;
        height: 50px;
    }
    
    .activity-tab.active {
        background: var(--primary);
        color: white;
    }
    
    .activity-tab:hover:not(.active) {
        background: rgba(102, 126, 234, 0.1);
    }
    
    .activity-tab i {
        font-size: 1.2rem;
    }
    
    .activity-tab span {
        display: inline;
    }
    
    @media (max-width: 768px) {
        .activity-container {
            padding: 1rem;
        }
        
        .activity-tabs {
            gap: 0.5rem;
        }
        
        .activity-tab {
            min-width: 45px;
            height: 45px;
            padding: 0.4rem 0.8rem;
        }
        
        .activity-tab span {
            display: none;
        }
    }
</style>
<div class="activity-container">
    <!-- Activity Header -->
    <div class="card-header">
        <div class="card-title">
            <div class="card-icon">
                <i class="fas fa-bell"></i>
            </div>
            <span>Activity:</span>
        </div>
    </div>
    <div class="activity-tabs">
        <button class="activity-tab active" data-tab="all">
            <i class="fas fa-bell"></i>
            <span>All Activity</span>
        </button>
        <button class="activity-tab" data-tab="messages">
            <i class="fas fa-envelope"></i>
        </button>
        <button class="activity-tab" data-tab="views" style="position: relative;">
            <i class="fas fa-eye"></i>
            <span class="views-badge notification-badge" style="position: absolute; top: -15px; right: -5px; background: #00b894; border-radius: 50%; width: 19px; height: 19px; border: 3px solid #fff; box-shadow: 0 0 0 2px #fff; animation: online-blink 3s infinite; z-index: 2; display: none; align-items: center; justify-content: center; box-sizing: border-box;"></span>
        </button>
        <button class="activity-tab" data-tab="favorites">
            <i class="fas fa-heart" style="color: var(--danger-color);"></i>
        </button>
        <button class="activity-tab" data-tab="liked">
            <i class="fas fa-thumbs-up" style="color: #f39c12;"></i>
        </button>
        <button class="activity-tab" data-tab="blocked">
            <i class="fas fa-ban"></i>
        </button>
    </div>

    <!-- Who Viewed Me Section -->
    <div class="activity-section viewers-section" style="margin-bottom: 2.5rem;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: var(--dark-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-eye" style="color: var(--primary);"></i>
                Who Viewed Me
                <span class="viewers-count-badge" style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">0 today</span>
                <div class="viewers-view-all" style="display: none; margin-left: 0.5rem;">
                    <button class="view-all-viewers-btn" style="background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 0.4rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">View All (<span class="total-viewers-count">0</span>)</button>
                </div>
            </h3>
        </div>
        
        <div class="viewers-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem;">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- My Favorites Section -->
    <div class="activity-section favorites-section" style="margin-bottom: 2.5rem;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: var(--dark-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-heart" style="color: var(--danger-color);"></i>
                My Favorites
                <div class="favorites-view-all" style="display: inline-block; margin-left: 0.5rem;">
                    <button class="view-all-favorites-btn" style="background: transparent; color: var(--danger-color); border: 2px solid var(--danger-color); padding: 0.4rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">View All (<span class="total-favorites-count">0</span>)</button>
                </div>
                <div class="favorites-default-view" style="display: none; margin-left: 0.5rem;">
                    <button class="default-view-favorites-btn" style="background: transparent; color: var(--danger-color); border: 2px solid var(--danger-color); padding: 0.4rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Default View</button>
                </div>
            </h3>
        </div>
        
        <div class="favorites-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem;">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- New Messages Section -->
    <div class="activity-section messages-section" style="margin-bottom: 2.5rem;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; cursor: pointer;" onclick="ActivityManager.toggleSection('messages')">
            <h3 style="color: var(--dark-color); display: flex; align-items: center; gap: 0.5rem;">
                <span class="messages-toggle-icon" style="font-size: 1.5rem; color: var(--dark-color); user-select: none;">+</span>
                <i class="fas fa-envelope" style="color: var(--primary);"></i>
                New Messages
                <span class="messages-count-badge" style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">0 new</span>
            </h3>
        </div>
        
        <div class="messages-list" style="display: none; gap: 1rem;">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Who Liked Me Section -->
    <div class="activity-section who-liked-me-section" style="margin-bottom: 2.5rem;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: var(--dark-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-thumbs-up" style="color: #f39c12;"></i>
                Who Liked Me
                <span class="who-liked-me-count-badge" style="background: #f39c12; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">0 today</span>
                <div class="who-liked-me-view-all" style="display: none; margin-left: 0.5rem;">
                    <button class="view-all-who-liked-me-btn" style="background: transparent; color: #f39c12; border: 2px solid #f39c12; padding: 0.4rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">View All (<span class="total-who-liked-me-count">0</span>)</button>
                </div>
            </h3>
        </div>
        
        <div class="who-liked-me-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem;">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Who I Like Section -->
    <div class="activity-section who-i-like-section" style="margin-bottom: 2.5rem;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: var(--dark-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-thumbs-up" style="color: #f39c12;"></i>
                Who I Like
                <div class="who-i-like-view-all" style="display: inline-block; margin-left: 0.5rem;">
                    <button class="view-all-who-i-like-btn" style="background: transparent; color: #f39c12; border: 2px solid #f39c12; padding: 0.4rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">View All (<span class="total-who-i-like-count">0</span>)</button>
                </div>
                <div class="who-i-like-default-view" style="display: none; margin-left: 0.5rem;">
                    <button class="default-view-who-i-like-btn" style="background: transparent; color: #f39c12; border: 2px solid #f39c12; padding: 0.4rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Default View</button>
                </div>
            </h3>
        </div>
        
        <div class="who-i-like-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem;">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Blocked Users Section -->
    <div class="activity-section blocked-users-section" style="margin-bottom: 2.5rem;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: var(--dark-color); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-ban" style="color: #d63031;"></i>
                Blocked Users
                <span class="blocked-users-count-badge" style="background: #d63031; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">0 blocked</span>
            </h3>
        </div>
        
        <div class="blocked-users-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem;">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Get session token function
    function getSessionToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        
        if (urlToken) {
            return urlToken;
        }
        
        // Try session manager first (preferred method)
        if (window.sessionManager && window.sessionManager.getToken) {
            return window.sessionManager.getToken() || '';
        }
        
        // Try cookies as fallback
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'sessionToken') {
                return value;
            }
        }
        
        return '';
    }
    
    // Load ProfileModalActions module
    function loadProfileModalActions() {
        if (typeof window.ProfileModalActions === 'undefined') {
            const script = document.createElement('script');
            script.src = '/components/modals/profile-modal-actions.js';
            script.onload = function() {
                // Initialize with page-specific configuration
                if (window.ProfileModalActions) {
                    window.ProfileModalActions.init({
                        getCurrentUserId: () => ActivityManager.currentUserId,
                        getCurrentProfileUserId: () => window.getCurrentProfileUserId ? window.getCurrentProfileUserId() : null,
                        getSessionToken: getSessionToken,
                        showNotification: (message, type) => ActivityManager.showToast(message, type)
                    });
                }
            };
            script.onerror = function() {
                console.warn('⚠️ Failed to load ProfileModalActions module');
            };
            document.head.appendChild(script);
        } else {
            // Already loaded, just initialize
            if (window.ProfileModalActions) {
                window.ProfileModalActions.init({
                    getCurrentUserId: () => ActivityManager.currentUserId,
                    getCurrentProfileUserId: () => window.getCurrentProfileUserId ? window.getCurrentProfileUserId() : null,
                    getSessionToken: getSessionToken,
                    showNotification: (message, type) => ActivityManager.showToast(message, type)
                });
            }
        }
    }
    
    // Activity data management
    const ActivityManager = {
        currentFilter: 'all',
        currentUserId: null,
        
        // Get user ID from current session
        getUserIdFromToken() {
            // Try from global currentUser first
            if (window.currentUser && window.currentUser.id) {
                return window.currentUser.id;
            }
            
            // Try from session manager
            if (window.sessionManager && typeof window.sessionManager.getCurrentUser === 'function') {
                const user = window.sessionManager.getCurrentUser();
                if (user && user.id) {
                    return user.id;
                }
            }
            
            return null;
        },
        
        // Initialize the activity page
        async init() {
            // Get current user ID
            this.currentUserId = this.getUserIdFromToken();
            
            if (!this.currentUserId) {
                console.warn('⚠️ User ID not found, showing empty state...');
                // Don't redirect, just show empty state
            }
            
            await this.loadAllActivity();
            this.setupEventListeners();
        },
        
        // Load all activity data
        async loadAllActivity() {
            await Promise.all([
                this.loadViewers(),
                this.loadFavorites(),
                this.loadMessages(),
                this.loadWhoLikedMe(),
                this.loadWhoILike(),
                this.loadBlockedUsers()
            ]);
        },
        
        // Load profile viewers
        async loadViewers() {
            try {
                // Show all recent viewers (not just today's) - the "X today" badge shows today's count separately
                const response = await fetch('/api/activity/viewers?limit=3', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderViewers(data.viewers);
                    this.updateViewersCount(data.todayCount, data.totalCount);
                }
            } catch (error) {
                console.error('Error loading viewers:', error);
                this.showError('.viewers-list', 'Failed to load viewers');
            }
        },
        
        // Load favorites
        async loadFavorites() {
            try {
                // Show only 6 favorites initially
                const response = await fetch('/api/activity/favorites?limit=6', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderFavorites(data.favorites);
                    this.updateFavoritesCount(data.totalCount);
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
                this.showError('.favorites-grid', 'Failed to load favorites');
            }
        },
        
        // Load new messages
        async loadMessages() {
            try {
                const response = await fetch('/api/activity/messages?limit=50', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderMessages(data.messages);
                    this.updateMessagesCount(data.unreadCount);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                this.showError('.messages-list', 'Failed to load messages');
            }
        },
        
        // Load likes
        async loadWhoLikedMe() {
            try {
                // Show all recent likes (not just today's) - the "X today" badge shows today's count separately
                const response = await fetch('/api/activity/who-liked-me?limit=6', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderWhoLikedMe(data.users);
                    this.updateWhoLikedMeCount(data.todayCount, data.totalCount);
                }
            } catch (error) {
                console.error('Error loading who liked me:', error);
                this.showError('.who-liked-me-grid', 'Failed to load who liked me');
            }
        },

        async loadWhoILike() {
            try {
                const response = await fetch('/api/activity/who-i-like?limit=6', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderWhoILike(data.users);
                    this.updateWhoILikeCount(data.totalCount || data.users?.length || 0);
                }
            } catch (error) {
                console.error('Error loading who I like:', error);
                this.showError('.who-i-like-grid', 'Failed to load who I like');
            }
        },

        async loadBlockedUsers() {
            try {
                const response = await fetch('/api/blocked-users', {
                    headers: {
                        'X-User-ID': this.currentUserId,
                        'Authorization': `Bearer ${getSessionToken()}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderBlockedUsers(data.blockedUsers || []);
                    this.updateBlockedUsersCount(data.blockedUsers?.length || 0);
                }
            } catch (error) {
                console.error('Error loading blocked users:', error);
                this.showError('.blocked-users-grid', 'Failed to load blocked users');
            }
        },
        
        // Render viewers
        renderViewers(viewers) {
            const container = document.querySelector('.viewers-list');
            
            if (!viewers || viewers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 2rem;">No viewers yet</p>';
                return;
            }
            
            const html = viewers.map(viewer => {
                // Extract and validate real_name
                let real_name = viewer.name || viewer.real_name || 'Unknown User';
                if (!real_name || real_name.trim() === '') {
                    real_name = 'Unknown User';
                }
                
                const location = viewer.location || 'Unknown';
                const age = viewer.age || 'N/A';
                const defaultImg = (viewer.gender && viewer.gender.toString().toLowerCase() === 'f') ? '/assets/images/default_profile_female.svg' : '/assets/images/default_profile_male.svg';
                const profileImage = viewer.profile_image || defaultImg;
                
                // Escape values for safe HTML insertion
                const safeUsername = this.escapeHtml(real_name);
                const safeLocation = this.escapeHtml(location);
                
                return `
                <div class="viewer-card" data-user-id="${viewer.user_id}" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(31,38,135,0.08); overflow: hidden; transition: transform 0.2s; cursor: pointer;">
                    <div style="position: relative;">
                        <img src="${profileImage}" alt="${safeUsername}" style="width: 100%; height: 140px; object-fit: cover;">
                        ${viewer.is_online ? '<div style="position: absolute; top: 0.5rem; right: 0.5rem; width: 16px; height: 16px; background: #00b894; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>' : ''}
                    </div>
                    <div style="padding: 1rem;">
                        <div style="font-weight: 600; color: #00b894; margin-bottom: 0.25rem; font-size: 1.08rem;">${safeUsername}</div>
                        <div style="font-size: 1.02rem; color: var(--muted-color); margin-bottom: 0.5rem;">${age} • ${safeLocation}</div>
                        <div style="font-size: 0.9rem; color: var(--muted-color);">
                            <i class="far fa-clock"></i> ${this.formatTime(viewer.viewed_at)}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            container.innerHTML = html;
        },
        
        // Render favorites
        renderFavorites(favorites) {
            const container = document.querySelector('.favorites-grid');
            
            if (!favorites || favorites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 2rem; grid-column: 1/-1;">No favorites yet</p>';
                return;
            }
            
            container.innerHTML = favorites.map(favorite => {
                const defaultImg = (favorite.gender && favorite.gender.toString().toLowerCase() === 'f') ? '/assets/images/default_profile_female.svg' : '/assets/images/default_profile_male.svg';
                return `
                <div class="favorite-card" data-user-id="${favorite.user_id}" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(31,38,135,0.08); transition: transform 0.2s; cursor: pointer; position: relative;">
                    <button class="remove-favorite-btn" onclick="event.stopPropagation(); ActivityManager.removeFavorite(${favorite.user_id})" style="position: absolute; top: 0.5rem; left: 0.5rem; background: rgba(214, 48, 49, 0.9); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" onmouseover="this.style.background='rgba(214, 48, 49, 1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(214, 48, 49, 0.9)'; this.style.transform='scale(1)'">
                        <i class="fas fa-heart-broken" style="font-size: 0.9rem;"></i>
                    </button>
                    <div style="position: relative;">
                        <img src="${favorite.profile_image || defaultImg}" alt="Profile" onerror="this.onerror=null; this.src='${defaultImg}';" style="width: 100%; height: 140px; object-fit: cover;">
                        ${favorite.is_online ? '<div style="position: absolute; top: 0.5rem; right: 0.5rem; width: 16px; height: 16px; background: #00b894; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>' : ''}
                    </div>
                    <div style="padding: 1rem;">
                        <div style="font-weight: 600; color: #00b894; margin-bottom: 0.25rem; font-size: 1.08rem;">${this.escapeHtml(favorite.name)}</div>
                        <div style="font-size: 1.02rem; color: var(--muted-color); margin-bottom: 0.5rem;">${favorite.age} • ${this.escapeHtml(favorite.location)}</div>
                        <div style="font-size: 0.9rem; color: var(--muted-color);">
                            <i class="far fa-clock"></i> ${this.formatTime(favorite.created_at || favorite.favorited_date)}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
        },
        
        // Render messages
        renderMessages(messages) {
            const container = document.querySelector('.messages-list');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 2rem;">No new messages</p>';
                return;
            }
            
            // Get session token for navigation
            const sessionToken = getSessionToken();
            
            container.innerHTML = messages.map(message => {
                const isDeleted = message.is_sender_deleted || message.sender_name === 'Deleted User';
                const displayName = isDeleted ? 'Account Deactivated' : this.escapeHtml(message.sender_name);
                const defaultImg = (message.gender && message.gender.toString().toLowerCase() === 'f') ? '/assets/images/default_profile_female.svg' : '/assets/images/default_profile_male.svg';
                const profileImage = isDeleted ? '/assets/images/account_deactivated.svg' : (message.profile_image || defaultImg);
                const messageText = isDeleted 
                    ? `<span style="filter: blur(3px); opacity: 0.6;">"${this.truncateText(this.escapeHtml(message.message_text), 50)}"</span>`
                    : `"${this.truncateText(this.escapeHtml(message.message_text), 50)}"`;
                
                return `
                <div class="message-card ${isDeleted ? 'message-card-deleted' : ''}" style="display: flex; align-items: center; padding: 1rem; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(31,38,135,0.08); transition: transform 0.2s; ${isDeleted ? 'opacity: 0.7; border-left: 3px solid #ff9800; cursor: pointer;' : ''}" ${isDeleted ? `onclick="window.location.href='/talk?token=${sessionToken}&user=${message.sender_id}'"` : ''}>
                    <img src="${profileImage}" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 1rem; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: ${isDeleted ? '#ff9800' : '#00b894'}; margin-bottom: 0.25rem; font-size: 0.9rem;">${displayName}</div>
                        ${!isDeleted ? `<div style="font-size: 0.9rem; color: var(--muted-color); margin-bottom: 0.25rem;">${message.age} • ${this.escapeHtml(message.location)}</div>` : ''}
                        <div style="font-size: 0.85rem; color: var(--muted-color); margin-bottom: 0.25rem;"><i class="far fa-clock" style="margin-right: 0.25rem;"></i>${this.formatTime(message.sent_at)}</div>
                        <div style="font-size: 0.95rem; color: var(--dark-color);">${messageText}${message.unread_count > 1 ? ', <span style="color: #00b894;">' + message.unread_count + ' new messages</span>' : ''}</div>
                    </div>
                    ${!isDeleted ? `<a href="/talk?token=${sessionToken}&user=${message.sender_id}" class="reply-message-btn" data-user-id="${message.sender_id}" data-real_name="${this.escapeHtml(message.sender_name)}" style="background: var(--primary); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; text-decoration: none; display: inline-block; text-align: center;">Reply</a>` : '<span style="padding: 0.4rem 0.8rem; color: #ff9800; font-size: 0.8rem;">⚠️ Deactivated</span>'}
                </div>
            `;
            }).join('');
        },
        
        // Render likes

        renderWhoLikedMe(users) {
            const container = document.querySelector('.who-liked-me-grid');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 2rem; grid-column: 1 / -1;">No one has liked you yet</p>';
                return;
            }
            
            // No grouping needed - likes table has unique constraint (one like per user pair)
            // Each user in the array is already unique
            container.innerHTML = users.map(user => {
                const defaultImg = (user.gender && user.gender.toString().toLowerCase() === 'f') ? '/assets/images/default_profile_female.svg' : '/assets/images/default_profile_male.svg';
                return `
                <div class="who-liked-me-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(31,38,135,0.08); transition: transform 0.2s; cursor: pointer; position: relative;" data-user-id="${user.user_id}">
                    <div style="position: relative;">
                        <img src="${user.profile_image || defaultImg}" alt="Profile" onerror="this.onerror=null; this.src='${defaultImg}';" style="width: 100%; height: 140px; object-fit: cover;">
                        ${user.is_online ? '<div style="position: absolute; top: 0.5rem; right: 0.5rem; width: 16px; height: 16px; background: #00b894; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>' : ''}
                    </div>
                    <div style="padding: 1rem;">
                        <div style="font-weight: 600; color: #00b894; margin-bottom: 0.25rem; font-size: 1.08rem;">${this.escapeHtml(user.name)}</div>
                        <div style="font-size: 1.02rem; color: var(--muted-color); margin-bottom: 0.5rem;">${user.age} • ${this.escapeHtml(user.location)}</div>
                        <div style="font-size: 0.9rem; color: var(--muted-color);">
                            <i class="far fa-clock"></i> ${this.formatTime(user.liked_at)}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        },

        renderWhoILike(users) {
            const container = document.querySelector('.who-i-like-grid');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 2rem; grid-column: 1 / -1;">You haven\'t liked anyone yet</p>';
                return;
            }
            
            container.innerHTML = users.map(user => {
                const defaultImg = (user.gender && user.gender.toString().toLowerCase() === 'f') ? '/assets/images/default_profile_female.svg' : '/assets/images/default_profile_male.svg';
                return `
                <div class="who-i-like-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(31,38,135,0.08); transition: transform 0.2s; cursor: pointer; position: relative;" data-user-id="${user.user_id}">
                    <button class="unlike-btn" onclick="event.stopPropagation(); ActivityManager.unlikeUser(${user.user_id})" style="position: absolute; top: 0.5rem; left: 0.5rem; background: rgba(243, 156, 18, 0.9); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" onmouseover="this.style.background='rgba(243, 156, 18, 1)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(243, 156, 18, 0.9)'; this.style.transform='scale(1)'" title="Unlike">
                        <i class="fas fa-thumbs-down" style="font-size: 0.9rem;"></i>
                    </button>
                    <div style="position: relative;">
                        <img src="${user.profile_image || defaultImg}" alt="Profile" onerror="this.onerror=null; this.src='${defaultImg}';" style="width: 100%; height: 140px; object-fit: cover;">
                        ${user.is_online ? '<div style="position: absolute; top: 0.5rem; right: 0.5rem; width: 16px; height: 16px; background: #00b894; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>' : ''}
                    </div>
                    <div style="padding: 1rem;">
                        <div style="font-weight: 600; color: #00b894; margin-bottom: 0.25rem; font-size: 1.08rem;">${this.escapeHtml(user.name)}</div>
                        <div style="font-size: 1.02rem; color: var(--muted-color); margin-bottom: 0.5rem;">${user.age} • ${this.escapeHtml(user.location)}</div>
                        <div style="font-size: 0.9rem; color: var(--muted-color);">
                            <i class="far fa-clock"></i> ${this.formatTime(user.liked_at)}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        },
        
        // Update count badges
        updateViewersCount(todayCount, totalCount) {
            const badge = document.querySelector('.viewers-count-badge');
            
            // Hide badge if count is 0, show if 1 or more
            if (todayCount > 0) {
                badge.textContent = `${todayCount} today`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
            
            document.querySelector('.total-viewers-count').textContent = totalCount || 0;
            
            if (totalCount > 3) {
                document.querySelector('.viewers-view-all').style.display = 'block';
            }
            
            if (todayCount > 0) {
                document.querySelector('.views-badge').style.display = 'flex';
            }
        },
        
        updateFavoritesCount(count) {
            document.querySelector('.total-favorites-count').textContent = count || 0;
            
            const viewAllSection = document.querySelector('.favorites-view-all');
            const defaultViewSection = document.querySelector('.favorites-default-view');
            
            if (count > 0) {
                // Show "View All" if we're in default view (showing 6), hide "Default View" toggle
                const favoritesGrid = document.querySelector('.favorites-grid');
                const currentCount = favoritesGrid.querySelectorAll('.favorite-card').length;
                
                if (currentCount < count && currentCount <= 6) {
                    // We're showing default view (6 or less)
                    viewAllSection.style.display = 'inline-block';
                    if (defaultViewSection) {
                        defaultViewSection.style.display = 'none';
                    }
                } else {
                    // We're showing all favorites
                    viewAllSection.style.display = 'none';
                    if (defaultViewSection) {
                        defaultViewSection.style.display = 'inline-block';
                    }
                }
            } else {
                viewAllSection.style.display = 'none';
                if (defaultViewSection) {
                    defaultViewSection.style.display = 'none';
                }
            }
        },
        
        updateMessagesCount(count) {
            const badge = document.querySelector('.messages-count-badge');
            if (count > 0) {
                badge.textContent = `${count} new`;
                badge.style.display = 'inline-block';
            } else {
                badge.textContent = 'No new messages';
                badge.style.display = 'inline-block';
                badge.style.background = 'var(--muted-color)';
            }
        },
        

        updateWhoLikedMeCount(todayCount, totalCount) {
            const badge = document.querySelector('.who-liked-me-count-badge');
            
            // Hide badge if count is 0, show if 1 or more
            if (todayCount > 0) {
                badge.textContent = `${todayCount} today`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
            
            document.querySelector('.total-who-liked-me-count').textContent = totalCount || 0;
            
            if (totalCount > 6) {
                document.querySelector('.who-liked-me-view-all').style.display = 'block';
            }
        },

        updateWhoILikeCount(count) {
            document.querySelector('.total-who-i-like-count').textContent = count || 0;
            
            const viewAllSection = document.querySelector('.who-i-like-view-all');
            const defaultViewSection = document.querySelector('.who-i-like-default-view');
            
            if (count > 0) {
                // Show "View All" if we're in default view (showing 6), hide "Default View" toggle
                const whoILikeGrid = document.querySelector('.who-i-like-grid');
                const currentCount = whoILikeGrid.querySelectorAll('.who-i-like-card').length;
                
                if (currentCount < count && currentCount <= 6) {
                    // We're showing default view (6 or less)
                    viewAllSection.style.display = 'inline-block';
                    if (defaultViewSection) {
                        defaultViewSection.style.display = 'none';
                    }
                } else {
                    // We're showing all
                    viewAllSection.style.display = 'none';
                    if (defaultViewSection) {
                        defaultViewSection.style.display = 'inline-block';
                    }
                }
            } else {
                viewAllSection.style.display = 'none';
                if (defaultViewSection) {
                    defaultViewSection.style.display = 'none';
                }
            }
        },

        updateBlockedUsersCount(count) {
            const badge = document.querySelector('.blocked-users-count-badge');
            badge.textContent = `${count} blocked`;
        },

        renderBlockedUsers(blockedUsers) {
            const container = document.querySelector('.blocked-users-grid');
            
            if (!blockedUsers || blockedUsers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 2rem; grid-column: 1 / -1;">No blocked users</p>';
                return;
            }
            
            container.innerHTML = blockedUsers.map(user => {
                const defaultImg = (user.gender && user.gender.toString().toLowerCase() === 'f') ? '/assets/images/default_profile_female.svg' : '/assets/images/default_profile_male.svg';
                return `
                <div class="blocked-user-card" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(31,38,135,0.08); overflow: hidden; transition: transform 0.2s; position: relative;">
                    <div style="position: relative; padding-top: 100%; background: linear-gradient(135deg, #d63031 0%, #e74c3c 100%);">
                        <img src="${user.profile_image ? `/uploads/profile_images/${user.profile_image}` : defaultImg}" alt="Profile" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: grayscale(60%);">
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(214, 48, 49, 0.9); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                            <i class="fas fa-ban"></i> Blocked
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="font-weight: 600; color: #636e72; margin-bottom: 0.25rem; font-size: 1.08rem;">${this.escapeHtml(user.name)}</div>
                        <div style="font-size: 1.02rem; color: var(--muted-color); margin-bottom: 0.5rem;">${user.age} • ${this.escapeHtml(user.location)}</div>
                        <div style="font-size: 0.85rem; color: var(--muted-color); margin-bottom: 0.75rem;">
                            <i class="far fa-clock"></i> ${this.formatTime(user.blocked_at)}
                            ${user.block_reason ? `<div style="margin-top: 0.25rem; font-size: 0.8rem; color: #636e72;"><i class="fas fa-info-circle"></i> ${this.escapeHtml(user.block_reason)}</div>` : ''}
                        </div>
                        <button class="unblock-user-btn" onclick="ActivityManager.showUnblockConfirm(${user.user_id}, '${this.escapeHtml(user.name)}')" style="width: 100%; background: #00b894; color: white; border: none; padding: 0.5rem; border-radius: 6px; font-size: 1.02rem; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                            <i class="fas fa-unlock"></i> Unblock
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        },
        
        // Setup event listeners
        setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.activity-tab').forEach(tab => {
                tab.addEventListener('click', (e) => this.switchTab(e.currentTarget));
            });
            
            // Modal event listeners are handled by the external modal JS
            // Delegate events for dynamic content
            document.addEventListener('click', (e) => {
                if (e.target.closest('.view-profile-btn')) {
                    const userId = e.target.closest('.view-profile-btn').dataset.userId;
                    this.viewProfile(userId);
                }
                
                if (e.target.closest('.reply-message-btn')) {
                    // Reply button now navigates to talk.html - let the link handle it
                    // No need to prevent default or call openChat
                    return;
                }
                
                if (e.target.closest('.send-message-btn') || e.target.closest('.start-chat-btn')) {
                    const button = e.target.closest('button');
                    const userId = button.dataset.userId;
                    const real_name = button.dataset.real_name || 'User';
                    this.openChat(userId, real_name);
                }
                
                if (e.target.closest('.remove-favorite-btn')) {
                    const userId = e.target.closest('.remove-favorite-btn').dataset.userId;
                    this.removeFavorite(userId);
                }
                
                
                if (e.target.closest('.view-all-viewers-btn')) {
                    this.viewAllViewers();
                }
                
                if (e.target.closest('.view-all-who-liked-me-btn')) {
                    this.viewAllWhoLikedMe();
                }
                
                if (e.target.closest('.view-all-who-i-like-btn')) {
                    this.viewAllWhoILike();
                }
                
                if (e.target.closest('.default-view-who-i-like-btn')) {
                    this.loadWhoILike();
                }
                
                if (e.target.closest('.view-all-favorites-btn')) {
                    this.viewAllFavorites();
                }
                
                if (e.target.closest('.default-view-favorites-btn')) {
                    this.loadFavorites();
                }
                
                if (e.target.closest('.viewer-card')) {
                    const userId = e.target.closest('.viewer-card').dataset.userId;
                    if (userId) {
                        this.viewProfile(userId);
                    }
                }
                
                if (e.target.closest('.who-liked-me-card')) {
                    const userId = e.target.closest('.who-liked-me-card').dataset.userId;
                    if (userId) {
                        this.viewProfile(userId);
                    }
                }
                
                if (e.target.closest('.who-i-like-card')) {
                    // Don't trigger if clicking on action buttons
                    if (e.target.closest('.unlike-btn')) {
                        return;
                    }
                    const userId = e.target.closest('.who-i-like-card').dataset.userId;
                    if (userId) {
                        this.viewProfile(userId);
                    }
                }
                
                if (e.target.closest('.favorite-card')) {
                    const userId = e.target.closest('.favorite-card').dataset.userId;
                    if (userId) {
                        this.viewProfile(userId);
                    }
                }
                
                // Modal action buttons
                if (e.target.closest('.modal-like-btn')) {
                    e.preventDefault();
                    this.likeProfileInModal();
                }
                
                if (e.target.closest('.modal-favourite-btn')) {
                    e.preventDefault();
                    this.favouriteProfileInModal();
                }
                
                if (e.target.closest('.modal-message-btn')) {
                    e.preventDefault();
                    this.messageProfileInModal();
                }
                
                if (e.target.closest('.modal-block-btn')) {
                    e.preventDefault();
                    this.blockProfileInModal();
                }
                
                if (e.target.closest('.modal-report-btn')) {
                    e.preventDefault();
                    this.reportProfileInModal();
                }
            });
        },
        
        // Switch tabs
        switchTab(tabElement) {
            const tab = tabElement.dataset.tab;
            
            // Update active tab
            document.querySelectorAll('.activity-tab').forEach(t => {
                t.classList.remove('active');
                t.style.background = 'transparent';
                t.style.color = 'var(--primary)';
            });
            
            tabElement.classList.add('active');
            tabElement.style.background = 'var(--primary)';
            tabElement.style.color = 'white';
            
            // Show/hide sections
            document.querySelectorAll('.activity-section').forEach(section => {
                section.style.display = 'block';
            });
            
            if (tab === 'messages') {
                // Show only Messages section
                document.querySelector('.viewers-section').style.display = 'none';
                document.querySelector('.favorites-section').style.display = 'none';
                document.querySelector('.who-liked-me-section').style.display = 'none';
                document.querySelector('.who-i-like-section').style.display = 'none';
                document.querySelector('.blocked-users-section').style.display = 'none';
            } else if (tab === 'views') {
                // Show only Who Viewed Me section
                document.querySelector('.favorites-section').style.display = 'none';
                document.querySelector('.messages-section').style.display = 'none';
                document.querySelector('.who-liked-me-section').style.display = 'none';
                document.querySelector('.who-i-like-section').style.display = 'none';
                document.querySelector('.blocked-users-section').style.display = 'none';
            } else if (tab === 'favorites') {
                document.querySelector('.viewers-section').style.display = 'none';
                document.querySelector('.messages-section').style.display = 'none';
                document.querySelector('.who-liked-me-section').style.display = 'none';
                document.querySelector('.who-i-like-section').style.display = 'none';
                document.querySelector('.blocked-users-section').style.display = 'none';
            } else if (tab === 'liked') {
                // Show Who Liked Me and Who I Like sections
                document.querySelector('.viewers-section').style.display = 'none';
                document.querySelector('.favorites-section').style.display = 'none';
                document.querySelector('.messages-section').style.display = 'none';
                document.querySelector('.blocked-users-section').style.display = 'none';
                // Keep likes sections visible
                document.querySelector('.who-liked-me-section').style.display = 'block';
                document.querySelector('.who-i-like-section').style.display = 'block';
            } else if (tab === 'blocked') {
                // Show only Blocked Users section
                document.querySelector('.viewers-section').style.display = 'none';
                document.querySelector('.favorites-section').style.display = 'none';
                document.querySelector('.messages-section').style.display = 'none';
                document.querySelector('.who-liked-me-section').style.display = 'none';
                document.querySelector('.who-i-like-section').style.display = 'none';
            }
        },
        
        // Actions
        viewProfile(userId) {
            // Use external modal JS function
            if (window.openProfileModal) {
                window.openProfileModal(userId);
            } else {
                console.error('openProfileModal not available. Make sure user-profile-modal.js is loaded.');
            }
        },
        
        likeProfileInModal() {
            if (window.ProfileModalActions) {
                window.ProfileModalActions.likeProfileInModal();
            } else {
                console.error('ProfileModalActions not loaded');
            }
        },
        
        favouriteProfileInModal() {
            if (window.ProfileModalActions) {
                window.ProfileModalActions.favouriteProfileInModal();
            } else {
                console.error('ProfileModalActions not loaded');
            }
        },
        
        messageProfileInModal() {
            const currentProfileUserId = window.getCurrentProfileUserId ? window.getCurrentProfileUserId() : null;
            if (!currentProfileUserId) return;
            
            // Get real_name from modal
            const real_nameElement = document.getElementById('modal-profile-real_name');
            const real_name = real_nameElement ? real_nameElement.textContent.trim().split(' ')[0] : 'User';
            
            if (!real_name || real_name === 'Unknown User') {
                this.showToast('Profile data not loaded correctly. Please refresh the page.', 'error');
                return;
            }
            
            // Close modal first
            if (window.closeProfileModal) {
                window.closeProfileModal();
            }
            
            // Open universal message modal with the profile real_name
            if (typeof openUniversalMessageModal === 'function') {
                openUniversalMessageModal(real_name, false, null,
                    // Success callback
                    (data) => {
                        this.showToast('Message sent successfully', 'success');
                    },
                    // Error callback
                    (error) => {
                        // Handle error silently or show toast if needed
                    }
                );
            } else {
                // Fallback to openChat if universal modal not available
                this.openChat(currentProfileUserId, real_name);
            }
        },
        
        async blockProfileInModal() {
            const currentProfileUserId = window.getCurrentProfileUserId ? window.getCurrentProfileUserId() : null;
            if (!currentProfileUserId) return;
            
            if (!this.currentUserId) {
                this.showToast('Please log in to block users', 'error');
                return;
            }
            
            // Check email verification before blocking
            const isVerified = await window.checkEmailVerificationStatus();
            if (!isVerified) {
                window.showVerificationMessage();
                return; // Don't proceed with block action
            }
            
            const real_nameElement = document.getElementById('modal-profile-real_name');
            const real_name = real_nameElement ? real_nameElement.textContent.trim().split(' ')[0] : 'this user';
            
            // Show custom confirmation dialog
            document.getElementById('blockUsername').textContent = real_name;
            document.getElementById('blockConfirmModal').style.display = 'flex';
            
            // Store context for confirmBlock function
            window.pendingBlockUserId = currentProfileUserId;
            window.pendingBlockContext = 'activity';
        },
        
        executeBlock() {
            const currentProfileUserId = window.getCurrentProfileUserId ? window.getCurrentProfileUserId() : null;
            if (!currentProfileUserId) {
                this.showToast('No profile selected', 'error');
                return;
            }
            
            // Send block request
            fetch(`/api/users/${currentProfileUserId}/block`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': this.currentUserId,
                    'Authorization': `Bearer ${getSessionToken()}`
                },
                body: JSON.stringify({
                    reason: 'Blocked from activity page'
                })
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    this.showToast('User blocked successfully', 'success');
                    if (window.closeProfileModal) {
                        window.closeProfileModal();
                    }
                    // Refresh the page to remove blocked user from lists
                    setTimeout(() => location.reload(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to block user');
                }
            }).catch(error => {
                console.error('Error blocking user:', error);
                const errorMessage = error.message && error.message.includes('HTTP error') 
                    ? 'Network error. Please check your connection and try again.' 
                    : 'Failed to block user. Please try again.';
                this.showToast(errorMessage, 'error');
            });
        },
        
        async reportProfileInModal() {
            const currentProfileUserId = window.getCurrentProfileUserId ? window.getCurrentProfileUserId() : null;
            if (!currentProfileUserId) return;
            
            if (!this.currentUserId) {
                this.showToast('Please log in to report users', 'error');
                return;
            }
            
            // Check email verification before reporting
            const isVerified = await window.checkEmailVerificationStatus();
            if (!isVerified) {
                window.showVerificationMessage();
                return; // Don't proceed with report action
            }
            
            // Get real_name from modal
            const real_nameElement = document.getElementById('modal-profile-real_name');
            const real_name = real_nameElement ? real_nameElement.textContent.trim().split(' ')[0] : `User ${currentProfileUserId}`;
            
            // Open report modal
            if (typeof openReportModal === 'function') {
                openReportModal(currentProfileUserId, real_name);
            } else {
                console.error('openReportModal function not found. Make sure user-report-modal is included.');
                this.showToast('Report functionality is not available. Please refresh the page.', 'error');
            }
        },
        
        openChat(userId, real_name) {
            console.log('🔍 openChat called with:', { userId, real_name });
            
            // Navigate to talk page with session token and user ID
            const sessionToken = getSessionToken();
            if (sessionToken) {
                window.location.href = `/talk?token=${sessionToken}&user=${userId}`;
            } else {
                console.error('❌ Session token not available');
                this.showToast('Session expired. Please log in again.', 'error');
            }
        },
        
        async removeFavorite(userId) {
            try {
                const response = await fetch(`/api/favorites/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    this.showToast(data.message || 'Removed from favorites', 'success');
                    // Check if we're in "View All" mode (default view button is visible)
                    const defaultViewSection = document.querySelector('.favorites-default-view');
                    const isViewAllMode = defaultViewSection && defaultViewSection.style.display === 'inline-block';
                    
                    if (isViewAllMode) {
                        // Reload all favorites to preserve "View All" view
                        await this.viewAllFavorites();
                    } else {
                        // Reload default view (6 items)
                    await this.loadFavorites();
                    }
                } else {
                    this.showToast(data.error || 'Failed to remove favorite', 'error');
                }
            } catch (error) {
                console.error('Error removing favorite:', error);
                this.showToast('Failed to remove favorite', 'error');
            }
        },

        async unlikeUser(userId) {
            try {
                const response = await fetch(`/api/likes/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    this.showToast(data.message || 'User unliked', 'success');
                    // Check if we're in "View All" mode (default view button is visible)
                    const defaultViewSection = document.querySelector('.who-i-like-default-view');
                    const isViewAllMode = defaultViewSection && defaultViewSection.style.display === 'inline-block';
                    
                    if (isViewAllMode) {
                        // Reload all who I like to preserve "View All" view
                        await this.viewAllWhoILike();
                    } else {
                        // Reload default view (6 items)
                    await this.loadWhoILike();
                    }
                } else {
                    this.showToast(data.error || 'Failed to unlike user', 'error');
                }
            } catch (error) {
                console.error('Error unliking user:', error);
                this.showToast('Failed to unlike user', 'error');
            }
        },
        
        async showUnblockConfirm(userId, real_name) {
            // Check email verification before unblocking
            const isVerified = await window.checkEmailVerificationStatus();
            if (!isVerified) {
                window.showVerificationMessage();
                return; // Don't proceed with unblock action
            }
            
            this.pendingUnblockUserId = userId;
            document.getElementById('unblockUsername').textContent = real_name;
            document.getElementById('unblockConfirmModal').style.display = 'flex';
        },
        
        async unblockUser(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/block`, {
                    method: 'DELETE',
                    headers: {
                        'X-User-ID': this.currentUserId,
                        'Authorization': `Bearer ${getSessionToken()}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    const restoreInfo = data.restored || {};
                    let message = 'User unblocked successfully';
                    if (restoreInfo.favorites || restoreInfo.likes) {
                        message += '. Previous favorites/likes have been restored.';
                    }
                    this.showToast(message, 'success');
                    
                    // Refresh all relevant sections after unblock
                    await Promise.all([
                        this.loadBlockedUsers(),
                        this.loadViewers(), // Refresh "Who Viewed Me" to show unblocked user
                        this.loadWhoLikedMe(), // Refresh "Who Liked Me" in case they liked before blocking
                        this.loadFavorites() // Refresh favorites if they were restored
                    ]);
                    
                    // Trigger conversation list refresh in talk.html if it's open
                    // This ensures the unblocked user reappears in the chat partners list
                    if (window.loadConversations && typeof window.loadConversations === 'function') {
                        // talk.html is open, refresh conversations
                        window.loadConversations();
                    } else {
                        // Use custom event to notify talk.html if it's in another tab/window
                        window.dispatchEvent(new CustomEvent('userUnblocked', { 
                            detail: { unblockedUserId: userId } 
                        }));
                    }
                } else {
                    // Handle rate limiting or other errors
                    if (data.code === 'RATE_LIMIT_EXCEEDED') {
                        this.showToast(data.error || 'Too many unblock actions. Please wait before trying again.', 'warning');
                    } else {
                        this.showToast(data.error || 'Failed to unblock user', 'error');
                    }
                }
            } catch (error) {
                console.error('Error unblocking user:', error);
                this.showToast('Failed to unblock user', 'error');
            }
        },
        
        async likeUser(userId) {
            try {
                const response = await fetch('/api/likes', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-ID': this.currentUserId
                    },
                    body: JSON.stringify({ userId })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Don't reload likes data
                    console.log('Like sent successfully');
                }
            } catch (error) {
                console.error('Error liking user:', error);
                alert('Failed to like user');
            }
        },
        
        toggleSection(sectionName) {
            const section = document.querySelector(`.${sectionName}-section`);
            const list = section.querySelector(`.${sectionName}-list`);
            const toggleIcon = section.querySelector(`.${sectionName}-toggle-icon`);
            
            if (list.style.display === 'none') {
                list.style.display = 'grid';
                toggleIcon.textContent = '−';
            } else {
                list.style.display = 'none';
                toggleIcon.textContent = '+';
            }
        },

        async viewAllViewers() {
            // Load and display all viewers on the current page
            try {
                const response = await fetch('/api/activity/viewers?limit=100', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderViewers(data.viewers);
                    // Hide the "View All" button since we're now showing all
                    const viewAllSection = document.querySelector('.viewers-view-all');
                    if (viewAllSection) {
                        viewAllSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('❌ Error loading all viewers:', error);
            }
        },
        
        async viewAllWhoLikedMe() {
            // Load and display all who liked me on the current page
            try {
                const response = await fetch('/api/activity/who-liked-me?limit=100', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderWhoLikedMe(data.users);
                    // Hide the "View All" button since we're now showing all
                    const viewAllSection = document.querySelector('.who-liked-me-view-all');
                    if (viewAllSection) {
                        viewAllSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('❌ Error loading all who liked me:', error);
            }
        },
        
        async viewAllWhoILike() {
            // Load and display all who I like on the current page
            try {
                const response = await fetch('/api/activity/who-i-like?limit=100', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderWhoILike(data.users);
                    // Hide "View All" button and show "Default View" toggle
                    const viewAllSection = document.querySelector('.who-i-like-view-all');
                    const defaultViewSection = document.querySelector('.who-i-like-default-view');
                    if (viewAllSection) {
                        viewAllSection.style.display = 'none';
                    }
                    if (defaultViewSection) {
                        defaultViewSection.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('❌ Error loading all who I like:', error);
            }
        },
        
        async viewAllFavorites() {
            // Load and display all favorites on the current page
            try {
                const response = await fetch('/api/activity/favorites?limit=100', {
                    headers: {
                        'X-User-ID': this.currentUserId
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    this.renderFavorites(data.favorites);
                    // Hide "View All" button and show "Default View" toggle
                    const viewAllSection = document.querySelector('.favorites-view-all');
                    const defaultViewSection = document.querySelector('.favorites-default-view');
                    if (viewAllSection) {
                        viewAllSection.style.display = 'none';
                    }
                    if (defaultViewSection) {
                        defaultViewSection.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('❌ Error loading all favorites:', error);
            }
        },
        
        // Utility functions
        escapeHtml(text) {
            if (text === null || text === undefined || text === '') {
                return 'Unknown User';
            }
            // Convert to string if not already
            const textStr = String(text);
            const div = document.createElement('div');
            div.textContent = textStr;
            return div.innerHTML;
        },
        
        truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        },
        
        formatTime(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // seconds
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) {
                const minutes = Math.floor(diff / 60);
                return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            }
            if (diff < 86400) {
                const hours = Math.floor(diff / 3600);
                return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            }
            if (diff < 604800) {
                const days = Math.floor(diff / 86400);
                return `${days} day${days !== 1 ? 's' : ''} ago`;
            }
            if (diff < 2592000) {
                const weeks = Math.floor(diff / 604800);
                return `${weeks} week${weeks !== 1 ? 's' : ''} ago`;
            }
            
            // For older dates, show formatted date and time
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
                hour: 'numeric',
                minute: '2-digit'
            });
        },
        
        showError(selector, message) {
            const container = document.querySelector(selector);
            if (container) {
                container.innerHTML = `<p style="text-align: center; color: var(--danger-color); padding: 2rem;">${message}</p>`;
            }
        },
        
        showToast(message, type = 'info', actionText = null, actionCallback = null) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#00b894' : type === 'error' ? '#e74c3c' : '#667eea'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            `;
            
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                ${actionText ? `<button onclick="this.parentElement.remove(); ${actionCallback ? actionCallback() : ''}" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">${actionText}</button>` : ''}
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
    };
    
    // Expose global functions for inline handlers
    // Note: closeProfileModal and openProfileModal are now provided by external modal JS
    window.viewProfile = (userId) => ActivityManager.viewProfile(userId);
    window.ActivityManager = ActivityManager;
    
    // Override getCurrentUserId for modal if needed
    if (window.UserProfileModal) {
        window.UserProfileModal.setGetCurrentUserId(() => ActivityManager.currentUserId);
        window.UserProfileModal.setGetSessionToken(getSessionToken);
    }
    
    // Load ProfileModalActions module after ActivityManager is initialized
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadProfileModalActions);
    } else {
        loadProfileModalActions();
    }
    
    // Global functions for block confirmation dialog
    window.closeBlockConfirm = function() {
        document.getElementById('blockConfirmModal').style.display = 'none';
        window.pendingBlockUserId = null;
        window.pendingBlockContext = null;
    };
    
    window.confirmBlock = function() {
        if (window.pendingBlockUserId && window.pendingBlockContext === 'activity') {
            ActivityManager.executeBlock();
        }
        closeBlockConfirm();
    };
    
    // Initialize when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => ActivityManager.init());
    } else {
        ActivityManager.init();
    }
})();
</script>

<style>
    /* Animation for toasts */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>