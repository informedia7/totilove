<!-- Search Results Page Content -->
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #00b894;
            --dark-color: #2d3436;
            --light-color: #f5f6fa;
            --text-color: #333;
            --muted-color: #636e72;
            --white: #ffffff;
            --danger-color: #d63031;
            --success-color: #00b894;
            --border-radius: 10px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .search-wrapper {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 80px);
            padding: 2rem;
        }

        .search-container {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem;
            min-height: 600px;
        }

        .search-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--light-color);
        }

        .search-header h1 {
            color: var(--dark-color);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .search-header p {
            color: var(--muted-color);
            font-size: 1.1rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--light-color);
            border-radius: var(--border-radius);
        }

        .results-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-controls label {
            color: var(--muted-color);
            font-weight: 500;
        }

        /* Online status pulse animation */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 184, 148, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 184, 148, 0);
            }
        }

        .online-dot-results {
            animation: pulse 2s infinite;
        }

        .sort-controls select {
            padding: 0.5rem;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            background: var(--white);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            justify-content: center;
            max-width: 1100px;
            margin: 0 auto 2rem;
        }

        .online-user-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            min-height: 400px;
            position: relative;
            display: flex;
            flex-direction: column;
            max-width: 300px;
            margin: 0 auto;
            padding: 0 !important;
        }

        .online-user-card:hover {
            transform: translateY(-5px);
        }

        .user-avatar {
            width: 100% !important;
            height: 250px !important;
            object-fit: cover !important;
            cursor: pointer;
            background: #f0f0f0;
            display: block !important;
            transition: opacity 0.3s ease;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            border-radius: 15px 15px 0 0 !important;
            max-width: 100%;
            max-height: 250px;
            border: none;
            outline: none;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }

        .user-info {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: space-between !important;
            text-align: center !important;
            min-height: 210px !important;
        }

        .user-info h4 {
            color: #333;
            margin-bottom: 5px !important;
            margin-top: 0 !important;
            padding: 0 !important;
            line-height: 1.1 !important;
            text-align: center !important;
            font-size: 18px;
            font-weight: 600;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: none;
            -webkit-background-clip: initial;
            -webkit-text-fill-color: initial;
            background-clip: initial;
            text-fill-color: initial;
            text-shadow: none;
            letter-spacing: normal;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
        }

        .gender-icon {
            font-size: 0.8rem;
            margin-left: 0.2rem;
        }

        .gender-icon.male {
            color: #3498db;
        }

        .gender-icon.female {
            color: #e91e63;
        }

        .user-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 6px !important;
            margin-top: 0 !important;
            padding: 0 !important;
            line-height: 1.1 !important;
            text-align: center !important;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .user-location i {
            color: var(--primary-color);
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-action {
            display: inline-block;
            font-size: 1.25rem;
            color: var(--primary-color);
            margin: 0 0.4rem;
            cursor: pointer;
            transition: color 0.18s, transform 0.18s;
            vertical-align: middle;
        }

        .icon-action:hover {
            color: var(--danger-color);
            transform: scale(1.18);
        }

        .icon-like i {
            color: #e74c3c;
        }

        .icon-message i {
            color: var(--primary-color);
        }

        .online-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 15px;
            height: 15px;
            background: var(--success-color);
            border: 3px solid var(--white);
            border-radius: 50%;
            animation: online-blink 3s infinite;
            z-index: 2;
        }

        .online-indicator-inline {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border: 2px solid var(--white);
            border-radius: 50%;
            animation: online-blink 3s infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
            box-shadow: 0 0 0 1px #00b894;
        }

        @keyframes online-blink {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 2px #fff, 0 0 4px 1px #00b894;
                opacity: 1;
            }
            50% {
                transform: scale(1.07);
                box-shadow: 0 0 0 2.7px #fff, 0 0 7px 1.7px #00b894;
                opacity: 0.90;
            }
        }

        .no-results {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--muted-color);
        }

        .no-results i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .no-results h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 3rem;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #pageNumbers {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .pagination button {
            padding: 0.8rem 1.2rem;
            border: 1px solid #e9ecef;
            background: var(--white);
            color: var(--dark-color);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 0.25rem;
        }

        .pagination button:hover {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .pagination button.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.3);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .pagination span {
            color: var(--muted-color);
            font-weight: 500;
        }

        .page-btn {
            padding: 0.8rem 1.2rem;
            border: 1px solid #e9ecef;
            background: var(--white);
            color: var(--dark-color);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 0.25rem;
        }

        .page-btn:hover {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .page-btn.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.3);
        }

        .page-ellipsis {
            padding: 0.5rem;
            color: var(--muted-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-to-search {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .back-to-search:hover {
            color: var(--secondary-color);
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .search-container {
                margin: 1rem;
                padding: 2rem;
            }

            .results-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .search-header h1 {
                font-size: 2rem;
            }
        }
        .online-dot-results {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 18px;
            height: 18px;
            background: #00b894;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 2px #fff;
            z-index: 2;
            animation: online-blink 3s infinite;
        }
        .user-about {
            font-size:0.98rem;
            color:#636e72;
            margin-bottom:0.18rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 4.5em;
        }
    </style>
</head>
<body>
    <div class="search-wrapper">
        <div class="search-container">
            <a href="/search" class="back-to-search">
                <i class="fas fa-arrow-left"></i>
                Back to Search
            </a>

            <div class="search-header">
                <h1>Search Results</h1>
                <p>Find your perfect match from our community</p>
            </div>

            <!-- Loading State -->
            <div id="loadingContainer" class="loading-container">
                <div class="spinner"></div>
                <p>Searching for your perfect matches...</p>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <div class="results-header">
                    <div class="results-count">
                        <span id="resultsCount">0 matches found</span>
                    </div>
                    <div class="sort-controls">
                        <label for="sortBy">Sort by:</label>
                        <select id="sortBy" name="sortBy">
                            <option value="relevance">Relevance</option>
                            <option value="distance">Distance</option>
                            <option value="age">Age</option>
                            <option value="activity">Last Active</option>
                        </select>
                    </div>
                </div>

                <div class="results-grid" id="resultsGrid">
                    <!-- Results will be populated here -->
                </div>

                <!-- Pagination -->
                <div class="pagination" id="paginationContainer" style="display: none;">
                    <button onclick="changePage(-1)" id="prevPage">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <div id="pageNumbers"></div>
                    <button onclick="changePage(1)" id="nextPage">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Ensure user authentication data is available
        if (typeof window.currentUser === 'undefined') {
            // Try to get user data from common sources
            window.currentUser = {
                id: parseInt(document.body.getAttribute('data-user-id')) || null,
                username: document.body.getAttribute('data-username') || '',
                email: document.body.getAttribute('data-user-email') || '',
                age: parseInt(document.body.getAttribute('data-user-age')) || null,
                gender: document.body.getAttribute('data-user-gender') || '',
                location: document.body.getAttribute('data-user-location') || '',
                memberSince: document.body.getAttribute('data-member-since') || '',
                lastActive: document.body.getAttribute('data-last-active') || ''
            };
            
            // Set authentication status
            window.isAuthenticated = window.currentUser.id && window.currentUser.id !== 'null' && window.currentUser.id !== '';
            console.log('üîç Results page: User data initialized:', window.currentUser);
        }
        
        // Include Online Activity Tracker
        if (typeof window.OnlineActivityTracker === 'undefined') {
            const trackerScript = document.createElement('script');
            trackerScript.src = '/assets/online-tracker.js';
            trackerScript.onload = function() {
                console.log('‚úÖ OnlineActivityTracker loaded for results page');
                // Initialize tracking after script loads
                setTimeout(() => {
                    if (window.onlineTracker && window.currentUser?.id) {
                        console.log('üîç Results page: Ensuring online tracking is active');
                        if (!window.onlineTracker.getStatus().isRunning) {
                            window.onlineTracker.start();
                        }
                    }
                }, 100);
            };
            trackerScript.onerror = function() {
                console.warn('‚ö†Ô∏è Failed to load OnlineActivityTracker');
            };
            document.head.appendChild(trackerScript);
        } else {
            // Tracker already loaded, just ensure it's running
            setTimeout(() => {
                if (window.onlineTracker && window.currentUser?.id) {
                    console.log('üîç Results page: Ensuring online tracking is active');
                    if (!window.onlineTracker.getStatus().isRunning) {
                        window.onlineTracker.start();
                    }
                }
            }, 100);
        }
        
        // Include OnlineCheck module for standalone online status checking
        if (typeof window.OnlineCheck === 'undefined') {
            // Load OnlineCheck module if not already loaded
            const script = document.createElement('script');
            script.src = '/assets/js/online-check.js';
            script.onload = function() {
                console.log('‚úÖ OnlineCheck module loaded for results page');
            };
            script.onerror = function() {
                console.warn('‚ö†Ô∏è Failed to load OnlineCheck module, using fallback methods');
            };
            document.head.appendChild(script);
        }

        // Include user-status.js for text-based online status (like user_profile page)
        if (typeof window.UserStatus === 'undefined') {
            const userStatusScript = document.createElement('script');
            userStatusScript.src = '/assets/js/user-status.js';
            userStatusScript.onload = function() {
                console.log('‚úÖ UserStatus module loaded for results page');
            };
            userStatusScript.onerror = function() {
                console.warn('‚ö†Ô∏è Failed to load UserStatus module');
            };
            document.head.appendChild(userStatusScript);
        }

        let currentPage = 1;
        let searchResults = [];
        // No fixed results per page - show all results

        // Get search parameters from URL
        function getSearchParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            
            // Convert URL params back to filter object
            for (const [key, value] of urlParams.entries()) {
                if (value !== '' && value !== 'undefined') {
                    params[key] = value;
                }
            }
            
            return params;
        }

        // Get session token from URL
        function getSessionToken() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token') || '';
        }

        // Update back to search links with session token
        function updateBackToSearchLinks() {
            const sessionToken = getSessionToken();
            const backLinks = document.querySelectorAll('a[href="/search"]');
            
            backLinks.forEach(link => {
                link.href = `/search?token=${sessionToken}`;
            });
        }

        // Initialize results page
        document.addEventListener('DOMContentLoaded', async function() {
            const searchParams = getSearchParams();
            console.log('Search parameters:', searchParams);
            
            // Ensure currentUser is in URL for WebSocket authentication
            const urlParams = new URLSearchParams(window.location.search);
            const currentUser = urlParams.get('currentUser');
            if (!currentUser) {
                // Add currentUser to URL if missing
                const currentUserId = getCurrentUserId();
                urlParams.set('currentUser', currentUserId);
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState({}, '', newUrl);
                console.log('‚úÖ Added currentUser to URL:', currentUserId);
            }
            
            // Update back to search links with session token
            updateBackToSearchLinks();
            
            // WAIT for WebSocket to be ready BEFORE performing search
            console.log('‚è≥ Waiting for WebSocket initialization before search...');
            try {
                await waitForWebSocketInitialization();
                console.log('‚úÖ WebSocket ready, now performing search...');
                
                // Perform search AFTER WebSocket is ready
                performSearch(searchParams);
                
                // Register status elements immediately after search
                setTimeout(() => {
                    registerStatusElements();
                }, 100);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è WebSocket initialization failed, performing search anyway...');
                performSearch(searchParams);
            }
            
            // Set up periodic status refresh as fallback
            setupPeriodicStatusRefresh();
        });

        // Set up periodic status refresh for online indicators
        function setupPeriodicStatusRefresh() {
            // Refresh status every 30 seconds as fallback
            setInterval(() => {
                if (searchResults.length > 0) {
                    console.log('üîÑ Periodic status refresh for results page');
                    updateStatusElementsManually();
                }
            }, 30000); // 30 seconds
        }

        // Function to wait for WebSocket initialization
        function waitForWebSocketInitialization() {
            return new Promise((resolve, reject) => {
                const maxWaitTime = 5000; // 5 seconds
                const checkInterval = 100; // Check every 100ms
                let elapsed = 0;
                
                const checkWebSocket = () => {
                    // Check if instantStatusManager is available and initialized
                    if (window.instantStatusManager && window.instantStatusManager.isInitialized) {
                        console.log('‚úÖ WebSocket manager is ready');
                        resolve();
                        return;
                    }
                    
                    // Check if OnlineCheck module is available
                    if (window.OnlineCheck) {
                        console.log('‚úÖ OnlineCheck module is ready');
                        resolve();
                        return;
                    }
                    
                    // Check if UserStatus module is available
                    if (window.UserStatus) {
                        console.log('‚úÖ UserStatus module is ready');
                        resolve();
                        return;
                    }
                    
                    // Check if socket.io is connected
                    if (window.io && window.socket && window.socket.connected) {
                        console.log('‚úÖ Socket.IO is connected');
                        resolve();
                        return;
                    }
                    
                    elapsed += checkInterval;
                    if (elapsed >= maxWaitTime) {
                        console.warn('‚ö†Ô∏è WebSocket initialization timeout');
                        reject(new Error('WebSocket initialization timeout'));
                        return;
                    }
                    
                    setTimeout(checkWebSocket, checkInterval);
                };
                
                checkWebSocket();
            });
        }

        async function performSearch(params) {
            try {
                // Show loading state immediately
                document.getElementById('loadingContainer').style.display = 'flex';
                document.getElementById('resultsSection').style.display = 'none';
                
                        // Get current user ID from session manager or localStorage
        let userId = null;
        
        // Try session manager first (preferred method)
        if (window.sessionManager && window.sessionManager.getCurrentUser) {
            const sessionUser = window.sessionManager.getCurrentUser();
            if (sessionUser && sessionUser.id) {
                userId = sessionUser.id;
            }
        }
        
        // Fallback to localStorage (legacy support)
        if (!userId) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('totilove_current_user') || '{}');
                userId = currentUser.id;
            } catch (e) {
                console.warn('Failed to parse current user from localStorage:', e);
            }
        }
                
                // Final fallback to test user
                if (!userId) {
                    userId = 2;
                }
                
                // If no user ID is available, try to get from URL parameters
                if (!userId || userId === 2) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlUserId = urlParams.get('currentUser');
                    if (urlUserId) {
                        userId = parseInt(urlUserId);
                    }
                }
                
                // Build search parameters
                const searchParams = new URLSearchParams();
                searchParams.append('userId', userId);
                
                // Basic filters
                if (params.ageMin) searchParams.append('ageMin', params.ageMin);
                if (params.ageMax) searchParams.append('ageMax', params.ageMax);
                if (params.gender) searchParams.append('gender', params.gender);
                if (params.location) searchParams.append('location', params.location);
                if (params.distance) searchParams.append('distance', params.distance);
                
                // Online status filters
                if (params.onlineNow) searchParams.append('onlineNow', params.onlineNow);
                if (params.recentlyActive) searchParams.append('recentlyActive', params.recentlyActive);
                if (params.onlineStatus) searchParams.append('onlineStatus', params.onlineStatus);
                
                // Photo and verification filters
                if (params.withImages) searchParams.append('withImages', params.withImages);
                if (params.verified) searchParams.append('verified', params.verified);
                
                // Country preference filter
                if (params.usePreferredCountries !== undefined) searchParams.append('usePreferredCountries', params.usePreferredCountries);
                

                
                // Lifestyle filters
                if (params.education) searchParams.append('education', params.education);
                if (params.occupation) searchParams.append('occupation', params.occupation);
                if (params.income) searchParams.append('income', params.income);
                if (params.smoking) searchParams.append('smoking', params.smoking);
                if (params.drinking) searchParams.append('drinking', params.drinking);
                if (params.children) searchParams.append('children', params.children);
                
                // Appearance filters
                if (params.heightMin) searchParams.append('heightMin', params.heightMin);
                if (params.heightMax) searchParams.append('heightMax', params.heightMax);
                if (params.bodyType) searchParams.append('bodyType', params.bodyType);
                if (params.ethnicity) searchParams.append('ethnicity', params.ethnicity);
                
                // Interests
                if (params.interests) searchParams.append('interests', params.interests);
                
                // Sorting
                if (params.sortBy) searchParams.append('sortBy', params.sortBy);
                
                searchParams.append('page', '1');
                // No default limit - let the backend return all matching results
                
                console.log('üîç Fetching search results from API...');
                
                // Call the search API with timeout for better UX
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`/api/search?${searchParams.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Search API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    searchResults = data.results;
                    
                    // Hide loading, show results
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    // Display results
                    displayResults(data.results);
                    
                    // Show pagination if needed (only if there are many results)
                    if (data.results.length > 20) {
                        showPagination(data.results.length);
                    }
                    
                    // Log performance metrics
                    const performance = data.performance || {};
                    console.log(`‚úÖ Search completed: ${data.results.length} results found`);
                    if (performance.queryTime) {
                        console.log(`‚ö° Query time: ${performance.queryTime}ms`);
                        console.log(`üíæ Cached: ${performance.cached ? 'Yes' : 'No'}`);
                    }
                } else {
                    throw new Error(data.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('‚ùå Search error:', error);
                
                // Show error message
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                
                const grid = document.getElementById('resultsGrid');
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: var(--muted-color); padding: 4rem 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 1rem; color: var(--danger-color);"></i>
                        <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--dark-color);">Search Error</h3>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function generateMockResults(params) {
            const mockProfiles = [
                { id: 1, name: 'Sarah Johnson', age: 28, location: 'New York, USA', interests: ['Photography', 'Travel', 'Yoga'], online: true, about: 'Adventurous spirit who loves exploring new places and meeting new people.' },
                { id: 2, name: 'Michael Chen', age: 32, location: 'Los Angeles, USA', interests: ['Music', 'Cooking', 'Hiking'], online: false, about: 'Music lover and foodie. Always up for a hike or a jam session.' },
                { id: 3, name: 'Emma Wilson', age: 26, location: 'Chicago, USA', interests: ['Art', 'Reading', 'Dancing'], online: true, about: 'Creative soul with a passion for art and literature.' },
                { id: 4, name: 'David Miller', age: 30, location: 'Miami, USA', interests: ['Sports', 'Gaming', 'Movies'], online: false, about: 'Sports enthusiast and movie buff. Let‚Äôs play or watch together!' },
                { id: 5, name: 'Lisa Garcia', age: 29, location: 'Seattle, USA', interests: ['Nature', 'Fitness', 'Photography'], online: true, about: 'Nature lover who enjoys hiking and capturing moments.' },
                { id: 6, name: 'James Brown', age: 27, location: 'Boston, USA', interests: ['Technology', 'Music', 'Travel'], online: false, about: 'Tech geek who loves music and discovering new places.' },
                { id: 7, name: 'Ashley Davis', age: 25, location: 'San Francisco, USA', interests: ['Food', 'Art', 'Yoga'], online: true, about: 'Foodie and art fan, always seeking balance and new tastes.' },
                { id: 8, name: 'Ryan Martinez', age: 31, location: 'Austin, USA', interests: ['Cycling', 'Music', 'Travel'], online: false, about: 'Cyclist and traveler, always ready for a new adventure.' },
                { id: 9, name: 'Jennifer Lee', age: 29, location: 'Portland, USA', interests: ['Hiking', 'Photography', 'Coffee'], online: true, about: 'Hiker and coffee lover, passionate about photography.' },
                { id: 10, name: 'Alex Thompson', age: 33, location: 'Denver, USA', interests: ['Skiing', 'Cooking', 'Books'], online: false, about: 'Skiing in winter, cooking and reading all year round.' },
                { id: 11, name: 'Megan White', age: 24, location: 'Nashville, USA', interests: ['Music', 'Dancing', 'Travel'], online: true, about: 'Dancer and music fan, always planning my next trip.' },
                { id: 12, name: 'Kevin Rodriguez', age: 28, location: 'Phoenix, USA', interests: ['Fitness', 'Movies', 'Gaming'], online: false, about: 'Fitness-focused and gamer, love a good movie night.' }
            ];

            // Filter results based on search parameters
            let filtered = mockProfiles.filter(profile => {
                if (params.ageMin && profile.age < parseInt(params.ageMin)) return false;
                if (params.ageMax && profile.age > parseInt(params.ageMax)) return false;
                if (params.gender && params.gender !== 'any') {
                    // Simulate gender filtering (in real app, this would be in the data)
                    const isMatchingGender = Math.random() > 0.3; // 70% chance of matching
                    if (!isMatchingGender) return false;
                }
                if (params.location && !profile.location.toLowerCase().includes(params.location.toLowerCase())) return false;
                if (params.onlineStatus === 'online' && !profile.online) return false;
                if (params.onlineNow === 'true' && !profile.online) return false;
                return true;
            });

            // Sort results
            if (params.sortBy === 'age') {
                filtered.sort((a, b) => a.age - b.age);
            } else if (params.sortBy === 'distance') {
                // Simulate distance sorting
                filtered.sort(() => Math.random() - 0.5);
            }

            return filtered;
        }

        function displayResults(results) {
            const grid = document.getElementById('resultsGrid');
            const countEl = document.getElementById('resultsCount');
            
            countEl.textContent = `${results.length} matches found`;

            if (results.length === 0) {
                const sessionToken = getSessionToken();
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: var(--muted-color); padding: 4rem 2rem;">
                        <i class="fas fa-search" style="font-size: 4rem; margin-bottom: 1rem; color: var(--primary-color);"></i>
                        <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--dark-color);">No matches found</h3>
                        <p>Try adjusting your search criteria to find more people.</p>
                        <a href="/search?token=${sessionToken}" style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--primary-color); text-decoration: none; font-weight: 500; margin-top: 1rem;">
                            <i class="fas fa-arrow-left"></i>
                            Back to Search
                        </a>
                    </div>
                `;
                return;
            }

            // Implement proper pagination
            const resultsPerPage = 20;
            const totalPages = Math.ceil(results.length / resultsPerPage);
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const currentPageResults = results.slice(startIndex, endIndex);

            // Display only current page results
            grid.innerHTML = currentPageResults.map(profile => {
                const profileImage = profile.profile_image
                    ? (profile.profile_image.startsWith('/uploads/profile_images/') 
                        ? profile.profile_image 
                        : `/uploads/profile_images/${profile.profile_image}`)
                    : '/assets/images/default_profile.svg';
                
                // Map interests to Font Awesome icons
                const interestIconMap = {
                    'travel': 'fa-plane',
                    'music': 'fa-music',
                    'yoga': 'fa-child',
                    'photography': 'fa-camera',
                    'art': 'fa-palette',
                    'reading': 'fa-book',
                    'dancing': 'fa-music',
                    'sports': 'fa-futbol',
                    'gaming': 'fa-gamepad',
                    'movies': 'fa-film',
                    'nature': 'fa-leaf',
                    'fitness': 'fa-dumbbell',
                    'cooking': 'fa-utensils',
                    'hiking': 'fa-hiking',
                    'technology': 'fa-laptop',
                    'cycling': 'fa-bicycle',
                    'skiing': 'fa-skiing',
                    'coffee': 'fa-coffee',
                    'books': 'fa-book',
                    'food': 'fa-hamburger',
                };
                
                let interestsHtml = '';
                if (profile.interests && Array.isArray(profile.interests) && profile.interests.length > 0) {
                    interestsHtml = `<div class="user-interests" style="margin-bottom:0.18rem;display:flex;gap:0.7rem;">` +
                        profile.interests.slice(0,3).map(interest => {
                            // Use the icon from the database if available, otherwise map from name
                            const icon = interest.icon || interestIconMap[interest.name.toLowerCase()] || 'fa-star';
                            return `<span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.2rem 0.5rem;background:#f5f6fa;border-radius:8px;font-size:0.8rem;color:#636e72;"><i class="fas ${icon}" style="font-size:0.7rem;"></i>${interest.name}</span>`;
                        }).join('') + `</div>`;
                }
                
                const aboutHtml = profile.about ? `<p class="user-about">${profile.about}</p>` : '';
                
                // Add country emoji if available
                const locationDisplay = profile.country_emoji 
                    ? `${profile.location} ${profile.country_emoji}`
                    : profile.location;
                
                return `
                <div class="online-user-card" onclick="viewProfile(${profile.id})" style="position:relative;">
                    <div style="position:relative;">
                        <img src="${profileImage}"
                             class="user-avatar"
                             onerror="this.src='/assets/images/default_profile.svg'"
                             loading="lazy">
                        <div class="online-dot-results" data-user-id="${profile.id}" style="display:${profile.is_online ? 'block' : 'none'};position:absolute;top:5px;right:5px;width:12px;height:12px;background:#00b894;border-radius:50%;border:2px solid white;box-shadow:0 0 0 2px rgba(0,184,148,0.3);animation:pulse 2s infinite;"></div>
                    </div>
                    <div class="user-info">
                        <h4>${profile.name || profile.username || `User${profile.id}`} <i class="fas ${profile.gender === 'M' ? 'fa-mars' : 'fa-venus'} gender-icon ${profile.gender === 'M' ? 'male' : 'female'}"></i> <button class="age-badge" style="margin-left:7px;padding:1px 8px;font-size:0.85rem;font-weight:500;border:1px solid #e0e0e0;border-radius:10px;background:#f5f6fa;color:#636e72;box-shadow:none;cursor:default;">${profile.age}</button></h4>
                        <p class="user-location">
                            <i class="fas fa-map-marker-alt"></i> ${locationDisplay}
                        </p>
                        <!-- Text-based online status (like user_profile page) -->
                        <div class="user-status-text" id="status-${profile.id}" data-user-id="${profile.id}" style="font-size:0.9rem;color:#00b894;margin:0.5rem 0;font-weight:500;">
                            ${profile.is_online ? '<span style="color: #27ae60; font-size:1.2em; vertical-align:middle;">‚óè</span> Online' : '<span style="color: #aaa; font-size:1.2em; vertical-align:middle;">‚óè</span> Offline'}
                        </div>
                        ${interestsHtml}
                        ${aboutHtml}
                        <div class="user-actions">
                            <span class="icon-action icon-message" title="Message" onclick="event.stopPropagation(); messageProfile('${(profile.username || profile.name || `User${profile.id}`).replace(/'/g, "\\'")}')">
                                <i class="fas fa-envelope"></i>
                            </span>
                            <span class="icon-action icon-like" title="Like" onclick="event.stopPropagation(); likeProfile(${profile.id})">
                                <i class="fas fa-heart"></i>
                            </span>
                            <span class="icon-action icon-favourite" title="Add to Favourite" onclick="event.stopPropagation(); addToFavourite(${profile.id})">
                                <i class="fas fa-star"></i>
                            </span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // Show pagination if there are multiple pages
            console.log(`üîç Display Results: ${results.length} total results, ${totalPages} pages, current page ${currentPage}`);
            if (totalPages > 1) {
                showPagination(results.length);
            } else {
                document.getElementById('paginationContainer').style.display = 'none';
                console.log('üîç Hiding pagination (only 1 page)');
            }

            // Register status elements for instant updates
            registerStatusElements();
        }

        // Function to register status elements with retry mechanism
        function registerStatusElements() {
            const maxRetries = 10;
            let retryCount = 0;
            
            function attemptRegistration() {
                if (window.instantStatusManager && window.instantStatusManager.isInitialized) {
                    // Register visual dot elements
                    const statusElements = document.querySelectorAll('.online-dot-results[data-user-id]');
                    statusElements.forEach(element => {
                        const userId = element.dataset.userId;
                        if (userId) {
                            window.instantStatusManager.registerStatusElement(element, userId);
                        }
                    });
                    
                    // Register text-based status elements (like user_profile page)
                    const textStatusElements = document.querySelectorAll('.user-status-text[data-user-id]');
                    textStatusElements.forEach(element => {
                        const userId = element.dataset.userId;
                        if (userId && window.UserStatus) {
                            // Use UserStatus for text-based updates (like user_profile page)
                            window.UserStatus.updateUserStatus(element, userId, { showLastSeen: true });
                        }
                    });
                    
                    console.log(`‚úÖ Registered ${statusElements.length} visual dots and ${textStatusElements.length} text status elements for instant updates`);
                } else if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`‚è≥ Waiting for instantStatusManager to initialize... (attempt ${retryCount}/${maxRetries})`);
                    setTimeout(attemptRegistration, 200);
                } else {
                    console.warn('‚ö†Ô∏è instantStatusManager not available after retries, falling back to manual status updates');
                    // Fallback: manually update status elements
                    updateStatusElementsManually();
                }
            }
            
            attemptRegistration();
        }

        // Fallback function to manually update status elements
        function updateStatusElementsManually() {
            // Update visual dot elements
            const statusElements = document.querySelectorAll('.online-dot-results[data-user-id]');
            statusElements.forEach(element => {
                const userId = element.dataset.userId;
                if (userId) {
                    // Use the standalone OnlineCheck module if available
                    if (window.OnlineCheck) {
                        window.OnlineCheck.updateUserStatus(element, userId);
                    } else {
                        // Simple fallback: fetch status directly
                        fetch(`/api/user-status/${userId}`)
                            .then(response => response.json())
                            .then(data => {
                                element.style.display = data.isOnline ? 'block' : 'none';
                            })
                            .catch(error => {
                                console.warn(`Failed to fetch status for user ${userId}:`, error);
                            });
                    }
                }
            });
            
            // Update text-based status elements (like user_profile page)
            const textStatusElements = document.querySelectorAll('.user-status-text[data-user-id]');
            textStatusElements.forEach(element => {
                const userId = element.dataset.userId;
                if (userId) {
                    if (window.UserStatus) {
                        // Use UserStatus for text-based updates (like user_profile page)
                        window.UserStatus.updateUserStatus(element, userId, { showLastSeen: true });
                    } else if (window.OnlineCheck) {
                        // Fallback to OnlineCheck
                        window.OnlineCheck.updateUserStatus(element, userId);
                    } else {
                        // Simple fallback: fetch status directly
                        fetch(`/api/user-status/${userId}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.isOnline) {
                                    element.innerHTML = '<span style="color: #27ae60; font-size:1.2em; vertical-align:middle;">‚óè</span> Online';
                                } else {
                                    element.innerHTML = '<span style="color: #aaa; font-size:1.2em; vertical-align:middle;">‚óè</span> Offline';
                                }
                            })
                            .catch(error => {
                                console.warn(`Failed to fetch status for user ${userId}:`, error);
                            });
                    }
                }
            });
        }

        function showPagination(totalResults) {
            const resultsPerPage = 20;
            const totalPages = Math.ceil(totalResults / resultsPerPage);
            const paginationContainer = document.getElementById('paginationContainer');
            const pageNumbers = document.getElementById('pageNumbers');
            
            console.log(`üîç Pagination Debug: totalResults=${totalResults}, totalPages=${totalPages}, currentPage=${currentPage}`);
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                console.log('üîç Hiding pagination (only 1 page)');
                return;
            }

            paginationContainer.style.display = 'flex';
            console.log('üîç Showing pagination container');

            // Generate page numbers with smart pagination (show max 7 pages)
            let pagesHTML = '';
            const maxVisiblePages = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            console.log(`üîç Page range: ${startPage} to ${endPage}`);

            // Add first page and ellipsis if needed
            if (startPage > 1) {
                pagesHTML += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    pagesHTML += `<span class="page-ellipsis">...</span>`;
                }
            }

            // Add visible page numbers
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                pagesHTML += `
                    <button class="page-btn ${isActive ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }

            // Add last page and ellipsis if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagesHTML += `<span class="page-ellipsis">...</span>`;
                }
                pagesHTML += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            pageNumbers.innerHTML = pagesHTML;
            console.log(`üîç Generated pagination HTML: ${pagesHTML.length} characters`);

            // Update prev/next buttons
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            
            console.log(`üîç Prev button disabled: ${prevButton.disabled}, Next button disabled: ${nextButton.disabled}`);
        }

        function changePage(direction) {
            try {
                const resultsPerPage = 20;
                const totalPages = Math.ceil(searchResults.length / resultsPerPage);
                const newPage = currentPage + direction;
                
                console.log(`üîç ChangePage: direction=${direction}, currentPage=${currentPage}, newPage=${newPage}, totalPages=${totalPages}`);
                
                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    displayResults(searchResults);
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    console.log(`üîç Invalid page: ${newPage} (valid range: 1-${totalPages})`);
                }
            } catch (error) {
                console.error('‚ùå Error in changePage:', error);
            }
        }

        function goToPage(page) {
            try {
                const resultsPerPage = 20;
                const totalPages = Math.ceil(searchResults.length / resultsPerPage);
                
                console.log(`üîç GoToPage: page=${page}, currentPage=${currentPage}, totalPages=${totalPages}`);
                
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    displayResults(searchResults);
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    console.log(`üîç Invalid page: ${page} (valid range: 1-${totalPages})`);
                }
            } catch (error) {
                console.error('‚ùå Error in goToPage:', error);
            }
        }

        function viewProfile(profileId) {
            console.log('Viewing profile:', profileId);
            // Get current user ID and session token for authentication
            const currentUserId = getCurrentUserId();
            const sessionToken = getSessionToken();
            // Redirect to profile page using new template structure with authentication
            window.open(`/user_profile?user=${profileId}&currentUser=${currentUserId}&token=${sessionToken}`, '_blank');
        }
        
                // Get session token from session manager, URL params, or localStorage
        function getSessionToken() {
            // Try session manager first (preferred method)
            if (window.sessionManager && typeof window.sessionManager.getToken === 'function') {
                const token = window.sessionManager.getToken();
                if (token) {
                    return token;
                }
            }
            
            // Try URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            if (urlToken) {
                return urlToken;
            }
            
            // Fallback to localStorage (legacy support)
            const token = localStorage.getItem('totilove_session_token');
            if (token) {
                return token;
            }
            
            // Final fallback
            return '';
        }
        
        // Get current user from session manager, URL params, or localStorage
        function getCurrentUser() {
            // Try session manager first (preferred method)
            if (window.sessionManager && typeof window.sessionManager.getCurrentUser === 'function') {
                const user = window.sessionManager.getCurrentUser();
                if (user && user.id) {
                    return user;
                }
            }
            
            // Try URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const currentUserId = urlParams.get('currentUser');
            if (currentUserId) {
                return { id: parseInt(currentUserId) };
            }
            
            // Fallback to localStorage (legacy support)
            try {
                const currentUser = JSON.parse(localStorage.getItem('totilove_current_user') || '{}');
                if (currentUser.id) {
                    return currentUser;
                }
            } catch (e) {
                console.warn('Failed to parse current user from localStorage:', e);
            }
            
            // Final fallback
            return { id: 2 }; // Fallback to test user
        }
        
        // Get current user ID from URL parameters or session
        function getCurrentUserId() {
            const user = getCurrentUser();
            return user.id;
        }

        function likeProfile(profileId) {
            console.log('Liked profile:', profileId);
            // Show notification or update UI
            const button = event.target.closest('.btn-like');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-heart"></i> Liked!';
            button.style.background = 'var(--success-color)';
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = '';
            }, 2000);
        }

        function messageProfile(username) {
            console.log('Messaging profile:', username);
            if (!username) {
                console.warn('No username provided for messaging');
                return;
            }
            // Open universal message modal (same behavior as user_profile)
            openUniversalMessageModal(username, false, null,
                function() {
                    // success callback (optional)
                },
                function() {
                    // error callback (optional)
                }
            );
        }

        function addToFavourite(profileId) {
            console.log('Added to favourites:', profileId);
            // Show notification or update UI
            const button = event.target.closest('.icon-favourite');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-star" style="color: #ffd700;"></i>';
            
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 2000);
        }

        // Sort functionality
        document.getElementById('sortBy').addEventListener('change', function() {
            console.log('Sorting by:', this.value);
            const params = getSearchParams();
            params.sortBy = this.value;
            performSearch(params);
        });
    </script>
    
            <!-- Include Universal Message Modal -->
            {{include:universal-message-modal}}
            
            <!-- Session Manager -->
            <script src="/assets/js/session-manager.js"></script>
            
            <!-- Force Update Script for Results Page -->
        <!-- <script src="/assets/js/force-update-results.js"></script> -->
