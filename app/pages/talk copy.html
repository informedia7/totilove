<!DOCTYPE html>
<!-- Cache buster: 2025-01-05-00:23:00 - Search panel shows only buttons initially, dropdowns appear on click -->
<!-- 
    IMPORTANT MESSAGE FOR CURSOR AI:
    DONT USE AND DONT CREATE localStorage FOR THIS APP
    Do not use localStorage for storing any data in this application.
    All data should be stored in the database and retrieved via API calls.
-->
<!-- Include User Profile Modal -->
{{include:modals/user-profile-modal}}

<!-- Include Universal Block Confirmation Modal (for user profile modal) -->
{{include:modals/block-confirm-modal}}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="color-scheme" content="light dark">
    <title>Totilove - Messages (Improved)</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#050512">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f2ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Totilove">
    
    <!-- Mobile-first critical base to prevent FOUC -->
    <style id="talk-critical-css">
        :root {
            --talk-safe-top: env(safe-area-inset-top, 0px);
            --talk-safe-bottom: env(safe-area-inset-bottom, 0px);
            --talk-safe-left: env(safe-area-inset-left, 0px);
            --talk-safe-right: env(safe-area-inset-right, 0px);
            --talk-keyboard-height: 0px;
            --talk-page-bg: #f7f2ff;
            --talk-panel-bg: #ffffff;
            --talk-text-color: #1f1b2f;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        html, body {
            min-height: 100%;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--talk-page-bg);
            color: var(--talk-text-color);
        }
        .nav-state-bridge {
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
        }
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            background: var(--talk-panel-bg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
        }
        .app-container.loaded {
            opacity: 1;
            visibility: visible;
        }
        .app-container > .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        .sidebar,
        .chat-area {
            flex: 1;
            min-height: 0;
        }
        .chat-area {
            display: none;
        }
        body[data-nav-state="NAV_CONVERSATIONS_LIST"] .sidebar {
            display: flex;
        }
        body[data-nav-state="NAV_CONVERSATIONS_LIST"] .chat-area {
            display: none;
        }
        body[data-nav-state="NAV_CHAT"] .sidebar {
            display: none;
        }
        body[data-nav-state="NAV_CHAT"] .chat-area {
            display: flex;
            flex-direction: column;
        }
        .mobile-bottom-nav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            gap: 12px;
            padding: 12px calc(16px + var(--talk-safe-right)) calc(12px + var(--talk-safe-bottom)) calc(16px + var(--talk-safe-left));
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 -8px 24px rgba(5, 5, 18, 0.2);
        }
        @media (min-width: 768px) {
            .app-container {
                margin: 12px auto;
                border-radius: 20px;
                max-width: 1200px;
            }
            body[data-nav-state] .sidebar,
            body[data-nav-state] .chat-area {
                display: flex;
            }
            .mobile-bottom-nav {
                display: none;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            .app-container {
                transition: none;
            }
        }
    </style>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="/assets/css/vendor/font-awesome.min.css">

    <!-- CSRF Token Management (auto-injects tokens into all requests) -->
    <script src="/assets/js/csrf-token.js"></script>
    
    <!-- PWA Initialization -->
    <script src="/assets/js/new/pwa-init.js"></script>

    <!-- User authentication data -->
    <script>
        // Resolve session token from cookie or session manager (never embedded in markup)
        function getSessionToken() {
            if (window.sessionManager && typeof window.sessionManager.getToken === 'function') {
                const managedToken = window.sessionManager.getToken();
                if (managedToken) {
                    return managedToken;
                }
            }

            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const trimmed = cookie.trim();
                if (!trimmed) {
                    continue;
                }
                const separatorIndex = trimmed.indexOf('=');
                const name = separatorIndex >= 0 ? trimmed.substring(0, separatorIndex).trim() : trimmed;
                if (name === 'sessionToken' || name === 'session') {
                    const value = separatorIndex >= 0 ? trimmed.substring(separatorIndex + 1).trim() : '';
                    return decodeURIComponent(value || '');
                }
            }

            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token') || '';
        }
        
        // Expose globally for CSRF token management and navigation links
        window.getSessionToken = getSessionToken;

        // Extract user ID from session token
        function getUserIdFromToken() {
            const token = getSessionToken();
            return token ? parseInt(token) : null;
        }

        // Inject user data from server template variables or fallback to token
        window.currentUser = {
            id: parseInt('{{userId}}') || getUserIdFromToken() || null,
            username: '{{realName}}' || 'User',
            real_name: '{{real_name}}' || '{{realName}}' || 'User',
            email: '{{userEmail}}' || '',
            age: parseInt('{{userAge}}') || null,
            gender: '{{userGender}}' || '',
            location: '{{userLocation}}' || '',
            memberSince: '{{memberSince}}' || '',
            lastActive: '{{lastActive}}' || '',
            avatar: '{{userAvatar}}' || ''
        };

        // Set authentication status
        window.isAuthenticated = window.currentUser.id && window.currentUser.id !== 'null' && window.currentUser.id !== '';

        // Store session token globally
        window.sessionToken = getSessionToken();

        // API Base URL - Use main application server for message operations
        window.API_BASE_URL = window.location.origin;


    </script>
    <!-- External CSS Files (extracted from inline styles) -->
    <!-- Extracted CSS from talk.html - Phase 1 CSS Extraction -->
    <link rel="stylesheet" href="/assets/css/new/05-pages/talk/_talk.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="/assets/css/new/05-pages/talk/_talk.css"></noscript>
    <!-- Profile Modal and Report Modal styles are inline in their HTML components -->
</head>
<body>
    <div id="navStateBridge" class="nav-state-bridge" data-nav-state="NAV_CONVERSATIONS_LIST" aria-hidden="true"></div>
    <div class="app-container" id="appContainer">
        <!-- Search Panel -->
        <div class="search-panel" id="searchPanel">
        <div class="search-panel-header">
            <div class="search-panel-title">Search in chat</div>
            <button class="search-panel-close" id="closeSearchPanelBtn">‚úï</button>
        </div>
        <div class="search-panel-content">
            <input type="text" class="search-panel-input" placeholder="Type to search" id="searchPanelInput">
            <div class="search-filters">
                <div class="search-filter-label">Filter:</div>

                <div class="filter-dropdowns-row">
                    <div class="filter-dropdown">
                        <button class="filter-dropdown-btn" id="senderFilterBtn">
                            <span id="senderFilterDisplay">üë§ Sender</span>
                            <span>‚à®</span>
                        </button>
                        <div class="filter-dropdown-content" id="senderFilterContent">
                            <div class="filter-dropdown-list" id="senderFilterList">
                                <!-- "me" remains; current chat partner is injected dynamically from JS -->
                                <div class="filter-dropdown-item" data-value="me">
                                    <div class="filter-dropdown-avatar">M</div>
                                    <span>me</span>
                                </div>
                                <!-- Conversation-specific sender will be appended here from JS -->
                            </div>
                        </div>
                    </div>

                    <div class="filter-dropdown">
                        <button class="filter-dropdown-btn" id="timeFilterBtn">
                            <span>üìÖ Time</span>
                            <span>‚à®</span>
                        </button>
                        <div class="filter-dropdown-content" id="timeFilterContent">
                            <div class="filter-dropdown-list">
                                <!-- Date suggestion section -->
                                <div class="filter-dropdown-section">
                                    <div class="filter-dropdown-item date-suggestion-trigger" data-value="date-suggestion">
                                        <span>üìÖ Quick Select</span>
                                        <span class="arrow-right">‚Üí</span>
                                    </div>
                                </div>

                                <div class="filter-dropdown-separator"></div>

                                <!-- Custom range section -->
                                <div class="filter-dropdown-section">
                                    <div class="filter-dropdown-section-title">Custom range</div>
                                    <div class="date-input-group">
                                        <div class="date-input-container">
                                            <label for="startDate">Start date</label>
                                            <input type="date" class="date-input" id="startDate" max="" min="2010-01-01">
                                            <span class="date-icon">üìÖ</span>
                                        </div>
                                        <div class="date-input-container">
                                            <label for="endDate">End date</label>
                                            <input type="date" class="date-input" id="endDate" max="" min="2010-01-01">
                                            <span class="date-icon">üìÖ</span>
                                        </div>
                                    </div>
                                    <button type="button" id="clearDateRangeBtn" class="clear-date-range-btn" aria-label="Clear date filter">
                                        Clear date
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Search results list (messages) -->
                <div class="search-results">
                    <div class="search-messages-input-container">
                        <input type="text" class="search-messages-input" id="searchMessagesInput" placeholder="Search messages..." aria-label="Search within displayed messages">
                    </div>
                    <div class="search-results-header" id="searchResultsHeader">
                        <span id="searchResultsTitle">Messages</span>
                    </div>
                    <div class="search-results-stats" id="searchResultsStats" role="status" aria-live="polite">
                        <span id="searchResultsStatsText"></span>
                        <button type="button" id="clearMessagesBtn" class="clear-messages-btn" style="display: none;" aria-label="Clear messages">Clear</button>
                    </div>
                    <div class="search-results-list" id="searchResultsList" role="list" aria-label="Search results">
                        <div class="search-results-empty" id="searchResultsEmpty">
                            Select a conversation and start typing to search messages.
                        </div>
                    </div>
                    <div class="view-more-container" id="viewMoreContainer" style="display: none;">
                        <button type="button" id="viewMoreBtn" class="view-more-btn" aria-label="Load more messages">Load More</button>
                    </div>
                </div>

                <!-- Side dropdown for date suggestions -->
                <div class="date-suggestion-dropdown" id="dateSuggestionDropdown">
                    <div class="date-suggestion-header">
                        <span>üìÖ Quick Select</span>
                    </div>
                    <div class="date-suggestion-item" data-value="last7days">
                        <span class="date-suggestion-icon">üìÜ</span>
                        <span>Last 7 days</span>
                    </div>
                    <div class="date-suggestion-item" data-value="last30days">
                        <span class="date-suggestion-icon">üìÖ</span>
                        <span>Last 30 days</span>
                    </div>
                    <div class="date-suggestion-item" data-value="last3months">
                        <span class="date-suggestion-icon">üóìÔ∏è</span>
                        <span>Last 3 months</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="search-instruction">
            <div class="search-instruction-icon">üîç</div>
            <div class="search-instruction-text">Enter keywords to start searching</div>
        </div>
    </div>
        <!-- Top Application Bar -->
        <div class="header">
            <div class="user-avatar">
                <img src="{{userAvatar}}" alt="User Avatar" class="avatar-img" id="userAvatarImg">
            </div>
            <div class="user-info">
                <span class="username">{{real_name}}</span>
            </div>

            <div class="header-actions">
                <!-- Navigation back to previous page -->
                <a href="#" id="backToPreviousBtn" class="header-btn" title="Back to Previous Page">‚¨ÖÔ∏è</a>
                <a href="/profile-full" class="header-btn" title="Profile">üë§</a>
                <div class="top-separator"></div>
                <button class="header-btn" title="Contacts">üë•</button>
                <button class="header-btn" title="Settings">‚öôÔ∏è</button>
                <div class="top-separator"></div>
                <button class="header-btn" title="Search" id="searchPanelBtn">üîç</button>
                <button class="header-btn chat-back-btn-mobile" id="chatBackBtn" title="Back to conversations" style="display: none;">
                    <i class="fas fa-arrow-left"></i>
                </button>

                <!-- Connection Status Indicator -->
                <div class="connection-status connecting" id="connectionStatus" style="display: none;">
                    üîå Connecting...
                </div>
            </div>
        </div>
        <!-- Main Content Area (Sidebar + Chat) -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Search conversations..." id="searchInput">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="unread">Unread</button>
                        <button class="filter-btn" data-filter="saved">Saved</button>
                    </div>
                </div>

                <div class="conversations" id="conversationsList">
                    <!-- Conversations will be populated by JavaScript -->
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-area">
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="chat-avatar" id="chatAvatar"></div>
                <div class="chat-info">
                    <div class="chat-name" id="chatName"></div>
                    <div class="chat-location" id="chatLocation" style="display: none;">
                        <i class="fas fa-map-marker-alt"></i> <span id="chatLocationText"></span>
                    </div>
                    <div class="chat-status" id="chatStatus" style="display: none;"></div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" title="Voice Call">üìû</button>
                    <button class="chat-action-btn" title="Video Call">üìπ</button>
                    <button class="chat-action-btn" title="More" id="chatMoreBtn">‚ãÆ</button>
                </div>
                <!-- Chat More Menu (for block and remove options) -->
                <div id="chatMoreMenu" class="chat-more-menu" style="display: none;">
                    <button class="chat-menu-item" id="blockUserButton" style="display: none;">
                        <i class="fas fa-ban"></i> Block User
                    </button>
                    <button class="chat-menu-item" id="removeUserButton" style="display: none;">
                        <i class="fas fa-user-minus"></i> Remove from conversation
                    </button>
                </div>
            </div>

            <!-- Block Confirmation Modal -->
            <div id="blockConfirmModal" class="remove-user-modal" style="display: none;">
                <div class="remove-user-content">
                    <div class="remove-user-header">
                        <div class="remove-user-icon">
                            <i class="fas fa-ban"></i>
                        </div>
                        <h3 class="remove-user-title">Block User?</h3>
                    </div>
                    <p class="remove-user-message">Block <strong id="blockUsername">this user</strong> from your conversation list?</p>
                    <div class="remove-user-actions">
                        <button id="inlineBlockCancelBtn" class="inline-block-cancel-btn">
                            Cancel
                        </button>
                        <button id="inlineBlockYesBtn" class="inline-block-yes-btn">
                            Block
                        </button>
                    </div>
                </div>
            </div>

            <!-- Remove User Confirmation Modal -->
            <div id="removeUserConfirmModal" class="remove-user-modal" style="display: none;">
                <div class="remove-user-content">
                    <div class="remove-user-header">
                        <div class="remove-user-icon">
                            <i class="fas fa-trash"></i>
                        </div>
                        <h3 class="remove-user-title">Remove from Conversation?</h3>
                    </div>
                    <p class="remove-user-message">Remove <strong id="removeUsername">this user</strong> from your conversation list?</p>
                    <div class="remove-user-actions">
                        <button id="inlineRemoveCancelBtn" class="inline-remove-cancel-btn">
                            Cancel
                        </button>
                        <button id="inlineRemoveYesBtn" class="inline-remove-yes-btn">
                            Remove
                        </button>
                    </div>
                </div>
            </div>


            <!-- Pagination Controls -->
            <div class="message-pagination" id="messagePagination" style="display: none;">
                <div class="pagination-info"></div>
                <div class="pagination-numbers"></div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">üí¨</div>
                    <div class="empty-state-title">Select a conversation</div>
                    <div class="empty-state-text">Choose a conversation from the list to start messaging</div>
                </div>
            </div>

            <div class="message-input-area" id="messageInputArea" style="display: none;">
                <!-- Image Preview Area -->
                <div class="image-preview-area" id="imagePreviewArea" style="display: none;">
                    <div class="image-preview-header">
                        <span class="image-preview-title">üì∑ Images to send:</span>
                        <button class="image-preview-clear" id="clearImagePreviewsBtn">‚úï</button>
                    </div>
                    <div class="image-preview-list" id="imagePreviewList"></div>
                    <div class="image-preview-actions">
                        <button class="image-preview-send" id="sendImagesWithPreviewsBtn">Send Images</button>
                    </div>
                </div>

                <!-- Typing + Counter Row -->
                <div class="input-meta-row" id="inputMetaRow">
                    <div class="typing-status-inline is-hidden" id="typingStatusInline">
                        <span class="typing-status" id="typingStatusText"></span>
                        <div class="typing-dots" aria-hidden="true">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    <div class="character-counter" id="characterCounter">0 / 2000</div>
                </div>

                <div class="input-container" id="inputContainer">
                    <div class="input-actions-wrapper">
                        <textarea class="message-input" placeholder="Type a message..." id="messageInput" rows="1" maxlength="2000"></textarea>
                        <div class="input-actions">
                            <button class="input-action-btn" title="Attach Image" id="selectImageBtn">üìé</button>
                            <button class="input-action-btn" title="Emoji" id="showEmojiPickerBtn">üòä</button>
                            <button class="input-action-btn send-btn" title="Send Message" id="sendMessageBtn">‚û§</button>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        

    <!-- Socket.IO for real-time messaging -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // REMOVED: WebSocket initialization and event handlers - now in talk_websocket-*.js modules
        // Socket variables are now managed in talk_socket-manager.js
        // Real-time message handlers are set up automatically after authentication
        // Functions are exposed globally from modules: initializeWebSocket, setupStatusWebSocketListeners, etc.
        /*
        REMOVED CODE (now in modules):
        - Socket initialization ‚Üí talk_socket-manager.js
        - All socket.on() event handlers ‚Üí talk_realtime-messaging.js  
        - Typing indicator functions ‚Üí talk_typing-indicator.js
        */
        
        // REMOVED: All WebSocket code - now in talk_websocket-*.js modules

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) {
                return 'unknown';
            }

            const now = new Date();
            const diffMs = now.getTime() - date.getTime();

            if (diffMs < 60000) {
                return 'just now';
            }

            const minutes = Math.floor(diffMs / 60000);
            if (minutes < 60) {
                return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
            }

            const hours = Math.floor(minutes / 60);
            if (hours < 24) {
                return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
            }

            const days = Math.floor(hours / 24);
            if (days < 7) {
                return days === 1 ? '1 day ago' : `${days} days ago`;
            }

            const weeks = Math.floor(days / 7);
            if (weeks < 4) {
                return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
            }

            const months = Math.floor(days / 30);
            if (months < 12) {
                return months === 1 ? '1 month ago' : `${months} months ago`;
            }

            const years = Math.floor(days / 365);
            return years === 1 ? '1 year ago' : `${years} years ago`;
        }

        // Unified status management system
        const StatusManager = {
            // Update current chat status display
            updateCurrentChat: async function () {
                if (!currentConversation || !conversations[currentConversation]) return;

                const conversation = conversations[currentConversation];
                const chatStatus = document.getElementById('chatStatus');
                const chatAvatar = document.getElementById('chatAvatar');
                const chatLocation = document.getElementById('chatLocation');
                const chatLocationText = document.getElementById('chatLocationText');
                
                if (!chatAvatar || !conversation.partnerId) return;
                
                // Fetch and display partner's location
                if (chatLocation && chatLocationText && !conversation.isDeleted && conversation.name !== 'Deleted User' && conversation.name !== 'Account Deactivated') {
                    try {
                        const response = await fetch(`/api/user/${conversation.partnerId}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.user) {
                                const locationParts = [];
                                if (data.user.city_name) locationParts.push(data.user.city_name);
                                if (data.user.country_name) locationParts.push(data.user.country_name);
                                const locationString = locationParts.length > 0 ? locationParts.join(', ') : null;

                                if (locationString) {
                                    chatLocationText.textContent = locationString;
                                    chatLocation.style.display = 'flex';
                                } else {
                                    chatLocation.style.display = 'none';
                                }
                            } else {
                                chatLocation.style.display = 'none';
                            }
                        } else {
                            chatLocation.style.display = 'none';
                        }
                    } catch (error) {
                        chatLocation.style.display = 'none';
                    }
                } else if (chatLocation) {
                    chatLocation.style.display = 'none';
                }
                
                const isOnline = conversation.is_online !== undefined 
                    ? conversation.is_online 
                    : (conversation.status && conversation.status.toLowerCase().includes('online'));
                const isDeleted = conversation.isDeleted || conversation.name === 'Deleted User' || conversation.name === 'Account Deactivated';
                
                // Update online indicator on chat avatar
                let indicator = chatAvatar.querySelector('.online-indicator');

                if (!isDeleted && isOnline) {
                    if (!indicator) {
                        indicator = document.createElement('div');
                        indicator.className = 'online-indicator';
                        indicator.setAttribute('data-user-id', conversation.partnerId);
                        chatAvatar.appendChild(indicator);
                    }

                    indicator.style.display = 'block';

                    if (window.instantStatusManager && window.instantStatusManager.isInitialized) {
                        window.instantStatusManager.registerStatusElement(indicator, conversation.partnerId);
                    }

                    if (chatStatus) {
                        chatStatus.style.display = 'none';
                        chatStatus.textContent = '';
                        chatStatus.innerHTML = '';
                        chatStatus.classList.remove('online');
                        chatStatus.classList.add('offline');
                    }
                } else {
                    if (indicator) {
                        indicator.style.display = 'none';
                    }

                    if (chatStatus && !isDeleted) {
                        chatStatus.style.display = 'block';

                        if (window.OnlineCheck && typeof window.OnlineCheck.updateUserStatus === 'function') {
                            await window.OnlineCheck.updateUserStatus(chatStatus, conversation.partnerId, {
                                showLastSeen: true,
                                onlineText: '',
                                offlineText: 'Offline'
                            });

                            const currentIsOnline = conversation.is_online !== undefined
                                ? conversation.is_online
                                : (conversation.status && conversation.status.toLowerCase().includes('online'));
                            if (currentIsOnline && chatStatus) {
                                chatStatus.style.display = 'none';
                                chatStatus.textContent = '';
                                chatStatus.innerHTML = '';
                            }
                        } else if (window.UserStatus && typeof window.UserStatus.updateUserStatus === 'function') {
                            await window.UserStatus.updateUserStatus(chatStatus, conversation.partnerId, {
                                showLastSeen: true
                            });
                        } else {
                            try {
                                const response = await fetch(`/api/user-lastseen/${conversation.partnerId}`);
                                const data = await response.json();
                                if (data.success && data.lastSeen) {
                                    const lastSeenDate = new Date(data.lastSeen);
                                    const formatted = formatTimeAgo(lastSeenDate.toISOString());
                                    chatStatus.textContent = `Last seen ${formatted}`;
                                } else {
                                    chatStatus.textContent = 'Offline';
                                }
                            } catch (error) {
                                chatStatus.textContent = 'Offline';
                            }
                        }
                    } else if (chatStatus && isDeleted) {
                        chatStatus.style.display = 'none';
                    }
                }
            },

            // Update user online status
            updateUserOnline: async function (userId, isOnline) {
                // Get conversations from TalkState
                const conversations = TalkState ? TalkState.getConversations() : (window.conversations || {});
                
                let statusUpdated = false;
                Object.values(conversations).forEach(conversation => {
                    if (conversation.partnerId == userId) {
                        conversation.status = isOnline ? 'Online' : 'Offline';
                        conversation.is_online = isOnline;
                        if (isOnline) {
                            conversation.lastOnlineTime = Date.now();
                        }
                        statusUpdated = true;
                    }
                });

                // If status was updated, re-render conversations to update online indicator
                if (statusUpdated && typeof renderConversations === 'function') {
                    renderConversations();
                }

                // Update current chat status and header avatar indicator if this is the active conversation
                const currentConversation = TalkState ? TalkState.getCurrentConversation() : (window.currentConversation || null);
                if (currentConversation && conversations[currentConversation] && conversations[currentConversation].partnerId == userId) {
                    await this.updateCurrentChat();

                    if (isOnline) {
                        const chatStatus = document.getElementById('chatStatus');
                        if (chatStatus) {
                            chatStatus.style.display = 'none';
                            chatStatus.textContent = '';
                            chatStatus.innerHTML = '';
                            chatStatus.classList.remove('online');
                            chatStatus.classList.add('offline');
                        }
                    }
                }
            },

            // Fallback status display (hidden - status shown via online dot on avatar)
            updateStatusFallback: function (chatStatus, status) {
                // Hide the status text - online indicator is shown on avatar instead
                if (chatStatus) {
                    chatStatus.style.display = 'none';
                }
            }
        };

        // Update current chat status display using unified system
        async function updateCurrentChatStatus() {
            await StatusManager.updateCurrentChat();
        }

        // Cleanup function to prevent memory leaks
        function cleanupStatusListeners() {
            if (window.statusListenersInitialized) {
                window.statusListenersInitialized = false;

            }
        }

        // Clean up when page is unloaded (using pagehide instead of beforeunload for better compatibility)
        window.addEventListener('pagehide', cleanupStatusListeners);

        // Helper function to create enhanced loading placeholders (disabled - no loading text)
        function createEnhancedLoadingPlaceholder(attachmentCount) {
            // Return empty placeholder - no loading text
            const placeholder = document.createElement('div');
            placeholder.className = 'enhanced-loading-placeholder';
            placeholder.style.display = 'none';
            return placeholder;
        }

        // Update user online status using the unified system
        async function updateUserOnlineStatus(userId, isOnline) {
            await StatusManager.updateUserOnline(userId, isOnline);
        }





        // Play notification sound
        function playNotificationSound() {
            try {
                // Create audio context for notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {

            }
        }

        // Update connection status indicator
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionStatus');
            if (!indicator) return;

            // Remove existing classes
            indicator.classList.remove('connected', 'disconnected', 'connecting');

            // Add new class and update text
            switch (status) {
                case 'connected':
                    indicator.classList.add('connected');
                    indicator.innerHTML = 'üü¢ Real-time ON';
                    indicator.style.display = 'block';
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 3000);
                    break;
                case 'disconnected':
                    indicator.classList.add('disconnected');
                    indicator.innerHTML = 'üî¥ Offline mode';
                    indicator.style.display = 'block';
                    break;
                case 'connecting':
                    indicator.classList.add('connecting');
                    indicator.innerHTML = 'üü° Connecting...';
                    indicator.style.display = 'block';
                    break;
            }
        }

    </script>

    <!-- Search initialization now handled in talk_page-bridge.js -->

    <!-- Online Status Utility Scripts -->
    <script src="/assets/js/new/core/presence-engine.js?v=1"></script>
    <script src="/assets/js/new/shared/presence-refresh.js"></script>

    <!-- Include shared emoji picker utility -->
    <script src="/assets/js/new/components/emoji-picker.js"></script>

    <!-- Include User Profile Modal -->
    <!-- Include User Report Modal -->
    {{include:modals/user-report-modal}}

    <!-- Profile Modal Actions Script -->
    <script src="/components/modals/profile-modal-actions.js"></script>

    <!-- Talk page module stack -->
    <script src="/assets/js/new/pages/talk/talk_config.js"></script>
    <script src="/assets/js/new/pages/talk/talk_utils.js"></script>
    <script src="/assets/js/new/pages/talk/talk_state.js"></script>
    <script src="/assets/js/new/pages/talk/talk_helpers.js"></script>
    <script src="/assets/js/new/pages/talk/talk_notifications.js"></script>
    <script src="/assets/js/new/pages/talk/talk_status-manager.js"></script>

    <!-- Search modules -->
    <script src="/assets/js/new/pages/talk/search/talk_search-panel-module.js"></script>
    <script src="/assets/js/new/pages/talk/search/talk_search-filters-module.js"></script>
    <script src="/assets/js/new/pages/talk/search/talk_search-results-module.js"></script>
    <script src="/assets/js/new/pages/talk/search/talk_search-ui-module.js"></script>
    <script src="/assets/js/new/pages/talk/search/talk_search-controller.js"></script>
    <script src="/assets/js/new/pages/talk/search/talk_search-main.js"></script>

    <!-- Conversation modules -->
    <script src="/assets/js/new/pages/talk/conversations/talk_conversation-list-loader.js"></script>
    <script src="/assets/js/new/pages/talk/conversations/talk_conversation-list-renderer.js"></script>
    <script src="/assets/js/new/pages/talk/conversations/talk_conversation-list-selector.js"></script>
    <script src="/assets/js/new/pages/talk/conversations/talk_conversation-list-remover.js"></script>

    <!-- Image helpers -->
    <script src="/assets/js/new/pages/talk/images/talk_image-compressor.js"></script>
    <script src="/assets/js/new/pages/talk/images/talk_image-handler.js"></script>
    <script src="/assets/js/new/pages/talk/images/talk_image-preview.js"></script>

    <!-- Message modules -->
    <script src="/assets/js/new/pages/talk/messages/talk_message-factory.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-validator.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-renderer.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-pagination.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-actions.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-save.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-sender.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-loader.js"></script>
    <script src="/assets/js/new/pages/talk/messages/talk_message-recall.js"></script>

    <!-- Mobile experience managers -->
    <script src="/assets/js/new/pages/talk/orientation-manager.js"></script>
    <script src="/assets/js/new/pages/talk/keyboard-manager.js"></script>
    <script src="/assets/js/new/pages/talk/swipe-manager.js"></script>

    <!-- Realtime and management modules -->
    <script src="/assets/js/new/pages/talk/websocket/talk_socket-manager.js"></script>
    <script src="/assets/js/new/pages/talk/websocket/talk_realtime-messaging.js"></script>
    <script src="/assets/js/new/pages/talk/websocket/talk_typing-indicator.js"></script>
    <script src="/assets/js/new/pages/talk/talk_block-manager.js"></script>
    <script src="/assets/js/new/pages/talk/talk_app-init.js"></script>
    <script src="/assets/js/new/pages/talk/talk_profile-modal.js"></script>
    <script src="/assets/js/new/pages/talk/talk_page-bridge.js"></script>

</body>
</html>

