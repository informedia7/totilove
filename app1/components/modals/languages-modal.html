<!-- Languages Management Modal Component -->
<div id="language-detail-modal" class="languages-modal" role="dialog" aria-modal="true" aria-labelledby="language-detail-title" tabindex="-1" style="display: none;">
    <div class="languages-modal-window">
        <div class="languages-modal-header">
            <h3 class="languages-modal-title">
                <i class="fas fa-language"></i>
                <span id="language-detail-title">Language Details</span>
            </h3>
            <button class="languages-modal-close-btn" id="close-language-detail-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="languages-modal-content">
            <form id="language-detail-form">
                <input type="hidden" id="detail-language-id" name="language_id">
                <input type="hidden" id="detail-language-index" name="language_index">
                
                <div class="form-group">
                    <label for="detail-fluency-level">Fluency Level:</label>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="detail-fluency-level" name="fluency_level" class="fluency-select" style="flex: 1; max-width: 250px;">
                            <option value="">Select fluency level (optional)</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; white-space: nowrap;">
                            <input type="checkbox" id="detail-is-primary" class="is-primary-checkbox">
                            Set as Primary Language
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="skills-label" role="group" aria-labelledby="skills-label-text">
                        <span id="skills-label-text">Skills: * <span class="required-hint">(Select at least one)</span></span>
                    </div>
                    <div class="skills-checkboxes" role="group" aria-label="Language skills">
                        <label>
                            <input type="checkbox" id="detail-can-read" name="can_read" class="skill-checkbox" data-skill="read">
                            <span>Reading</span>
                        </label>
                        <label>
                            <input type="checkbox" id="detail-can-write" name="can_write" class="skill-checkbox" data-skill="write">
                            <span>Writing</span>
                        </label>
                        <label>
                            <input type="checkbox" id="detail-can-speak" name="can_speak" class="skill-checkbox" data-skill="speak">
                            <span>Speaking</span>
                        </label>
                        <label>
                            <input type="checkbox" id="detail-can-understand" name="can_understand" class="skill-checkbox" data-skill="understand">
                            <span>Understanding</span>
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="languages-modal-footer">
            <button type="button" class="cancel-languages-btn" id="cancel-language-detail-btn">
                Cancel
            </button>
            <button type="button" class="save-languages-btn" id="save-language-detail-btn">
                <i class="fas fa-save"></i>
                Save Details
            </button>
        </div>
    </div>
</div>

<!-- Languages Management Modal -->
<div id="languages-modal" class="languages-modal" role="dialog" aria-modal="true" aria-labelledby="languages-modal-title" tabindex="-1" style="display: none;">
    <div class="languages-modal-window">
        <div class="languages-modal-header">
            <h3 class="languages-modal-title">
                <i class="fas fa-language"></i>
                <span id="languages-modal-title">Languages I Speak</span>
            </h3>
            <button class="languages-modal-close-btn" id="close-languages-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="languages-modal-content">
            <div class="languages-checkbox-section">
                <div class="languages-checkbox-header">
                    <div class="section-label" id="select-languages-label">Select Languages: *</div>
                    <button type="button" class="unselect-all-languages-btn" id="unselect-all-languages-btn">
                        <i class="fas fa-times-circle"></i>
                        Unselect All
                    </button>
                </div>
                <div id="languages-checkbox-list" class="languages-checkbox-list" role="group" aria-labelledby="select-languages-label">
                    <!-- Languages checkboxes will be dynamically added here -->
                </div>
            </div>
        </div>
        <div class="languages-modal-footer">
            <button type="button" class="cancel-languages-btn" id="cancel-languages-btn">
                Cancel
            </button>
            <button type="button" class="save-languages-btn" id="save-languages-btn">
                <i class="fas fa-save"></i>
                Save Languages
            </button>
        </div>
    </div>
</div>

<script>
// Languages Modal JavaScript
(function() {
    'use strict';
    
    // Get flag image URL from CDN
    function getFlagImageUrl(isoCode) {
        if (!isoCode) return null;
        
        // Map language ISO codes to country ISO codes for flag images
        const languageToCountry = {
            'en': 'us', 'es': 'es', 'fr': 'fr', 'de': 'de', 'it': 'it', 'pt': 'pt',
            'ru': 'ru', 'zh': 'cn', 'ja': 'jp', 'ko': 'kr', 'ar': 'sa', 'hi': 'in',
            'vi': 'vn', 'th': 'th', 'tr': 'tr', 'pl': 'pl', 'nl': 'nl', 'sv': 'se',
            'no': 'no', 'da': 'dk', 'fi': 'fi', 'el': 'gr', 'he': 'il', 'cs': 'cz',
            'hu': 'hu', 'ro': 'ro', 'bg': 'bg', 'hr': 'hr', 'sk': 'sk', 'sl': 'si',
            'uk': 'ua', 'bn': 'bd', 'ur': 'pk', 'fa': 'ir', 'id': 'id', 'ms': 'my',
            'tl': 'ph', 'sw': 'ke', 'af': 'za', 'ca': 'es', 'eu': 'es', 'ga': 'ie',
            'cy': 'gb', 'mt': 'mt', 'is': 'is', 'lv': 'lv', 'lt': 'lt', 'et': 'ee',
            'mk': 'mk', 'sq': 'al', 'sr': 'rs', 'bs': 'ba', 'me': 'me', 'ka': 'ge',
            'hy': 'am', 'az': 'az', 'kk': 'kz', 'uz': 'uz', 'mn': 'mn', 'my': 'mm',
            'km': 'kh', 'lo': 'la', 'ne': 'np', 'si': 'lk', 'ta': 'in', 'te': 'in',
            'ml': 'in', 'kn': 'in', 'gu': 'in', 'pa': 'in', 'mr': 'in', 'or': 'in',
            'as': 'in', 'am': 'et', 'yo': 'ng', 'ig': 'ng', 'ha': 'ng', 'zu': 'za',
            'xh': 'za', 'eo': null, 'la': 'va', 'co': 'fr', 'gd': 'gb', 'br': 'fr',
            'fy': 'nl', 'lb': 'lu', 'rm': 'ch', 'gv': 'im', 'kw': 'gb'
        };
        
        const countryCode = languageToCountry[isoCode.toLowerCase()];
        if (!countryCode) return null;
        
        // Use local flag images
        return `/assets/images/flags/${countryCode}.png`;
    }
    
    // Language to flag emoji mapping
    function getLanguageFlag(isoCode) {
        if (!isoCode) return 'ðŸŒ';
        
        const languageFlags = {
            'en': 'ðŸ‡ºðŸ‡¸', 'es': 'ðŸ‡ªðŸ‡¸', 'fr': 'ðŸ‡«ðŸ‡·', 'de': 'ðŸ‡©ðŸ‡ª', 'it': 'ðŸ‡®ðŸ‡¹', 'pt': 'ðŸ‡µðŸ‡¹',
            'ru': 'ðŸ‡·ðŸ‡º', 'zh': 'ðŸ‡¨ðŸ‡³', 'ja': 'ðŸ‡¯ðŸ‡µ', 'ko': 'ðŸ‡°ðŸ‡·', 'ar': 'ðŸ‡¸ðŸ‡¦', 'hi': 'ðŸ‡®ðŸ‡³',
            'vi': 'ðŸ‡»ðŸ‡³', 'th': 'ðŸ‡¹ðŸ‡­', 'tr': 'ðŸ‡¹ðŸ‡·', 'pl': 'ðŸ‡µðŸ‡±', 'nl': 'ðŸ‡³ðŸ‡±', 'sv': 'ðŸ‡¸ðŸ‡ª',
            'no': 'ðŸ‡³ðŸ‡´', 'da': 'ðŸ‡©ðŸ‡°', 'fi': 'ðŸ‡«ðŸ‡®', 'el': 'ðŸ‡¬ðŸ‡·', 'he': 'ðŸ‡®ðŸ‡±', 'cs': 'ðŸ‡¨ðŸ‡¿',
            'hu': 'ðŸ‡­ðŸ‡º', 'ro': 'ðŸ‡·ðŸ‡´', 'bg': 'ðŸ‡§ðŸ‡¬', 'hr': 'ðŸ‡­ðŸ‡·', 'sk': 'ðŸ‡¸ðŸ‡°', 'sl': 'ðŸ‡¸ðŸ‡®',
            'uk': 'ðŸ‡ºðŸ‡¦', 'bn': 'ðŸ‡§ðŸ‡©', 'ur': 'ðŸ‡µðŸ‡°', 'fa': 'ðŸ‡®ðŸ‡·', 'id': 'ðŸ‡®ðŸ‡©', 'ms': 'ðŸ‡²ðŸ‡¾',
            'tl': 'ðŸ‡µðŸ‡­', 'sw': 'ðŸ‡°ðŸ‡ª', 'af': 'ðŸ‡¿ðŸ‡¦', 'ca': 'ðŸ‡ªðŸ‡¸', 'eu': 'ðŸ‡ªðŸ‡¸', 'ga': 'ðŸ‡®ðŸ‡ª',
            'cy': 'ðŸ‡¬ðŸ‡§', 'mt': 'ðŸ‡²ðŸ‡¹', 'is': 'ðŸ‡®ðŸ‡¸', 'lv': 'ðŸ‡±ðŸ‡»', 'lt': 'ðŸ‡±ðŸ‡¹', 'et': 'ðŸ‡ªðŸ‡ª',
            'mk': 'ðŸ‡²ðŸ‡°', 'sq': 'ðŸ‡¦ðŸ‡±', 'sr': 'ðŸ‡·ðŸ‡¸', 'bs': 'ðŸ‡§ðŸ‡¦', 'me': 'ðŸ‡²ðŸ‡ª', 'ka': 'ðŸ‡¬ðŸ‡ª',
            'hy': 'ðŸ‡¦ðŸ‡²', 'az': 'ðŸ‡¦ðŸ‡¿', 'kk': 'ðŸ‡°ðŸ‡¿', 'uz': 'ðŸ‡ºðŸ‡¿', 'mn': 'ðŸ‡²ðŸ‡³', 'my': 'ðŸ‡²ðŸ‡²',
            'km': 'ðŸ‡°ðŸ‡­', 'lo': 'ðŸ‡±ðŸ‡¦', 'ne': 'ðŸ‡³ðŸ‡µ', 'si': 'ðŸ‡±ðŸ‡°', 'ta': 'ðŸ‡®ðŸ‡³', 'te': 'ðŸ‡®ðŸ‡³',
            'ml': 'ðŸ‡®ðŸ‡³', 'kn': 'ðŸ‡®ðŸ‡³', 'gu': 'ðŸ‡®ðŸ‡³', 'pa': 'ðŸ‡®ðŸ‡³', 'mr': 'ðŸ‡®ðŸ‡³', 'or': 'ðŸ‡®ðŸ‡³',
            'as': 'ðŸ‡®ðŸ‡³', 'am': 'ðŸ‡ªðŸ‡¹', 'yo': 'ðŸ‡³ðŸ‡¬', 'ig': 'ðŸ‡³ðŸ‡¬', 'ha': 'ðŸ‡³ðŸ‡¬', 'zu': 'ðŸ‡¿ðŸ‡¦',
            'xh': 'ðŸ‡¿ðŸ‡¦', 'eo': 'ðŸŒ', 'la': 'ðŸ‡»ðŸ‡¦', 'co': 'ðŸ‡«ðŸ‡·', 'gd': 'ðŸ‡¬ðŸ‡§', 'br': 'ðŸ‡«ðŸ‡·',
            'fy': 'ðŸ‡³ðŸ‡±', 'lb': 'ðŸ‡±ðŸ‡º', 'rm': 'ðŸ‡¨ðŸ‡­', 'gv': 'ðŸ‡®ðŸ‡²', 'kw': 'ðŸ‡¬ðŸ‡§'
        };
        
        return languageFlags[isoCode.toLowerCase()] || 'ðŸŒ';
    }
    
    // Export functions to window for use in profile-edit.html
    window.getFlagImageUrl = getFlagImageUrl;
    window.getLanguageFlag = getLanguageFlag;
})();

// Accessibility & focus management for language modals
(function() {
    const modals = [
        { id: 'languages-modal', close: () => window.LanguagesModalManager?.closeLanguagesModalFunc?.() },
        { id: 'language-detail-modal', close: () => window.LanguagesModalManager?.closeLanguageDetailModalFunc?.() }
    ];

    const focusableSelector = 'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])';

    function setupModal(modalEntry) {
        const modal = document.getElementById(modalEntry.id);
        if (!modal) return;

        let previousFocus = null;
        let previousOverflow = null;
        let active = false;

        function trapFocus(e) {
            if (e.key !== 'Tab') return;
            const focusable = Array.from(modal.querySelectorAll(focusableSelector)).filter(el => el.offsetParent !== null);
            if (focusable.length === 0) {
                e.preventDefault();
                modal.focus();
                return;
            }
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey && document.activeElement === first) {
                e.preventDefault();
                last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
                e.preventDefault();
                first.focus();
            }
        }

        function handleKeydown(e) {
            if (e.key === 'Escape') {
                e.stopPropagation();
                modalEntry.close?.();
                return;
            }
            trapFocus(e);
        }

        function onOpen() {
            if (active) return;
            active = true;
            previousFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
            previousOverflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';
            modal.addEventListener('keydown', handleKeydown, true);
            setTimeout(() => {
                const focusTarget = modal.querySelector(focusableSelector) || modal;
                focusTarget?.focus();
            }, 0);
        }

        function onClose() {
            if (!active) return;
            active = false;
            modal.removeEventListener('keydown', handleKeydown, true);
            document.body.style.overflow = previousOverflow;
            previousFocus?.focus?.();
        }

        const observer = new MutationObserver(() => {
            const isVisible = getComputedStyle(modal).display !== 'none';
            if (isVisible) {
                onOpen();
            } else {
                onClose();
            }
        });
        observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
        window.addEventListener('pagehide', () => observer.disconnect());
    }

    modals.forEach(setupModal);
})();
</script>






























