-- Migration: Revert simplification and add receiver_id back
-- Since messages are deleted, we need receiver_id to track who should see deleted users

-- Step 1: Add receiver_id column back if it doesn't exist
ALTER TABLE users_deleted 
ADD COLUMN IF NOT EXISTS receiver_id INTEGER;

-- Step 2: For existing entries, we can't determine receiver_id (messages are deleted)
-- So we'll need to populate it manually or leave NULL for now
-- New entries will have receiver_id populated when user is deleted

-- Step 3: Add unique constraint on (receiver_id, deleted_user_id)
ALTER TABLE users_deleted 
DROP CONSTRAINT IF EXISTS users_deleted_receiver_id_deleted_user_id_key;

ALTER TABLE users_deleted 
ADD CONSTRAINT users_deleted_receiver_id_deleted_user_id_key UNIQUE (receiver_id, deleted_user_id);

-- Step 4: Recreate index on receiver_id
CREATE INDEX IF NOT EXISTS idx_users_deleted_receiver ON users_deleted(receiver_id);

-- Step 5: Update table comment
COMMENT ON TABLE users_deleted IS 'Stores deleted user information for each receiver. When a user is deleted, entries are created for all users who had messages with them.';


































































































































































































