<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS SQL to PostgreSQL Migration Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group.checkbox {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .form-group.checkbox input {
            width: auto;
            cursor: pointer;
        }

        .form-group.checkbox label {
            margin: 0;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-box {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }

        .status-box.show {
            display: block;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tables-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            background: white;
            display: none;
        }

        .tables-container.show {
            display: block;
        }

        .table-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .table-item:last-child {
            border-bottom: none;
        }

        .table-item input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .table-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            font-weight: normal;
        }

        .select-all-header {
            padding: 12px;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-section {
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 40px;
            background: #e9ecef;
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .info-box strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }

        .info-box span {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .details-table th,
        .details-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .details-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-running {
            background: #cce5ff;
            color: #004085;
        }

        .badge-completed {
            background: #d4edda;
            color: #155724;
        }

        .badge-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .note strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ MS SQL to PostgreSQL Migration Tool</h1>
            <p>Copy database from MS SQL Server to PostgreSQL (pgAdmin)</p>
        </div>

        <div class="content">
            <div class="note" id="apiNote">
                <strong>üìå API Server:</strong>
                <span id="apiUrlDisplay">Loading...</span>
                <br><br>
                <strong>To start the server:</strong>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Open terminal in <code>migration-tool</code> folder</li>
                    <li>Run: <code>npm install</code> (first time only)</li>
                    <li>Run: <code>npm start</code></li>
                </ol>
            </div>

            <!-- MS SQL Server Configuration -->
            <div class="section">
                <h2>üìä MS SQL Server (Source)</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label>Host / Instance</label>
                        <input type="text" id="mssqlHost" placeholder="localhost or localhost\MSSQLSERVER2022" value="localhost">
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            For default instance: <code>localhost</code> or <code>BRENDAN</code><br>
                            For named instance: <code>localhost\MSSQLSERVER2022</code> or <code>BRENDAN\MSSQLSERVER2022</code>
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Port</label>
                        <input type="number" id="mssqlPort" placeholder="1433 (leave empty for named instances)" value="1433">
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Leave empty if using instance name format (e.g., <code>hostname\instance</code>)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Database</label>
                        <input type="text" id="mssqlDatabase" placeholder="SourceDatabase">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="mssqlUser" placeholder="sa">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="mssqlPassword" placeholder="Password">
                    </div>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="mssqlEncrypt" checked>
                        <label for="mssqlEncrypt">Encrypt Connection</label>
                    </div>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="mssqlTrustCert">
                        <label for="mssqlTrustCert">Trust Server Certificate</label>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <button id="testMSSQLBtn" class="btn btn-info">Test MS SQL Connection</button>
                    <button id="tryInstanceFormatBtn" class="btn btn-secondary" style="margin-left: 10px;" onclick="tryInstanceFormat()">Try Instance Format</button>
                </div>
                <div id="mssqlStatus" class="status-box"></div>
                <div id="mssqlTroubleshoot" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; color: #856404;">
                    <strong>üîß Troubleshooting Tips:</strong>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Enable TCP/IP Protocol (MOST COMMON FIX):</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; list-style-type: disc;">
                                <li>Open <strong>SQL Server Configuration Manager</strong></li>
                                <li>Go to: <code>SQL Server Network Configuration</code> ‚Üí <code>Protocols for MSSQLSERVER</code> (or your instance)</li>
                                <li>Right-click <strong>TCP/IP</strong> ‚Üí <strong>Enable</strong></li>
                                <li>Double-click <strong>TCP/IP</strong> ‚Üí <strong>IP Addresses</strong> tab</li>
                                <li>Scroll to <strong>IPAll</strong> section</li>
                                <li>Set <strong>TCP Port</strong> to <code>1433</code></li>
                                <li>Click <strong>OK</strong></li>
                                <li><strong>RESTART SQL Server service</strong> (important!)</li>
                            </ul>
                        </li>
                        <li><strong>Check SQL Server Service:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; list-style-type: disc;">
                                <li>Open <strong>Services</strong> (<code>Win+R</code> ‚Üí <code>services.msc</code>)</li>
                                <li>Find <code>SQL Server (MSSQLSERVER)</code> or <code>SQL Server (MSSQLSERVER2022)</code></li>
                                <li>Ensure it's <strong>Running</strong></li>
                            </ul>
                        </li>
                        <li><strong>Start SQL Server Browser:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; list-style-type: disc;">
                                <li>In Services, find <code>SQL Server Browser</code></li>
                                <li>Right-click ‚Üí <strong>Start</strong> (if stopped)</li>
                                <li>Set Startup type to <strong>Automatic</strong></li>
                            </ul>
                        </li>
                        <li><strong>Try Alternative Connection Formats:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; list-style-type: disc;">
                                <li>For default instance: <code>localhost</code> or <code>BRENDAN</code> (your computer name)</li>
                                <li>For named instance: <code>localhost\MSSQLSERVER2022</code> or <code>BRENDAN\MSSQLSERVER2022</code></li>
                                <li>For SQL Express: <code>localhost\SQLEXPRESS</code> or <code>BRENDAN\SQLEXPRESS</code></li>
                                <li>When using instance name, leave <strong>Port</strong> empty (Browser will find it)</li>
                            </ul>
                        </li>
                        <li><strong>Windows Firewall:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; list-style-type: disc;">
                                <li>Allow port <code>1433</code> through Windows Firewall</li>
                                <li>Or run: <code>New-NetFirewallRule -DisplayName "SQL Server" -Direction Inbound -Protocol TCP -LocalPort 1433 -Action Allow</code></li>
                            </ul>
                        </li>
                        <li><strong>Enable SQL Server Authentication:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; list-style-type: disc;">
                                <li>Open <strong>SQL Server Management Studio</strong></li>
                                <li>Right-click server ‚Üí <strong>Properties</strong> ‚Üí <strong>Security</strong></li>
                                <li>Select <strong>SQL Server and Windows Authentication mode</strong></li>
                                <li>Restart SQL Server service</li>
                            </ul>
                        </li>
                    </ol>
                    <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <strong>üí° Quick Test:</strong> Run the diagnostic script: <code>.\check-mssql-connection.ps1</code> in the migration-tool folder
                    </div>
                </div>
            </div>

            <!-- PostgreSQL Configuration -->
            <div class="section">
                <h2>üêò PostgreSQL (Target - pgAdmin)</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label>Host</label>
                        <input type="text" id="pgHost" placeholder="localhost" value="localhost">
                    </div>
                    <div class="form-group">
                        <label>Port</label>
                        <input type="number" id="pgPort" placeholder="5432" value="5432">
                    </div>
                    <div class="form-group">
                        <label>Database</label>
                        <input type="text" id="pgDatabase" placeholder="lavadataDb" value="lavadataDb">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="pgUser" placeholder="postgres" value="postgres">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="pgPassword" placeholder="Password">
                    </div>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="pgSSL">
                        <label for="pgSSL">Use SSL</label>
                    </div>
                </div>
                <button id="testPostgreSQLBtn" class="btn btn-info">Test PostgreSQL Connection</button>
                <div id="pgStatus" class="status-box"></div>
            </div>

            <!-- Tables Selection -->
            <div class="section">
                <h2>üìã Select Tables to Migrate</h2>
                <button id="loadTablesBtn" class="btn btn-primary">Load Tables from MS SQL</button>
                <div id="tablesContainer" class="tables-container">
                    <div class="select-all-header">
                        <input type="checkbox" id="selectAllTables">
                        <label for="selectAllTables">Select All Tables</label>
                    </div>
                    <div id="tablesList"></div>
                </div>
            </div>

            <!-- Migration Options -->
            <div class="section">
                <h2>‚öôÔ∏è Migration Options</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label>Batch Size (rows per batch)</label>
                        <input type="number" id="batchSize" value="1000" min="100" max="10000">
                    </div>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="skipExisting" checked>
                        <label for="skipExisting">Skip Existing Rows (ON CONFLICT)</label>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="startMigrationBtn" class="btn btn-success" disabled>üöÄ Start Migration</button>
                <button id="cancelMigrationBtn" class="btn btn-danger" style="display: none;">‚èπÔ∏è Cancel Migration</button>
            </div>

            <!-- Migration Progress -->
            <div id="progressSection" class="progress-section">
                <div class="section">
                    <h2>üìä Migration Progress</h2>
                    <div>
                        <strong>Status:</strong> <span id="migrationStatus">-</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Current Table:</strong> <span id="currentTable">-</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                    </div>
                    <div class="progress-info">
                        <div class="info-box">
                            <strong>Tables Progress</strong>
                            <span id="tablesProgress">0 / 0</span>
                        </div>
                        <div class="info-box">
                            <strong>Rows Migrated</strong>
                            <span id="rowsProgress">0 / 0</span>
                        </div>
                        <div class="info-box">
                            <strong>Errors</strong>
                            <span id="errorsCount">0</span>
                        </div>
                    </div>
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Table</th>
                                <th>Status</th>
                                <th>Rows</th>
                                <th>Errors</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody">
                            <tr><td colspan="4" style="text-align: center; padding: 20px;">No migration started yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Auto-detect API server URL
        function getApiBase() {
            // If opened as file://, use default server
            if (window.location.protocol === 'file:') {
                return 'http://localhost:3004';
            }
            // Otherwise use same origin
            return window.location.origin;
        }
        
        let API_BASE = getApiBase();
        let currentMigrationId = null;
        let statusInterval = null;
        let mssqlTables = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Display current API URL
            updateApiUrlDisplay();
            
            // Check if opened as file and show warning
            if (window.location.protocol === 'file:') {
                showFileProtocolWarning();
            }
            setupEventListeners();
        });

        function updateApiUrlDisplay() {
            const display = document.getElementById('apiUrlDisplay');
            if (display) {
                display.innerHTML = `Currently using: <strong style="color: #667eea;">${API_BASE}</strong>`;
            }
        }

        function showFileProtocolWarning() {
            const note = document.querySelector('.note');
            if (note) {
                note.innerHTML = `
                    <strong>‚ö†Ô∏è Important:</strong>
                    This page was opened directly as a file. You need to run the migration server first.
                    <br><br>
                    <strong>To fix:</strong>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>Open terminal/command prompt</li>
                        <li>Navigate to: <code>migration-tool</code> folder</li>
                        <li>Run: <code>npm install</code> (first time only)</li>
                        <li>Run: <code>npm start</code></li>
                        <li>Then open: <a href="http://localhost:3004" target="_blank">http://localhost:3004</a></li>
                    </ol>
                    <br>
                    <strong>Or configure API URL:</strong>
                    <input type="text" id="apiUrlInput" placeholder="http://localhost:3004" value="http://localhost:3004" 
                           style="padding: 8px; width: 300px; margin: 5px 0;">
                    <button onclick="updateApiUrl()" class="btn btn-primary" style="padding: 8px 16px;">Update API URL</button>
                `;
            }
        }

        function updateApiUrl() {
            const input = document.getElementById('apiUrlInput');
            if (input && input.value) {
                API_BASE = input.value.replace(/\/$/, ''); // Remove trailing slash
                updateApiUrlDisplay();
                alert(`API URL updated to: ${API_BASE}`);
            }
        }

        function tryInstanceFormat() {
            const hostInput = document.getElementById('mssqlHost');
            const portInput = document.getElementById('mssqlPort');
            const currentHost = hostInput.value.trim();
            
            // Try different formats
            if (!currentHost.includes('\\')) {
                // Try with MSSQLSERVER2022 instance
                hostInput.value = currentHost + '\\MSSQLSERVER2022';
                portInput.value = '';
                alert('Trying instance format: ' + hostInput.value + '\nPort cleared (not needed for named instances)');
            } else if (currentHost.includes('\\MSSQLSERVER2022')) {
                // Try default instance
                hostInput.value = currentHost.replace('\\MSSQLSERVER2022', '');
                portInput.value = '1433';
                alert('Trying default instance format: ' + hostInput.value + '\nPort set to 1433');
            } else {
                // Try SQLEXPRESS
                hostInput.value = currentHost.split('\\')[0] + '\\SQLEXPRESS';
                portInput.value = '';
                alert('Trying SQL Express format: ' + hostInput.value);
            }
        }

        function setupEventListeners() {
            document.getElementById('testMSSQLBtn').addEventListener('click', testMSSQLConnection);
            document.getElementById('testPostgreSQLBtn').addEventListener('click', testPostgreSQLConnection);
            document.getElementById('loadTablesBtn').addEventListener('click', loadTables);
            document.getElementById('selectAllTables').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.table-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateStartButton();
            });
            document.getElementById('startMigrationBtn').addEventListener('click', startMigration);
            document.getElementById('cancelMigrationBtn').addEventListener('click', cancelMigration);
        }

        async function testMSSQLConnection() {
            const btn = document.getElementById('testMSSQLBtn');
            const statusDiv = document.getElementById('mssqlStatus');
            
            btn.disabled = true;
            btn.textContent = 'Testing...';
            statusDiv.className = 'status-box';
            statusDiv.textContent = 'Testing connection...';
            statusDiv.classList.add('show');
            
            try {
                const config = {
                    host: document.getElementById('mssqlHost').value,
                    port: parseInt(document.getElementById('mssqlPort').value) || 1433,
                    database: document.getElementById('mssqlDatabase').value,
                    user: document.getElementById('mssqlUser').value,
                    password: document.getElementById('mssqlPassword').value,
                    encrypt: document.getElementById('mssqlEncrypt').checked,
                    trustCert: document.getElementById('mssqlTrustCert').checked
                };
                
                const response = await fetch(`${API_BASE}/api/migration/test/mssql`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'status-box status-success show';
                    statusDiv.textContent = '‚úÖ Connection successful!';
                    document.getElementById('mssqlTroubleshoot').style.display = 'none';
                } else {
                    statusDiv.className = 'status-box status-error show';
                    statusDiv.textContent = `‚ùå Connection failed: ${data.message}`;
                    document.getElementById('mssqlTroubleshoot').style.display = 'block';
                }
            } catch (error) {
                statusDiv.className = 'status-box status-error show';
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMsg = `Cannot connect to API server. Make sure the migration server is running on ${API_BASE}. Run "npm start" in the migration-tool folder.`;
                    document.getElementById('mssqlTroubleshoot').style.display = 'none';
                } else {
                    document.getElementById('mssqlTroubleshoot').style.display = 'block';
                }
                statusDiv.textContent = `‚ùå Error: ${errorMsg}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test MS SQL Connection';
            }
        }

        async function testPostgreSQLConnection() {
            const btn = document.getElementById('testPostgreSQLBtn');
            const statusDiv = document.getElementById('pgStatus');
            
            btn.disabled = true;
            btn.textContent = 'Testing...';
            statusDiv.className = 'status-box';
            statusDiv.textContent = 'Testing connection...';
            statusDiv.classList.add('show');
            
            try {
                const config = {
                    host: document.getElementById('pgHost').value,
                    port: parseInt(document.getElementById('pgPort').value) || 5432,
                    database: document.getElementById('pgDatabase').value,
                    user: document.getElementById('pgUser').value,
                    password: document.getElementById('pgPassword').value,
                    ssl: document.getElementById('pgSSL').checked
                };
                
                const response = await fetch(`${API_BASE}/api/migration/test/postgresql`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'status-box status-success show';
                    statusDiv.textContent = '‚úÖ Connection successful!';
                } else {
                    statusDiv.className = 'status-box status-error show';
                    statusDiv.textContent = `‚ùå Connection failed: ${data.message}`;
                }
            } catch (error) {
                statusDiv.className = 'status-box status-error show';
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMsg = `Cannot connect to API server. Make sure the migration server is running on ${API_BASE}. Run "npm start" in the migration-tool folder.`;
                }
                statusDiv.textContent = `‚ùå Error: ${errorMsg}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test PostgreSQL Connection';
            }
        }

        async function loadTables() {
            const btn = document.getElementById('loadTablesBtn');
            const container = document.getElementById('tablesContainer');
            const list = document.getElementById('tablesList');
            
            btn.disabled = true;
            btn.textContent = 'Loading...';
            list.innerHTML = '<div class="loading">Loading tables...</div>';
            container.classList.add('show');
            
            try {
                const config = {
                    host: document.getElementById('mssqlHost').value,
                    port: parseInt(document.getElementById('mssqlPort').value) || 1433,
                    database: document.getElementById('mssqlDatabase').value,
                    user: document.getElementById('mssqlUser').value,
                    password: document.getElementById('mssqlPassword').value,
                    encrypt: document.getElementById('mssqlEncrypt').checked,
                    trustCert: document.getElementById('mssqlTrustCert').checked
                };
                
                const response = await fetch(`${API_BASE}/api/migration/tables`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mssqlTables = data.tables;
                    renderTables(data.tables);
                    updateStartButton();
                } else {
                    list.innerHTML = `<div class="loading" style="color: red;">Error: ${data.message}</div>`;
                }
            } catch (error) {
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMsg = `Cannot connect to API server. Make sure the migration server is running on ${API_BASE}. Run "npm start" in the migration-tool folder.`;
                }
                list.innerHTML = `<div class="loading" style="color: red;">Error: ${errorMsg}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Load Tables from MS SQL';
            }
        }

        function renderTables(tables) {
            const list = document.getElementById('tablesList');
            
            if (tables.length === 0) {
                list.innerHTML = '<div class="loading">No tables found</div>';
                return;
            }
            
            list.innerHTML = tables.map(table => `
                <div class="table-item">
                    <input type="checkbox" class="table-checkbox" id="table_${table}" value="${table}" onchange="updateStartButton()">
                    <label for="table_${table}">${table}</label>
                </div>
            `).join('');
        }

        function updateStartButton() {
            const checkboxes = document.querySelectorAll('.table-checkbox:checked');
            const startBtn = document.getElementById('startMigrationBtn');
            startBtn.disabled = checkboxes.length === 0;
        }

        async function startMigration() {
            const selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedTables.length === 0) {
                alert('Please select at least one table to migrate');
                return;
            }
            
            if (!confirm(`Start migration for ${selectedTables.length} table(s)?`)) {
                return;
            }
            
            const mssqlConfig = {
                host: document.getElementById('mssqlHost').value,
                port: parseInt(document.getElementById('mssqlPort').value) || 1433,
                database: document.getElementById('mssqlDatabase').value,
                user: document.getElementById('mssqlUser').value,
                password: document.getElementById('mssqlPassword').value,
                encrypt: document.getElementById('mssqlEncrypt').checked,
                trustCert: document.getElementById('mssqlTrustCert').checked
            };
            
            const pgConfig = {
                host: document.getElementById('pgHost').value,
                port: parseInt(document.getElementById('pgPort').value) || 5432,
                database: document.getElementById('pgDatabase').value,
                user: document.getElementById('pgUser').value,
                password: document.getElementById('pgPassword').value,
                ssl: document.getElementById('pgSSL').checked
            };
            
            const options = {
                batchSize: parseInt(document.getElementById('batchSize').value) || 1000,
                skipExisting: document.getElementById('skipExisting').checked
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/migration/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mssqlConfig,
                        pgConfig,
                        tables: selectedTables,
                        options
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentMigrationId = data.migrationId;
                    document.getElementById('startMigrationBtn').disabled = true;
                    document.getElementById('cancelMigrationBtn').style.display = 'inline-block';
                    document.getElementById('progressSection').classList.add('active');
                    
                    startStatusPolling();
                } else {
                    alert(`Failed to start migration: ${data.message}`);
                }
            } catch (error) {
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMsg = `Cannot connect to API server. Make sure the migration server is running on ${API_BASE}. Run "npm start" in the migration-tool folder.`;
                }
                alert(`Error: ${errorMsg}`);
            }
        }

        function startStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
            
            statusInterval = setInterval(async () => {
                if (!currentMigrationId) return;
                
                try {
                    const response = await fetch(`${API_BASE}/api/migration/status/${currentMigrationId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        updateMigrationStatus(data.migration);
                        
                        if (data.migration.status === 'completed' || 
                            data.migration.status === 'failed' || 
                            data.migration.status === 'cancelled') {
                            clearInterval(statusInterval);
                            document.getElementById('startMigrationBtn').disabled = false;
                            document.getElementById('cancelMigrationBtn').style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 2000);
        }

        function updateMigrationStatus(migration) {
            document.getElementById('migrationStatus').textContent = migration.status.toUpperCase();
            document.getElementById('currentTable').textContent = migration.currentTable || '-';
            document.getElementById('progressBar').style.width = `${migration.progress}%`;
            document.getElementById('progressBar').textContent = `${migration.progress}%`;
            document.getElementById('tablesProgress').textContent = `${migration.completedTables} / ${migration.totalTables}`;
            document.getElementById('rowsProgress').textContent = `${migration.migratedRows} / ${migration.totalRows}`;
            document.getElementById('errorsCount').textContent = migration.errors;
            
            const tbody = document.getElementById('detailsTableBody');
            if (migration.details && migration.details.length > 0) {
                tbody.innerHTML = migration.details.map(detail => {
                    const statusClass = `badge-${detail.status}`;
                    return `
                        <tr>
                            <td>${detail.table}</td>
                            <td><span class="badge ${statusClass}">${detail.status}</span></td>
                            <td>${detail.rows || 0}</td>
                            <td>${detail.errors || 0}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function cancelMigration() {
            if (!currentMigrationId) return;
            
            if (!confirm('Are you sure you want to cancel the migration?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/migration/cancel/${currentMigrationId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (statusInterval) {
                        clearInterval(statusInterval);
                    }
                    document.getElementById('cancelMigrationBtn').style.display = 'none';
                    alert('Migration cancelled');
                } else {
                    alert(`Failed to cancel: ${data.message}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>



















































