<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totilove - Messages</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/js/session-manager.js"></script>
    <style>
        :root {
            --primary-blue: #0078d4;
            --primary-blue-hover: #106ebe;
            --sidebar-bg: #f3f2f1;
            --content-bg: #ffffff;
            --border-color: #edebe9;
            --text-primary: #323130;
            --text-secondary: #605e5c;
            --hover-bg: #f3f2f1;
            --selected-bg: #deecf9;
            --unread-bg: #fff9f5;
            --unread-border: #fd7e14;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--content-bg);
            height: 100vh;
            overflow: hidden;
        }

        .outlook-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Top Navigation Bar */
        .top-nav {
            background: var(--primary-blue);
            color: white;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-search {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 6px 12px;
            color: white;
            width: 300px;
            font-size: 14px;
        }

            .nav-search::placeholder {
                color: rgba(255,255,255,0.7);
            }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

            .nav-btn:hover {
                background: rgba(255,255,255,0.1);
            }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .new-message-btn {
            width: 100%;
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }

            .new-message-btn:hover {
                background: var(--primary-blue-hover);
            }

        .folders-list {
            flex: 1;
            padding: 8px 0;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

            .folder-item:hover {
                background: var(--hover-bg);
            }

            .folder-item.active {
                background: var(--selected-bg);
                color: var(--primary-blue);
                font-weight: 600;
            }

        .folder-icon {
            width: 16px;
            margin-right: 12px;
            text-align: center;
        }

        .folder-count {
            margin-left: auto;
            background: var(--primary-blue);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        /* Message List */
        .message-list-container {
            width: 380px;
            background: var(--content-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .list-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--content-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .list-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .list-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

            .action-btn:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
            }

        .message-list {
            flex: 1;
            overflow-y: auto;
        }

        .message-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

            .message-item:hover {
                background: var(--hover-bg);
            }

            .message-item.selected {
                background: var(--selected-bg);
            }

            .message-item.unread {
                background: var(--unread-bg);
                border-left: 3px solid var(--unread-border);
                font-weight: 600;
            }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .message-sender {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-subject {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 2px;
            font-weight: 500;
        }

        .message-preview {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .message-icons {
            position: absolute;
            top: 12px;
            right: 40px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-item:hover .message-icons {
            opacity: 1;
        }

        .icon-btn {
            background: var(--content-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

            .icon-btn:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
            }

        /* Message View */
        .message-view {
            flex: 1;
            background: var(--content-bg);
            display: flex;
            flex-direction: column;
        }

        .view-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--content-bg);
        }

        .view-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .view-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .view-btn:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
            }

            .view-btn.primary {
                background: var(--primary-blue);
                color: white;
                border-color: var(--primary-blue);
            }

                .view-btn.primary:hover {
                    background: var(--primary-blue-hover);
                }

        .message-details {
            background: var(--sidebar-bg);
            padding: 12px;
            border-radius: 4px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            width: 50px;
            margin-right: 8px;
        }

        .detail-value {
            color: var(--text-primary);
            flex: 1;
        }

        .message-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--content-bg);
        }

        .content-subject {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .content-body {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .empty-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }

            .empty-view i {
                font-size: 48px;
                margin-bottom: 16px;
                opacity: 0.5;
            }

            .empty-view h3 {
                margin-bottom: 8px;
                color: var(--text-primary);
            }

        /* Compose Modal */
        .compose-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .compose-window {
            background: var(--content-bg);
            width: 600px;
            height: 500px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .compose-header {
            padding: 12px 16px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .compose-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
        }

        .compose-form {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .form-label {
            width: 60px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .form-input {
            flex: 1;
            border: none;
            padding: 6px 0;
            font-size: 14px;
            color: var(--text-primary);
            background: transparent;
            outline: none;
        }

        .compose-content {
            flex: 1;
            border: none;
            padding: 12px 0;
            font-size: 14px;
            color: var(--text-primary);
            background: transparent;
            outline: none;
            resize: none;
            font-family: inherit;
            line-height: 1.5;
        }

        .compose-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }

        .send-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

            .send-btn:hover {
                background: var(--primary-blue-hover);
            }

        .cancel-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

            .cancel-btn:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
            }

        /* Loading and Error States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

            .loading i {
                animation: spin 1s linear infinite;
                margin-right: 8px;
            }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .message-list-container {
                width: 100%;
            }

            .message-view {
                display: none;
            }

            .nav-search {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="outlook-container">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-left">
                <div class="app-title">
                    <i class="fas fa-envelope"></i>
                    Totilove Messages
                </div>
                <input type="text" class="nav-search" placeholder="Search messages..." id="globalSearch">
            </div>
            <div class="nav-right">
                <button class="nav-btn" onclick="refreshMessages()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="nav-btn" onclick="window.location.href='/users/profile.html'">
                    <i class="fas fa-user"></i> Profile
                </button>
                <button class="nav-btn" onclick="window.location.href='/'">
                    <i class="fas fa-home"></i> Home
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <button class="new-message-btn" onclick="openCompose()">
                        <i class="fas fa-plus"></i>
                        New Message
                    </button>
                </div>

                <div class="folders-list">
                    <button class="folder-item active" data-folder="inbox" onclick="selectFolder('inbox')">
                        <i class="fas fa-inbox folder-icon"></i>
                        Inbox
                        <span class="folder-count" id="inboxCount">0</span>
                    </button>
                    <button class="folder-item" data-folder="sent" onclick="selectFolder('sent')">
                        <i class="fas fa-paper-plane folder-icon"></i>
                        Sent
                        <span class="folder-count" id="sentCount">0</span>
                    </button>
                </div>
            </div>

            <!-- Message List -->
            <div class="message-list-container">
                <div class="list-header">
                    <div class="list-title" id="listTitle">Inbox</div>
                    <div class="list-actions">
                        <button class="action-btn" onclick="markAllAsRead()" title="Mark all as read">
                            <i class="fas fa-check-double"></i>
                        </button>
                        <button class="action-btn" onclick="deleteSelected()" title="Delete selected">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="message-list" id="messageList">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        Loading messages...
                    </div>
                </div>
            </div>

            <!-- Message View -->
            <div class="message-view" id="messageView">
                <div class="empty-view">
                    <i class="fas fa-envelope-open"></i>
                    <h3>Select a message</h3>
                    <p>Choose a message from the list to read its contents</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Compose Modal -->
    <div class="compose-modal" id="composeModal">
        <div class="compose-window">
            <div class="compose-header">
                <div class="compose-title">New Message</div>
                <button class="close-btn" onclick="closeCompose()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="compose-form">
                <div class="form-row">
                    <div class="form-label">To:</div>
                    <input type="text" class="form-input" id="composeRecipient" placeholder="Enter username or search...">
                </div>

                <div class="form-row">
                    <div class="form-label">Subject:</div>
                    <input type="text" class="form-input" id="composeSubject" placeholder="Message subject">
                </div>

                <textarea class="compose-content" id="composeContent" placeholder="Write your message here..."></textarea>
            </div>

            <div class="compose-footer">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
                <button class="cancel-btn" onclick="closeCompose()">Cancel</button>
            </div>
        </div>
    </div>

    <script>let currentUser = null;
        let currentFolder = 'inbox';
        let currentMessage = null;
        let messages = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Outlook-style Messages initializing...');

            try {
                // Check authentication
                if (!window.sessionManager.isAuthenticated()) {
                    showError('Please log in to access messages.');
                    return;
                }

                currentUser = window.sessionManager.getCurrentUser();
                if (!currentUser) {
                    currentUser = await window.sessionManager.getUserProfile();
                }

                if (!currentUser) {
                    showError('Please log in to access messages.');
                    return;
                }

                console.log('✅ User authenticated:', currentUser);
                window.currentUser = currentUser;

                // Load initial data
                await loadMessages();
                setupEventListeners();

            } catch (error) {
                console.error('❌ Initialization error:', error);
                showError('Failed to initialize messages. Please refresh the page.');
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            // Global search
            document.getElementById('globalSearch').addEventListener('input', debounce(handleSearch, 300));

            // Close modal on outside click
            document.getElementById('composeModal').addEventListener('click', function(e) {
                if (e.target === this) closeCompose();
            });
        }

        // Select folder (inbox/sent)
        async function selectFolder(folder) {
            currentFolder = folder;

            // Update active folder
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-folder="${folder}"]`).classList.add('active');

            // Update list title
            document.getElementById('listTitle').textContent = folder === 'inbox' ? 'Inbox' : 'Sent';

            // Clear current message view
            showEmptyView();

            // Load messages for selected folder
            await loadMessages();
        }

        // Load messages from API
        async function loadMessages() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Loading messages...</div>';

            try {
                const endpoint = currentFolder === 'inbox' ? '/api/messages/inbox' : '/api/messages/sent';
                const response = await window.sessionManager.apiRequest(endpoint);

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        messages = data.messages || [];
                        renderMessageList(messages);
                        updateFolderCounts();
                    } else {
                        showEmptyList('Failed to load messages');
                    }
                } else {
                    showEmptyList('Failed to load messages');
                }
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                showEmptyList('Error loading messages');
            }
        }

        // Render message list
        function renderMessageList(messageList) {
            const container = document.getElementById('messageList');

            if (!messageList || messageList.length === 0) {
                showEmptyList();
                return;
            }

            container.innerHTML = messageList.map(msg => {
                const isUnread = !msg.is_read && currentFolder === 'inbox';
                const sender = currentFolder === 'inbox' ? msg.sender_username : msg.receiver_username;
                const time = formatMessageTime(msg.timestamp);

                return `
                    <div class="message-item ${isUnread ? 'unread' : ''}"
                         data-message-id="${msg.id}"
                         onclick="selectMessage(${msg.id})">
                        <div class="message-header">
                            <div class="message-sender">${escapeHtml(sender || 'Unknown User')}</div>
                            <div class="message-time">${time}</div>
                        </div>
                        <div class="message-subject">${escapeHtml(msg.subject || 'No Subject')}</div>
                        <div class="message-preview">${escapeHtml(truncateText(msg.content, 80))}</div>
                        <div class="message-icons">
                            ${isUnread ? '<span class="icon-btn" title="Unread"><i class="fas fa-circle" style="color: #fd7e14;"></i></span>' : ''}
                            <button class="icon-btn" onclick="event.stopPropagation(); deleteMessage(${msg.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show empty list
        function showEmptyList(message = null) {
            const container = document.getElementById('messageList');
            const folderName = currentFolder === 'inbox' ? 'inbox' : 'sent items';

            container.innerHTML = `
                <div class="empty-view">
                    <i class="fas fa-${currentFolder === 'inbox' ? 'inbox' : 'paper-plane'}"></i>
                    <h3>${message || `No messages in ${folderName}`}</h3>
                    <p>${message ? 'Please try again later' : `Your ${folderName} is empty`}</p>
                </div>
            `;
        }

        // Select and display message
        async function selectMessage(messageId) {
            currentMessage = messageId;

            // Update selected state
            document.querySelectorAll('.message-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-message-id="${messageId}"]`).classList.add('selected');

            // Find message data
            const message = messages.find(m => m.id === messageId);
            if (!message) return;

            // Display message
            displayMessage(message);

            // Mark as read if it's an unread inbox message
            if (currentFolder === 'inbox' && !message.is_read) {
                await markAsRead(messageId);
            }
        }

        // Display message content
        function displayMessage(message) {
            const messageView = document.getElementById('messageView');
            const isInbox = currentFolder === 'inbox';
            const otherUser = isInbox ? message.sender_username : message.receiver_username;

            messageView.innerHTML = `
                <div class="view-header">
                    <div class="view-actions">
                        <button class="view-btn primary" onclick="replyToMessage()">
                            <i class="fas fa-reply"></i> Reply
                        </button>
                        <button class="view-btn" onclick="deleteMessage(${message.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ${isInbox && !message.is_read ? `
                            <button class="view-btn" onclick="markAsRead(${message.id})">
                                <i class="fas fa-check"></i> Mark as Read
                            </button>
                        ` : ''}
                    </div>

                    <div class="message-details">
                        <div class="detail-row">
                            <div class="detail-label">${isInbox ? 'From:' : 'To:'}</div>
                            <div class="detail-value">${escapeHtml(otherUser || 'Unknown User')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Date:</div>
                            <div class="detail-value">${formatFullDate(message.timestamp)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Subject:</div>
                            <div class="detail-value">${escapeHtml(message.subject || 'No Subject')}</div>
                        </div>
                    </div>
                </div>

                <div class="message-content">
                    <div class="content-subject">${escapeHtml(message.subject || 'No Subject')}</div>
                    <div class="content-body">${escapeHtml(message.content)}</div>
                </div>
            `;
        }

        // Show empty message view
        function showEmptyView() {
            document.getElementById('messageView').innerHTML = `
                <div class="empty-view">
                    <i class="fas fa-envelope-open"></i>
                    <h3>Select a message</h3>
                    <p>Choose a message from the list to read its contents</p>
                </div>
            `;
        }

        // Open compose modal
        function openCompose(recipient = '', subject = '') {
            document.getElementById('composeRecipient').value = recipient;
            document.getElementById('composeSubject').value = subject;
            document.getElementById('composeContent').value = '';
            document.getElementById('composeModal').style.display = 'flex';
            document.getElementById('composeRecipient').focus();
        }

        // Close compose modal
        function closeCompose() {
            document.getElementById('composeModal').style.display = 'none';
        }

        // Reply to current message
        function replyToMessage() {
            if (!currentMessage) return;

            const message = messages.find(m => m.id === currentMessage);
            if (!message) return;

            const isInbox = currentFolder === 'inbox';
            const recipient = isInbox ? message.sender_username : message.receiver_username;
            const subject = message.subject && !message.subject.startsWith('Re:') ?
                          `Re: ${message.subject}` : (message.subject || 'Re: Your message');

            openCompose(recipient, subject);
        }

        // Send message
        async function sendMessage() {
            const recipient = document.getElementById('composeRecipient').value.trim();
            const subject = document.getElementById('composeSubject').value.trim();
            const content = document.getElementById('composeContent').value.trim();

            if (!recipient || !content) {
                alert('Please fill in recipient and message content');
                return;
            }

            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                // First, get user ID by username
                const userResponse = await window.sessionManager.apiRequest(`/api/users/search?username=${encodeURIComponent(recipient)}`);

                if (!userResponse.ok) {
                    throw new Error('User not found');
                }

                const userData = await userResponse.json();
                if (!userData.success || !userData.users || userData.users.length === 0) {
                    throw new Error('User not found');
                }

                const receiverId = userData.users[0].id;

                // Send the message
                const response = await window.sessionManager.apiRequest('/api/messages/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        receiverId: receiverId,
                        content: content,
                        subject: subject || 'No Subject'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        closeCompose();
                        await loadMessages();
                        updateFolderCounts();
                        alert('Message sent successfully!');
                    } else {
                        throw new Error(data.error || 'Failed to send message');
                    }
                } else {
                    throw new Error('Failed to send message');
                }

            } catch (error) {
                console.error('❌ Error sending message:', error);
                alert(error.message || 'Failed to send message');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
            }
        }

        // Mark message as read
        async function markAsRead(messageId) {
            try {
                const response = await window.sessionManager.apiRequest(`/api/messages/${messageId}/read`, {
                    method: 'POST'
                });

                if (response.ok) {
                    // Update local message state
                    const message = messages.find(m => m.id === messageId);
                    if (message) {
                        message.is_read = true;
                    }

                    // Update UI
                    const messageItem = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageItem) {
                        messageItem.classList.remove('unread');
                    }

                    updateFolderCounts();

                    // Refresh message view if this is the current message
                    if (currentMessage === messageId) {
                        displayMessage(message);
                    }
                }
            } catch (error) {
                console.error('❌ Error marking message as read:', error);
            }
        }

        // Delete message
        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;

            try {
                const response = await window.sessionManager.apiRequest(`/api/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deleteType: 'for_me' })
                });

                if (response.ok) {
                    await loadMessages();
                    updateFolderCounts();

                    if (currentMessage === messageId) {
                        showEmptyView();
                        currentMessage = null;
                    }
                } else {
                    alert('Failed to delete message');
                }
            } catch (error) {
                console.error('❌ Error deleting message:', error);
                alert('Failed to delete message');
            }
        }

        // Mark all as read
        async function markAllAsRead() {
            if (currentFolder !== 'inbox') return;

            const unreadMessages = messages.filter(m => !m.is_read);
            if (unreadMessages.length === 0) {
                alert('No unread messages');
                return;
            }

            if (!confirm(`Mark all ${unreadMessages.length} messages as read?`)) return;

            try {
                const response = await window.sessionManager.apiRequest('/api/messages/mark-all-read', {
                    method: 'POST'
                });

                if (response.ok) {
                    await loadMessages();
                    updateFolderCounts();
                } else {
                    alert('Failed to mark messages as read');
                }
            } catch (error) {
                console.error('❌ Error marking all as read:', error);
                alert('Failed to mark messages as read');
            }
        }

        // Update folder counts
        function updateFolderCounts() {
            const inboxCount = currentFolder === 'inbox' ?
                             messages.filter(m => !m.is_read).length : 0;
            const sentCount = currentFolder === 'sent' ? messages.length : 0;

            document.getElementById('inboxCount').textContent = inboxCount;
            document.getElementById('sentCount').textContent = sentCount;

            // Hide count badge if zero
            document.getElementById('inboxCount').style.display = inboxCount > 0 ? 'block' : 'none';
            document.getElementById('sentCount').style.display = sentCount > 0 ? 'block' : 'none';
        }

        // Handle search
        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();

            if (!query) {
                renderMessageList(messages);
                return;
            }

            const filtered = messages.filter(msg => {
                const sender = currentFolder === 'inbox' ? msg.sender_username : msg.receiver_username;
                return (sender && sender.toLowerCase().includes(query)) ||
                       (msg.subject && msg.subject.toLowerCase().includes(query)) ||
                       (msg.content && msg.content.toLowerCase().includes(query));
            });

            renderMessageList(filtered);
        }

        // Refresh messages
        async function refreshMessages() {
            await loadMessages();
        }

        // Utility functions
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';

            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = diffMs / (1000 * 60 * 60);
            const diffDays = diffMs / (1000 * 60 * 60 * 24);

            if (diffDays < 1) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays < 7) {
                return date.toLocaleDateString([], { weekday: 'short' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function formatFullDate(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleString();
        }

        function truncateText(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showError(message) {
            document.getElementById('messageList').innerHTML = `
                <div class="empty-view">
                    <i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <p><a href="/pages/login.html" style="color: var(--primary-blue);">← Go to Login</a></p>
                </div>
            `;
        }</script>
</body>
</html>