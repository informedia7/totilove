<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Totilove</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/components/navbar.css">
    <style>
        :root {
            --primary-color: #6c5ce7;
                       <!-- Age Preferences -->
            <div class="form-row">color: #00b894;
            --dark-color: #2d3436;
            --light-color: #f5f6fa;
            --text-color: #333;
            --muted-color: #636e72;
            --white: #ffffff;
            --danger-color: #d63031;
            --success-color: #00b894;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .register-wrapper {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 80px); /* Account for navbar height */
            padding: 2rem;
            justify-content: center;
        }

        .register-container {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
            padding: 3rem;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-header h1 {
            color: var(--dark-color);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .form-header p {
            color: var(--muted-color);
            font-size: 1.1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
            font-weight: 500;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--light-color);
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
            background: var(--white);
        }

        .form-control.error, .form-select.error {
            border-color: var(--danger-color);
        }

        .form-control.success, .form-select.success {
            border-color: var(--success-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: block;
        }

        .success-message {
            color: var(--success-color);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: block;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none !important;
        }

        .form-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        .form-footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .form-footer a:hover {
            text-decoration: underline;
        }

        .password-requirements {
            background: var(--light-color);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .password-requirements ul {
            margin: 0.5rem 0 0 1rem;
            color: var(--muted-color);
        }

        .password-requirements .valid {
            color: var(--success-color);
        }

        .password-requirements .invalid {
            color: var(--danger-color);
        }

        .multi-select {
            min-height: 120px;
        }

        .select-hint {
            font-size: 0.8rem;
            color: var(--muted-color);
            margin-top: 0.3rem;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .register-container {
                margin: 1rem;
                padding: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }

            .form-header h1 {
                font-size: 2rem;
            }

            body {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Component -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header">
                <a href="/" class="navbar-logo">ðŸ’• Totilove</a>
                <button class="navbar-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <ul class="navbar-menu" id="navbarMenu">
                <li><a href="/">Home</a></li>
                <li><a href="/#features">Features</a></li>
                <li><a href="/#profiles">Browse</a></li>
                <li><a href="/#testimonials">Success Stories</a></li>
                <li><a href="/login">Login</a></li>
                <li><a href="/contact">Contact</a></li>
                <li><a href="/register" class="register-btn active">Join Now</a></li>
            </ul>
        </div>
    </nav>

    <div class="register-wrapper">
        <div class="register-container">
        <div class="form-header">
            <h1>Join Totilove</h1>
            <p>Create your account and find your perfect match</p>
        </div>

        <form id="registerForm" novalidate>
            <!-- Username and Email -->
            <div class="form-row">
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" name="username" class="form-control" 
                           minlength="5" maxlength="12" required 
                           placeholder="5-12 characters, letters, numbers, underscore">
                    <div class="error-message" id="username-error"></div>
                    <div class="success-message" id="username-success"></div>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" class="form-control" 
                           maxlength="25" required placeholder="your@email.com">
                    <div class="error-message" id="email-error"></div>
                    <div class="success-message" id="email-success"></div>
                </div>
            </div>

            <!-- Password -->
            <div class="form-group">
                <label for="password">Password *</label>
                <input type="password" id="password" name="password" class="form-control" 
                       minlength="5" maxlength="12" required 
                       placeholder="5-12 characters with uppercase and number">
                <div class="password-requirements" id="passwordRequirements">
                    <p>Password must contain:</p>
                    <ul>
                        <li id="length">5-12 characters</li>
                        <li id="uppercase">At least one uppercase letter</li>
                        <li id="number">At least one number</li>
                    </ul>
                </div>
                <div class="error-message" id="password-error"></div>
            </div>

            <!-- Birthdate and Gender -->
            <div class="form-row">
                <div class="form-group">
                    <label for="birthdate">Birthdate *</label>
                    <input type="date" id="birthdate" name="birthdate" class="form-control" required>
                    <div class="error-message" id="birthdate-error"></div>
                </div>
                <div class="form-group">
                    <label for="gender">Gender *</label>
                    <select id="gender" name="gender" class="form-select" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                    <div class="error-message" id="gender-error"></div>
                </div>
            </div>

            <!-- About Myself -->
            <div class="form-group">
                <label for="about_myself">About Myself</label>
                <textarea id="about_myself" name="about_myself" class="form-control" 
                          maxlength="500" placeholder="Tell us about yourself..."></textarea>
                <div class="select-hint">Maximum 500 characters</div>
            </div>

            <!-- Interests -->
            <div class="form-group">
                <label for="interests">Interests</label>
                <textarea id="interests" name="interests" class="form-control" 
                          maxlength="500" placeholder="Your hobbies and interests..."></textarea>
                <div class="select-hint">Maximum 500 characters</div>
            </div>

            <!-- Location -->
            <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="country" class="form-select" required>
                    <option value="">Loading countries...</option>
                </select>
                <div class="error-message" id="country-error"></div>
            </div>

            <div class="form-row">
                <div class="form-group" id="state-container" style="display: none;">
                    <label for="state">State</label>
                    <select id="state" name="state" class="form-select">
                        <option value="">Select State First</option>
                    </select>
                    <div class="error-message" id="state-error"></div>
                </div>
                <div class="form-group" id="city-container" style="display: none;">
                    <label for="city">City</label>
                    <select id="city" name="city" class="form-select">
                        <option value="">Select City First</option>
                    </select>
                    <div class="error-message" id="city-error"></div>
                </div>
            </div>

            <!-- Age Preferences -->
            <div class="form-row">
                <div class="form-group">
                    <label for="age_min">Minimum Age *</label>
                    <input type="number" id="age_min" name="age_min" class="form-control" 
                           min="18" max="110" value="18" required>
                    <div class="error-message" id="age_min-error"></div>
                </div>
                <div class="form-group">
                    <label for="age_max">Maximum Age *</label>
                    <input type="number" id="age_max" name="age_max" class="form-control" 
                           min="18" max="110" value="110" required>
                    <div class="error-message" id="age_max-error"></div>
                </div>
            </div>

            <!-- Location Radius and Preferred Gender -->
            <div class="form-row">
                <div class="form-group">
                    <label for="location_radius">Location Radius (km)</label>
                    <input type="number" id="location_radius" name="location_radius" 
                           class="form-control" min="0" value="50">
                </div>
                <div class="form-group">
                    <label for="preferred_gender">Preferred Gender *</label>
                    <select id="preferred_gender" name="preferred_gender" class="form-select" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                    <div class="error-message" id="preferred_gender-error"></div>
                </div>
            </div>

            <button type="submit" class="btn" id="submit-btn">Create Account</button>
        </form>

        <div class="form-footer">
            <p>Already have an account? <a href="/login">Sign in here</a></p>
        </div>
    </div>
    </div> <!-- End register-wrapper -->

    <script src="/components/navbar.js"></script>
    <script>
        let countries = [];
        let usernameCheckTimer = null;
        let emailCheckTimer = null;

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            loadCountries();
            setupEventListeners();
            setDateLimits();
        });

        function setupEventListeners() {
            // Username validation with real-time checking
            document.getElementById('username').addEventListener('input', function() {
                clearTimeout(usernameCheckTimer);
                usernameCheckTimer = setTimeout(() => checkUsernameAvailability(), 500);
                validateUsername();
            });
            
            // Email validation with real-time checking
            document.getElementById('email').addEventListener('input', function() {
                clearTimeout(emailCheckTimer);
                emailCheckTimer = setTimeout(() => checkEmailAvailability(), 500);
                validateEmail();
            });
            
            // Password validation
            document.getElementById('password').addEventListener('input', validatePassword);
            
            // Country/State/City cascading
            document.getElementById('country').addEventListener('change', onCountryChange);
            document.getElementById('state').addEventListener('change', onStateChange);
            
            // Form submission
            document.getElementById('registerForm').addEventListener('submit', onFormSubmit);
            
            // Age validation
            document.getElementById('age_min').addEventListener('change', validateAgeRange);
            document.getElementById('age_max').addEventListener('change', validateAgeRange);
        }

        async function loadCountries() {
            try {
                const response = await fetch('/api/countries');
                const data = await response.json();
                
                if (data.success) {
                    countries = data.countries;
                    populateCountrySelects();
                } else {
                    console.error('Failed to load countries:', data.error);
                    showError('country', 'Failed to load countries');
                }
            } catch (error) {
                console.error('Error loading countries:', error);
                showError('country', 'Failed to load countries');
            }
        }

        function populateCountrySelects() {
            const countrySelect = document.getElementById('country');

            // Clear existing options
            countrySelect.innerHTML = '<option value="">Select Country</option>';

            countries.forEach(country => {
                const option1 = new Option(country.name, country.id);
                countrySelect.add(option1);
            });
        }

        async function onCountryChange() {
            const countryId = document.getElementById('country').value;
            const stateSelect = document.getElementById('state');
            const citySelect = document.getElementById('city');
            const stateContainer = document.getElementById('state-container');
            const cityContainer = document.getElementById('city-container');

            // Clear state and city
            stateSelect.innerHTML = '<option value="">Select State First</option>';
            citySelect.innerHTML = '<option value="">Select City First</option>';
            stateContainer.style.display = 'none';
            cityContainer.style.display = 'none';

            if (countryId) {
                try {
                    stateSelect.innerHTML = '<option value="">Loading states...</option>';
                    const response = await fetch(`/api/states?country_id=${countryId}`);
                    const data = await response.json();

                    if (data.success && data.states.length > 0) {
                        stateSelect.innerHTML = '<option value="">Select State</option>';
                        data.states.forEach(state => {
                            stateSelect.add(new Option(state.name, state.id));
                        });
                        stateContainer.style.display = 'block';
                    } else {
                        stateSelect.innerHTML = '<option value="">No states available</option>';
                    }
                } catch (error) {
                    console.error('Error loading states:', error);
                    stateSelect.innerHTML = '<option value="">Error loading states</option>';
                }
            }
        }

        async function onStateChange() {
            const stateId = document.getElementById('state').value;
            const citySelect = document.getElementById('city');
            const cityContainer = document.getElementById('city-container');

            citySelect.innerHTML = '<option value="">Select City First</option>';
            cityContainer.style.display = 'none';

            if (stateId) {
                try {
                    citySelect.innerHTML = '<option value="">Loading cities...</option>';
                    const response = await fetch(`/api/cities?state_id=${stateId}`);
                    const data = await response.json();

                    if (data.success && data.cities.length > 0) {
                        citySelect.innerHTML = '<option value="">Select City</option>';
                        data.cities.forEach(city => {
                            citySelect.add(new Option(city.name, city.id));
                        });
                        cityContainer.style.display = 'block';
                    } else {
                        citySelect.innerHTML = '<option value="">No cities available</option>';
                    }
                } catch (error) {
                    console.error('Error loading cities:', error);
                    citySelect.innerHTML = '<option value="">Error loading cities</option>';
                }
            }
        }        async function checkUsernameAvailability() {
            const username = document.getElementById('username').value;
            const usernameField = document.getElementById('username');
            const errorEl = document.getElementById('username-error');
            const successEl = document.getElementById('username-success');
            
            if (username.length < 5) return;
            
            try {
                const response = await fetch(`/api/check-username?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.available) {
                        usernameField.classList.remove('error');
                        usernameField.classList.add('success');
                        errorEl.textContent = '';
                        successEl.textContent = 'Username is available!';
                    } else {
                        usernameField.classList.remove('success');
                        usernameField.classList.add('error');
                        successEl.textContent = '';
                        errorEl.textContent = 'Username is already taken';
                    }
                }
            } catch (error) {
                console.error('Error checking username:', error);
            }
        }

        async function checkEmailAvailability() {
            const email = document.getElementById('email').value;
            const emailField = document.getElementById('email');
            const errorEl = document.getElementById('email-error');
            const successEl = document.getElementById('email-success');
            
            if (!email || !email.includes('@')) return;
            
            try {
                const response = await fetch(`/api/check-email?email=${encodeURIComponent(email)}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.available) {
                        emailField.classList.remove('error');
                        emailField.classList.add('success');
                        errorEl.textContent = '';
                        successEl.textContent = 'Email is available!';
                    } else {
                        emailField.classList.remove('success');
                        emailField.classList.add('error');
                        successEl.textContent = '';
                        errorEl.textContent = 'Email is already registered';
                    }
                }
            } catch (error) {
                console.error('Error checking email:', error);
            }
        }

        function validateUsername() {
            const username = document.getElementById('username').value;
            const usernameField = document.getElementById('username');
            const errorEl = document.getElementById('username-error');
            
            if (username.length === 0) {
                usernameField.classList.remove('error', 'success');
                errorEl.textContent = '';
                return;
            }
            
            if (username.length < 5 || username.length > 12 || !/^[a-zA-Z0-9_]+$/.test(username)) {
                usernameField.classList.add('error');
                usernameField.classList.remove('success');
                errorEl.textContent = 'Username must be 5-12 characters, letters, numbers, and underscores only';
            } else {
                usernameField.classList.remove('error');
                errorEl.textContent = '';
            }
        }

        function validateEmail() {
            const email = document.getElementById('email').value;
            const emailField = document.getElementById('email');
            const errorEl = document.getElementById('email-error');
            
            if (email.length === 0) {
                emailField.classList.remove('error', 'success');
                errorEl.textContent = '';
                return;
            }
            
            if (email.length > 25 || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                emailField.classList.add('error');
                emailField.classList.remove('success');
                errorEl.textContent = 'Please enter a valid email (max 25 characters)';
            } else {
                emailField.classList.remove('error');
                errorEl.textContent = '';
            }
        }

        function validatePassword() {
            const password = document.getElementById('password').value;
            const checks = {
                length: password.length >= 5 && password.length <= 12,
                uppercase: /[A-Z]/.test(password),
                number: /\d/.test(password)
            };

            Object.keys(checks).forEach(check => {
                const element = document.getElementById(check);
                if (checks[check]) {
                    element.classList.add('valid');
                    element.classList.remove('invalid');
                } else {
                    element.classList.add('invalid');
                    element.classList.remove('valid');
                }
            });
        }

        function validateAgeRange() {
            const minAge = parseInt(document.getElementById('age_min').value);
            const maxAge = parseInt(document.getElementById('age_max').value);

            if (minAge && maxAge && minAge > maxAge) {
                showError('age_max', 'Maximum age must be greater than minimum age');
            } else {
                clearError('age_max');
            }
        }        function setDateLimits() {
            const birthdateInput = document.getElementById('birthdate');
            const today = new Date();
            const maxDate = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
            const minDate = new Date(today.getFullYear() - 120, today.getMonth(), today.getDate());
            
            birthdateInput.max = maxDate.toISOString().split('T')[0];
            birthdateInput.min = minDate.toISOString().split('T')[0];
        }

        async function onFormSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            
            // Disable submit button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Creating Account...';
            
            try {
                if (!validateForm()) {
                    return;
                }
                
                const formData = new FormData(document.getElementById('registerForm'));
                const data = Object.fromEntries(formData);
                
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store session token in localStorage for immediate access
                    if (result.sessionToken) {
                        localStorage.setItem('sessionToken', result.sessionToken);
                        localStorage.setItem('currentUser', JSON.stringify(result.user));
                    }
                    
                    alert('Registration successful! Welcome to Totilove!');
                    // Redirect to profile page since user is now logged in
                    window.location.href = '/profile';
                } else {
                    if (result.errors) {
                        result.errors.forEach(error => {
                            console.error('Registration error:', error);
                        });
                        alert('Registration failed: ' + result.errors.join(', '));
                    } else {
                        alert('Registration failed: ' + (result.error || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function validateForm() {
            let isValid = true;
            
            // Clear all errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-control, .form-select').forEach(el => el.classList.remove('error'));
            
            // Check all required fields
            const requiredFields = ['username', 'email', 'password', 'birthdate', 'gender', 'country', 'preferred_gender'];
            requiredFields.forEach(field => {
                const value = document.getElementById(field).value;
                if (!value) {
                    showError(field, 'This field is required');
                    isValid = false;
                }
            });
            
            // Validate birthdate age
            const birthdate = document.getElementById('birthdate').value;
            if (birthdate) {
                const age = calculateAge(new Date(birthdate));
                if (age < 18) {
                    showError('birthdate', 'You must be at least 18 years old');
                    isValid = false;
                }
            }
            
            // Validate age preferences
            const minAge = parseInt(document.getElementById('age_min').value);
            const maxAge = parseInt(document.getElementById('age_max').value);
            if (minAge > maxAge) {
                showError('age_max', 'Maximum age must be greater than minimum age');
                isValid = false;
            }
            
            return isValid;
        }

        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(fieldId + '-error');
            
            if (field) field.classList.add('error');
            if (errorEl) errorEl.textContent = message;
        }

        function clearError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(fieldId + '-error');
            
            if (field) field.classList.remove('error');
            if (errorEl) errorEl.textContent = '';
        }

        function calculateAge(birthDate) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }
    </script>
    <script src="/js/session.js"></script>
</body>
</html>
