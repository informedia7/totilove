<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Totilove</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Dynamic Navbar System -->
    <script src="/js/session.js"></script>
    <script src="/components/navbar-loader.js"></script>
    <script src="/components/navbar.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --dark-color: #2d3436;
            --light-color: #f5f6fa;
            --text-color: #333;
            --muted-color: #636e72;
            --white: #ffffff;
            --danger-color: #d63031;
            --success-color: #28a745;
            --warning-color: #fdcb6e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            padding-top: 80px;
        }

        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .profile-header {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 3rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .profile-info h1 {
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .profile-info .username {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--muted-color);
            font-size: 0.9rem;
        }

        .profile-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .profile-card {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            color: var(--dark-color);
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary-color);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid var(--light-color);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--muted-color);
            font-weight: 500;
        }

        .info-value {
            color: var(--dark-color);
            font-weight: 600;
        }

        .edit-btn {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .edit-btn:hover {
            background: #5a4fcf;
            transform: translateY(-2px);
        }

        .logout-btn {
            background: var(--danger-color);
            color: var(--white);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-online {
            background: var(--success-color);
            color: var(--white);
        }

        .status-offline {
            background: var(--muted-color);
            color: var(--white);
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            background: var(--white);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 1rem;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--muted-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn:hover {
            background: var(--light-color);
            color: var(--dark-color);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: var(--white);
        }

        /* Notification Badge Styles */
        .notification-badge {
            background: #ff4757 !important;
            color: white !important;
            font-size: 0.75rem !important;
            font-weight: bold !important;
            padding: 0.2rem 0.5rem !important;
            border-radius: 50px !important;
            min-width: 1.2rem !important;
            height: 1.2rem !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin-left: 0.5rem !important;
            position: relative !important;
            top: -2px !important;
            animation: pulse 2s infinite !important;
            box-shadow: 0 2px 6px rgba(255, 71, 87, 0.4) !important;
            z-index: 1000 !important;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 6px rgba(255, 71, 87, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 2px 8px rgba(255, 71, 87, 0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 6px rgba(255, 71, 87, 0.4);
            }
        }

        /* Individual message unread count */
        .unread-count {
            background: #ff4757;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 0.1rem 0.4rem;
            border-radius: 50px;
            min-width: 1rem;
            height: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.2rem;
        }

        .message-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.2rem;
        }

        .tab-content {
            margin-top: 1.5rem;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Online Users Styles */
        .online-users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .online-user-card {
            background: white;
            border-radius: 15px;
            overflow: hidden; /* Ensures images don't exceed card bounds */
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            min-height: 400px; /* Fixed height to prevent layout shift */
            position: relative; /* For better image positioning */
            /* Ensure card maintains aspect ratio */
            display: flex;
            flex-direction: column;
        }

        .online-user-card:hover {
            transform: translateY(-5px);
        }

        .user-avatar {
            width: 100%;
            height: 250px;
            object-fit: cover;
            cursor: pointer;
            background: #f0f0f0; /* Placeholder background */
            display: block; /* Prevent inline spacing issues */
            transition: opacity 0.3s ease; /* Smooth loading transition */
            /* Ensure crisp image quality */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            /* Add proper border radius for card top */
            border-radius: 15px 15px 0 0; /* Top corners rounded to match card */
            /* Ensure image fits exactly in card */
            max-width: 100%;
            max-height: 250px;
            border: none;
            outline: none;
        }

        .user-info {
            padding: 1.5rem;
            min-height: 150px; /* Fixed height for consistent layout */
            flex: 1; /* Take remaining space in flexbox */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .user-info h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        .user-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .user-location i {
            margin-right: 5px;
            color: #e74c3c;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-message {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-like {
            background: var(--secondary-color);
            color: var(--white);
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* Online Status Styles */
        .online-section {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .online-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 1rem;
        }

        .online-header h3 {
            color: var(--dark-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .online-count {
            color: var(--muted-color);
            font-weight: normal;
            font-size: 0.9rem;
        }

        .your-status {
            color: var(--muted-color);
            font-size: 0.9rem;
        }

        .user-status-indicator {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .user-status-indicator.online {
            background: rgba(0, 184, 148, 0.1);
            color: #00b894;
        }

        .user-status-indicator.offline {
            background: rgba(214, 48, 49, 0.1);
            color: #d63031;
        }

        .online-refresh {
            text-align: center;
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: var(--white);
            transform: translateY(-2px);
        }

        .user-last-seen {
            color: var(--muted-color);
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Search Styles */
        .search-filters {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 0.5rem;
            color: var(--dark-color);
            font-weight: 600;
        }

        .filter-input {
            padding: 0.8rem;
            border: 2px solid var(--light-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-btn {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #5a4fcf;
        }

        /* Messages Styles */
        .messages-container {
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .messages-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--light-color);
        }

        .messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .message-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .message-item:hover {
            background: var(--light-color);
        }

        .message-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
        }

        .message-content {
            flex: 1;
        }

        .message-name {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.3rem;
        }

        .message-preview {
            color: var(--muted-color);
            font-size: 0.9rem;
        }

        .message-time {
            color: var(--muted-color);
            font-size: 0.8rem;
        }

        /* Chat Modal Styles - Removed (now using dedicated chat page) */

        /* Activity Styles */
        .activity-feed {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--light-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1rem;
        }

        .activity-like {
            background: var(--secondary-color);
        }

        .activity-message {
            background: var(--primary-color);
        }

        .activity-view {
            background: var(--warning-color);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            color: var(--dark-color);
            margin-bottom: 0.3rem;
        }

        .activity-time {
            color: var(--muted-color);
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-content {
                grid-template-columns: 1fr;
            }

            .tab-buttons {
                flex-wrap: wrap;
            }

            .tab-btn {
                font-size: 0.9rem;
                padding: 0.6rem 1rem;
            }

            .online-users-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: var(--danger-color);
            color: var(--white);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-content {
                grid-template-columns: 1fr;
            }

            .profile-stats {
                justify-content: center;
            }
        }

        .distance-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .distance-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .distance-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .distance-checkbox label {
            font-size: 0.9rem;
            color: var(--text-color);
            cursor: pointer;
        }

        .distance-slider {
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: opacity 0.3s ease;
        }

        .distance-slider.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .distance-slider input[type="range"] {
            flex: 1;
        }

        .distance-slider span {
            min-width: 60px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        /* Country Selection Styles */
        .country-selection {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            width: 100%;
        }

        .selected-countries {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            min-height: 60px;
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            border: 2px solid var(--light-color);
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .selected-countries:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .selected-countries:empty::before {
            content: "No countries selected";
            color: var(--muted-color);
            font-style: italic;
            font-size: 0.9rem;
            position: absolute;
            top: 50%;
            left: 1rem;
            transform: translateY(-50%);
        }

        .country-tag {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, #0084d1 100%);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .country-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
        }

        .country-tag.all-countries {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #e55347 100%);
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
        }

        .country-tag.all-countries:hover {
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
        }

        .remove-country {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            margin-left: 0.3rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .remove-country:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .remove-country:active {
            transform: scale(0.95);
        }

        .loading-countries {
            color: var(--muted-color);
            font-size: 0.8rem;
            padding: 0.5rem;
        }

        /* Enhanced dropdown for country selection */
        .country-selection .filter-input {
            max-width: 300px;
            margin-top: 0.5rem;
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .country-selection .filter-input:focus {
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- Navbar will be dynamically loaded here -->

    <div class="profile-container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>

        <div id="error-container" style="display: none;">
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="error-text">Failed to load profile data</span>
            </div>
        </div>

        <div id="profile-content" style="display: none;">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-avatar" id="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <h1 id="display-name">Loading...</h1>
                    <div class="username">@<span id="username">loading</span></div>
                    <div class="status-badge status-online" id="status">
                        <i class="fas fa-circle"></i> Online
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="age">--</div>
                            <div class="stat-label">Age</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="member-since">--</div>
                            <div class="stat-label">Member Since</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="last-active">--</div>
                            <div class="stat-label">Last Active</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="profile">
                        <i class="fas fa-user"></i>
                        Profile
                    </button>
                    <button class="tab-btn" data-tab="online">
                        <i class="fas fa-circle" style="color: #00b894;"></i>
                        Online
                    </button>
                    <button class="tab-btn" data-tab="matches">
                        <i class="fas fa-heart"></i>
                        Matches
                    </button>
                    <button class="tab-btn" data-tab="search">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                    <button class="tab-btn" data-tab="messages">
                        <i class="fas fa-envelope"></i>
                        Messages
                        <span class="notification-badge" id="messages-badge" style="display: none;">0</span>
                    </button>
                    <button class="tab-btn" data-tab="activity">
                        <i class="fas fa-bell"></i>
                        Activity
                    </button>
                    <button class="tab-btn" data-tab="settings">
                        <i class="fas fa-cog"></i>
                        Settings
                    </button>
                </div>

                <div class="tab-content">
                    <!-- Profile Tab -->
                    <div class="tab-panel active" id="profile-tab">
                        <!-- Profile Content -->
                        <div class="profile-content">
                            <!-- Personal Information -->
                            <div class="profile-card">
                    <h2 class="card-title">
                        <i class="fas fa-user"></i>
                        Personal Information
                    </h2>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value" id="email">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Profile ID</span>
                        <span class="info-value" id="user-id">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Gender</span>
                        <span class="info-value" id="gender">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Birthdate</span>
                        <span class="info-value" id="birthdate">--</span>
                    </div>
                    <button class="edit-btn" onclick="editProfile()">
                        <i class="fas fa-edit"></i>
                        Edit Profile
                    </button>
                </div>

                <!-- Location Information -->
                <div class="profile-card">
                    <h2 class="card-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Location
                    </h2>
                    <div class="info-item">
                        <span class="info-label">Country</span>
                        <span class="info-value" id="country">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">State</span>
                        <span class="info-value" id="state">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">City</span>
                        <span class="info-value" id="city">--</span>
                    </div>
                </div>
                        </div>
                    </div>

                    <!-- Online Tab -->
                    <div class="tab-panel" id="online-tab">
                        <div class="online-section">
                            <div class="online-header">
                                <h3>
                                    <i class="fas fa-circle" style="color: #00b894;"></i>
                                    Online Users
                                    <span class="online-count" id="online-count">(0)</span>
                                </h3>
                                <div class="your-status">
                                    Your Status: <span class="user-status-indicator online">ðŸŸ¢ Online</span>
                                </div>
                            </div>
                            <div class="online-users-grid" id="online-users">
                                <div class="loading">Loading online users...</div>
                            </div>
                            <div class="online-refresh">
                                <button onclick="refreshOnlineUsers()" class="btn-secondary">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Matches Tab -->
                    <div class="tab-panel" id="matches-tab">
                        <div class="online-users-grid" id="matches-users">
                            <div class="loading">Loading your matches...</div>
                        </div>
                    </div>

                    <!-- Search Tab -->
                    <div class="tab-panel" id="search-tab">
                        <div class="search-filters">
                            <h3 style="margin-bottom: 1rem; color: var(--dark-color);">
                                <i class="fas fa-search"></i> Find Your Perfect Match
                            </h3>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="search-age-min">Min Age</label>
                                    <input type="number" id="search-age-min" class="filter-input" min="18" max="100" value="18">
                                </div>
                                <div class="filter-group">
                                    <label for="search-age-max">Max Age</label>
                                    <input type="number" id="search-age-max" class="filter-input" min="18" max="100" value="50">
                                </div>
                                <div class="filter-group">
                                    <label for="search-gender">Gender</label>
                                    <select id="search-gender" class="filter-input">
                                        <option value="">Any</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="search-location">Location</label>
                                    <input type="text" id="search-location" class="filter-input" placeholder="Enter city or country">
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="search-radius">Distance</label>
                                    <div class="distance-options">
                                        <div class="distance-checkbox">
                                            <input type="checkbox" id="any-distance" onchange="toggleDistanceMode()">
                                            <label for="any-distance">Any Distance</label>
                                        </div>
                                        <div class="distance-slider" id="distance-slider-container">
                                            <input type="range" id="search-radius" class="filter-input" min="1" max="500" value="50">
                                            <span id="radius-value">50 km</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <label for="with-images">Profile Images</label>
                                    <div class="distance-checkbox">
                                        <input type="checkbox" id="with-images" checked>
                                        <label for="with-images">Only users with photos</label>
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <button class="search-btn" onclick="performSearch()">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </div>
                            <div class="search-results-header" id="search-results-header" style="display: none;">
                                <h4 style="color: var(--dark-color); margin: 1rem 0;">
                                    <i class="fas fa-users"></i> <span id="search-count">0</span> users found
                                </h4>
                            </div>
                        </div>
                        <div class="online-users-grid" id="search-results">
                            <div style="text-align: center; color: var(--muted-color); padding: 2rem;">
                                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>Use the filters above to find your perfect match!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab -->
                    <div class="tab-panel" id="activity-tab">
                        <div class="activity-feed">
                            <h3 style="margin-bottom: 1.5rem; color: var(--dark-color);">
                                <i class="fas fa-bell"></i> Recent Activity
                            </h3>
                            <div id="activity-list">
                                <div class="loading">Loading activity...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-panel" id="settings-tab">
                        <div class="profile-content">
                            <!-- Account Settings -->
                            <div class="profile-card">
                                <h2 class="card-title">
                                    <i class="fas fa-cog"></i>
                                    Account Settings
                                </h2>
                                <div class="info-item">
                                    <span class="info-label">Profile ID</span>
                                    <span class="info-value" id="settings-user-id">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Account Status</span>
                                    <span class="info-value status-badge status-online">Active</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Profile Visibility</span>
                                    <select class="filter-input" id="profile-visibility" style="max-width: 200px;">
                                        <option value="public">Public</option>
                                        <option value="private">Private</option>
                                        <option value="friends">Friends Only</option>
                                    </select>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Email Notifications</span>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="email-notifications" checked>
                                        <span>Receive email notifications</span>
                                    </label>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Show Online Status</span>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="show-online-status" checked>
                                        <span>Show when I'm online</span>
                                    </label>
                                </div>
                                <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--light-color);">
                                <h3 style="color: var(--dark-color); margin-bottom: 1rem; font-size: 1.1rem;">
                                    <i class="fas fa-shield-alt"></i> Who Can Contact Me
                                </h3>
                                <div class="info-item">
                                    <span class="info-label">From Countries <span id="country-counter" style="font-size: 0.9em; color: var(--secondary-color);">(1/10)</span></span>
                                    <div class="country-selection">
                                        <div class="selected-countries" id="selected-countries">
                                            <div class="country-tag" data-country="all">
                                                <span>All Countries</span>
                                                <button type="button" class="remove-country" onclick="removeCountry('all')">Ã—</button>
                                            </div>
                                        </div>
                                        <select id="allowed-countries" class="filter-input" onchange="addCountry(this)">
                                            <option value="">Select a country...</option>
                                        </select>
                                        <div class="loading-countries" id="loading-countries" style="display: none; color: var(--muted-color); font-size: 0.8rem;">
                                            Loading countries...
                                        </div>
                                    </div>
                                    <small style="color: var(--muted-color); font-size: 0.8rem; margin-top: 0.3rem; display: block;">
                                        Select countries from the dropdown above
                                    </small>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Age Range</span>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <div style="display: flex; flex-direction: column; gap: 0.3rem;">
                                            <label style="font-size: 0.8rem; color: var(--muted-color);">From</label>
                                            <input type="number" id="contact-age-min" class="filter-input" min="18" max="100" value="18" style="width: 80px;">
                                        </div>
                                        <span style="color: var(--muted-color);">to</span>
                                        <div style="display: flex; flex-direction: column; gap: 0.3rem;">
                                            <label style="font-size: 0.8rem; color: var(--muted-color);">To</label>
                                            <input type="number" id="contact-age-max" class="filter-input" min="18" max="100" value="65" style="width: 80px;">
                                        </div>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Require Photos</span>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="require-photos">
                                        <span>Only users with profile photos can contact me</span>
                                    </label>
                                </div>
                                <button class="edit-btn" onclick="saveAccountSettings()" style="width: 100%; margin-top: 1rem;">
                                    <i class="fas fa-save"></i>
                                    Save Settings
                                </button>
                            </div>

                            <!-- Quick Actions -->
                            <div class="profile-card">
                                <h2 class="card-title">
                                    <i class="fas fa-bolt"></i>
                                    Quick Actions
                                </h2>
                                <button class="edit-btn" onclick="editProfile()" style="width: 100%; margin-bottom: 1rem;">
                                    <i class="fas fa-edit"></i>
                                    Edit Profile
                                </button>
                                <button class="edit-btn" onclick="changePassword()" style="width: 100%; margin-bottom: 1rem;">
                                    <i class="fas fa-key"></i>
                                    Change Password
                                </button>
                                <button class="edit-btn" onclick="privacySettings()" style="width: 100%; margin-bottom: 1rem;">
                                    <i class="fas fa-shield-alt"></i>
                                    Privacy Settings
                                </button>
                                <button class="edit-btn" onclick="exportData()" style="width: 100%; margin-bottom: 1rem;">
                                    <i class="fas fa-download"></i>
                                    Export My Data
                                </button>
                                <button class="edit-btn" onclick="deleteAccount()" style="width: 100%; margin-bottom: 1rem; background: var(--danger-color);">
                                    <i class="fas fa-trash"></i>
                                    Delete Account
                                </button>
                                <button class="logout-btn" onclick="logout()" style="width: 100%;">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal removed - now using dedicated chat page -->

    <!-- Load session-manager.js first, before any inline scripts that use it -->
    <link rel="stylesheet" href="/assets/css/loading-animations.css">
    <script src="/js/session-manager.js"></script>
    <script src="/js/online-status.js"></script>
    <script>
        let currentUser = null;

        // Initialize profile page
        document.addEventListener('DOMContentLoaded', function() {
            
            // Wait for SessionManager to be available
            function initializeProfilePage() {
                // Check if SessionManager is available
                if (!window.sessionManager) {
                    setTimeout(initializeProfilePage, 100);
                    return;
                }
                
                
                // Check if user is logged in using SessionManager
                if (!window.sessionManager.isAuthenticated()) {
                    window.location.href = '/login?return=' + encodeURIComponent(window.location.href);
                    return;
                }
                
                // Get current user from SessionManager
                const currentUser = window.sessionManager.getCurrentUser();
                if (!currentUser) {
                    window.location.href = '/login?return=' + encodeURIComponent(window.location.href);
                    return;
                }
                
                // Update global currentUser variable
                window.currentUser = currentUser;
                
                // Initialize page components
                initializeTabs();
                
                // Setup session manager for dynamic navbar authentication
                if (!window.sessionManager && window.SessionManager) {
                    window.sessionManager = new SessionManager();
                }
                
                // Initialize online status tracking
                if (typeof onlineStatus !== 'undefined') {
                    onlineStatus.startHeartbeat();
                }
                
                // Load profile data
                loadUserProfile();
                
                // Load contact countries
                const user = window.sessionManager ? window.sessionManager.getCurrentUser() : window.currentUser;
                if (user && user.id) {
                    loadUserContactCountries();
                }
                
                // Load online users immediately when page loads
                loadOnlineUsers();
                
                // Force show badge immediately for testing
                updateMessagesBadge(67);
                
                // Load messages badge count on page load
                loadMessagesBadgeCount();
                
                // Listen for message count updates from chat page
                window.addEventListener('storage', function(e) {
                    if (e.key === 'messageCountUpdated') {
                        loadMessagesBadgeCount();
                    }
                });
                
                // Refresh message count when window gains focus
                window.addEventListener('focus', function() {
                    loadMessagesBadgeCount();
                });
                
                // Test badge display - force show with 67
                setTimeout(() => {
                    updateMessagesBadge(67);
                }, 2000);
            }
            
            // Start the initialization
            initializeProfilePage();
        });        function loadUserProfile() {
            showLoading();
            
            try {
                // Get current user from SessionManager
                const user = window.sessionManager ? window.sessionManager.getCurrentUser() : window.currentUser;
                if (!user || !user.id) {
                    showError('No user data found. Please login again.');
                    // Immediate redirect - no delay needed for better navigation speed
                    window.location.href = '/login';
                    return;
                }

                // Use SessionManager for authenticated API requests
                if (window.sessionManager) {
                    window.sessionManager.apiRequest(`/api/user/${user.id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                displayUserProfile(data.user);
                                hideLoading();
                            } else {
                                showError(data.error || 'Failed to load profile');
                                hideLoading();
                            }
                        })
                        .catch(error => {
                            console.error('âŒ Profile loading error:', error);
                            if (error.message.includes('Authentication expired')) {
                                window.location.href = '/login?return=' + encodeURIComponent(window.location.href);
                            } else {
                                showError('Failed to load profile: ' + error.message);
                                hideLoading();
                            }
                        });
                } else {
                    // Fallback to direct fetch - shouldn't happen with SessionManager
                    fetch(`/api/user/${user.id}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Server responded with status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                displayUserProfile(data.user);
                                hideLoading();
                            } else {
                                showError(data.error || 'Failed to load profile');
                                hideLoading();
                            }
                        })
                        .catch(error => {
                            if (error.message.includes('Failed to fetch')) {
                                showError('Network connection error. Please check your internet connection and try again.');
                            } else if (error.message.includes('Server responded')) {
                                showError('Server error. Please try again later.');
                            } else {
                                showError('Unable to load profile. Please try again.');
                            }
                            hideLoading();
                        });
                }
            } catch (error) {
                showError('Failed to load profile. Please try again.');
                hideLoading();
            }
        }

        function updateCountryCounter() {
            const counter = document.getElementById('country-counter');
            if (!counter) return;
            
            const specificCountries = selectedCountries.filter(code => code !== 'all');
            const count = selectedCountries.includes('all') ? 'All' : specificCountries.length;
            const maxCount = selectedCountries.includes('all') ? '' : '/10';
            
            counter.textContent = `(${count}${maxCount})`;
            
            // Change color based on limit
            if (specificCountries.length >= 8 && !selectedCountries.includes('all')) {
                counter.style.color = '#e74c3c'; // Red when approaching limit
            } else {
                counter.style.color = 'var(--secondary-color)';
            }
        }

        function addCountryTag(countryCode, countryName) {
            const container = document.getElementById('selected-countries');
            if (!container) {
                console.error('Selected countries container not found');
                return;
            }
            
            const tag = document.createElement('div');
            tag.className = countryCode === 'all' ? 'country-tag all-countries' : 'country-tag';
            tag.setAttribute('data-country', countryCode);
            tag.innerHTML = `
                <span>${countryName}</span>
                <button type="button" class="remove-country" onclick="removeCountry('${countryCode}')">Ã—</button>
            `;
            
            container.appendChild(tag);
        }

        async function loadUserContactCountries() {
            try {
                // Get user ID from SessionManager
                const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : window.currentUser;
                const userId = currentUser ? currentUser.id : null;
                
                if (!userId || isNaN(userId)) {
                    return;
                }

                const response = await fetch(`/api/contact-countries/${userId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.countries && data.countries.length > 0) {
                        // Clear current selection
                        selectedCountries = [];
                        
                        // Clear existing country tags
                        const container = document.getElementById('selected-countries');
                        if (container) {
                            container.innerHTML = '';
                        }
                        
                        // Check if user has "All Countries" selected
                        const hasAllCountries = data.countries.some(country => country.is_all_countries);
                        
                        if (hasAllCountries) {
                            selectedCountries = ['all'];
                            // Add "All Countries" tag
                            addCountryTag('all', 'All Countries');
                        } else {
                            // Add specific countries using country_id instead of country_code
                            data.countries.forEach(country => {
                                if (country.country_id) {
                                    selectedCountries.push(country.country_id.toString());
                                    addCountryTag(country.country_id.toString(), country.country_name);
                                }
                            });
                        }
                        
                        // Update the country counter
                        updateCountryCounter();
                    } else {
                        updateCountryCounter();
                    }
                } else {
                    console.error('Failed to load contact countries:', response.status);
                }
            } catch (error) {
            }
        }

        function displayUserProfile(user) {
            try {
                // Basic info
                const username = document.getElementById('username');
                if (username) username.textContent = user.username || 'Unknown';
                
                const displayName = document.getElementById('display-name');
                if (displayName) displayName.textContent = user.username || 'Unknown User';
                
                const email = document.getElementById('email');
                if (email) email.textContent = user.email || 'Not provided';
                
                const gender = document.getElementById('gender');
                if (gender) gender.textContent = capitalizeFirst(user.gender) || 'Not specified';
                
                const userId = document.getElementById('user-id');
                if (userId) userId.textContent = user.id || '--';
                
                const settingsUserId = document.getElementById('settings-user-id');
                if (settingsUserId) settingsUserId.textContent = user.id || '--';

                // Location
                const country = document.getElementById('country');
                if (country) country.textContent = user.country || 'Not specified';
                
                const state = document.getElementById('state');
                if (state) state.textContent = user.state || 'Not specified';
                
                const city = document.getElementById('city');
                if (city) city.textContent = user.city || 'Not specified';

                // Dates and age
                if (user.birthdate) {
                    const birthdate = new Date(user.birthdate);
                    const birthdateEl = document.getElementById('birthdate');
                    if (birthdateEl) birthdateEl.textContent = birthdate.toLocaleDateString();
                    
                    const ageEl = document.getElementById('age');
                    if (ageEl) ageEl.textContent = calculateAge(birthdate);
                }

                if (user.date_joined) {
                    const joinDate = new Date(user.date_joined);
                    const memberSince = document.getElementById('member-since');
                    if (memberSince) memberSince.textContent = formatDate(joinDate);
                }

                if (user.last_login) {
                    const lastLogin = new Date(user.last_login);
                    const lastActive = document.getElementById('last-active');
                    if (lastActive) lastActive.textContent = formatRelativeTime(lastLogin);
                }

                // Avatar with first letter of username
                const avatar = document.getElementById('avatar');
                if (avatar && user.username) {
                    avatar.innerHTML = user.username.charAt(0).toUpperCase();
                }
                
            } catch (error) {
                throw error; // Re-throw so the caller can handle it
            }
        }

        function getUserIdFromSession() {
            const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : window.currentUser;
            return currentUser ? currentUser.id : null;
        }

        function calculateAge(birthdate) {
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
                age--;
            }
            
            return age;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short' 
            });
        }

        function formatRelativeTime(date) {
            // Handle invalid dates and various timestamp formats
            
            if (!date) {
                return 'Unknown time';
            }
            
            let validDate;
            if (typeof date === 'number') {
                // If it's a timestamp (number), convert to Date
                validDate = new Date(date < 10000000000 ? date * 1000 : date);
            } else if (typeof date === 'string') {
                // Try to parse string as number first (handles numeric strings like "1752932389675.914000")
                const numericValue = parseFloat(date);
                if (!isNaN(numericValue)) {
                    // It's a numeric string, treat as timestamp
                    validDate = new Date(numericValue < 10000000000 ? numericValue * 1000 : numericValue);
                } else {
                    // Try to parse as regular date string
                    validDate = new Date(date);
                }
            } else if (date instanceof Date) {
                validDate = date;
            } else {
                return 'Invalid date';
            }
            
            // Check if the date is valid
            if (isNaN(validDate.getTime())) {
                return 'Invalid date';
            }
            
            const now = new Date();
            const diff = now - validDate;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            // Handle future dates (negative days) or past dates - show as time for recent messages
            if (days < 0 || Math.abs(days) <= 1) {
                const hours = validDate.getHours();
                const minutes = validDate.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${displayHours}:${minutes} ${ampm}`;
            }
            
            // For older dates
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            if (days < 365) return `${Math.floor(days / 30)} months ago`;
            return `${Math.floor(days / 365)} years ago`;
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('profile-content').style.display = 'none';
            document.getElementById('error-container').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profile-content').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-container').style.display = 'block';
        }

        // Action functions
        function editProfile() {
            alert('Edit profile functionality coming soon!');
            // TODO: Implement edit profile modal or redirect to edit page
        }

        function changePassword() {
            alert('Change password functionality coming soon!');
            // TODO: Implement change password modal
        }

        function privacySettings() {
            alert('Privacy settings functionality coming soon!');
            // TODO: Implement privacy settings page
        }

        function findMatches() {
            window.location.href = '/matches';
        }

        function logout() {
            console.log('ðŸ”„ Logout initiated...');
            
            // Show immediate loading feedback
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
                logoutBtn.disabled = true;
                console.log('âœ… Logout button updated with loading state');
            }
            
            try {
                // Check if sessionManager exists
                if (!window.sessionManager) {
                    console.error('âŒ SessionManager not found, redirecting manually...');
                    window.location.href = '/pages/login.html';
                    return;
                }
                
                // Clear session and redirect immediately - don't wait for API call
                console.log('ðŸ”„ Calling sessionManager.logout()...');
                window.sessionManager.logout(); // This is async but we don't wait
                
                // Add a delay to show the logout process for better UX
                console.log('ðŸ”„ Redirecting to login in 1 second...');
                setTimeout(() => {
                    window.location.href = '/pages/login.html';
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Error during logout:', error);
                // Force redirect to login page with delay for consistency
                setTimeout(() => {
                    window.location.href = '/pages/login.html';
                }, 1000);
            }
        }

        function handleLogout(event) {
            console.log('ðŸ”„ handleLogout called...');
            event.preventDefault();
            logout();
        }

        // Tab functionality
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Redirect to chat page for messages
                    if (tabId === 'messages') {
                        window.location.href = '/pages/chat.html';
                        return;
                    }
                    
                    // Remove active class from all buttons and panels
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding panel
                    button.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Load tab content based on tab type
                    loadTabContent(tabId);
                });
            });
        }

        function loadTabContent(tabId) {
            switch(tabId) {
                case 'online':
                    loadOnlineUsers();
                    break;
                case 'matches':
                    loadMatches();
                    break;
                case 'search':
                    initializeSearch();
                    break;
                case 'activity':
                    loadActivity();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        async function loadOnlineUsers() {
            const container = document.getElementById('online-users');
            container.innerHTML = '<div class="loading">Loading online users...</div>';
            
            try {
                const response = await fetch('/api/online-users');
                const data = await response.json();
                
                if (data.success && data.users.length > 0) {
                    container.innerHTML = data.users.map(user => `
                        <div class="online-user-card">
                            <div class="user-avatar">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                            <div class="user-info">
                                <h4>${user.username}, ${calculateAge(new Date(user.birthdate))}</h4>
                                <p class="user-location">
                                    <i class="fas fa-map-marker-alt"></i> ${user.country || 'Unknown'}
                                </p>
                                <div class="user-actions">
                                    <button class="action-btn btn-message" onclick="openConversation(${user.id})">
                                        <i class="fas fa-envelope"></i> Message
                                    </button>
                                    <button class="action-btn btn-like" onclick="likeUser(${user.id})">
                                        <i class="fas fa-heart"></i> Like
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--muted-color); padding: 2rem;">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No users online right now</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading online users:', error);
                container.innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <p>Failed to load online users</p>
                    </div>
                `;
            }
        }

        async function loadMatches() {
            const container = document.getElementById('matches-users');
            container.innerHTML = '<div class="loading">Loading your matches...</div>';
            
            try {
                const userId = getUserIdFromSession();
                const response = await fetch(`/api/matches/${userId}`);
                const data = await response.json();
                
                if (data.success && data.matches.length > 0) {
                    container.innerHTML = data.matches.map(user => `
                        <div class="online-user-card">
                            <div class="user-avatar">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                            <div class="user-info">
                                <h4>${user.username}, ${calculateAge(new Date(user.birthdate))}</h4>
                                <p class="user-location">
                                    <i class="fas fa-map-marker-alt"></i> ${user.country || 'Unknown'}
                                </p>
                                <div class="user-actions">
                                    <button class="action-btn btn-message" onclick="openConversation(${user.id})">
                                        <i class="fas fa-envelope"></i> Message
                                    </button>
                                    <button class="action-btn btn-like" onclick="viewProfile(${user.id})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--muted-color); padding: 2rem;">
                            <i class="fas fa-heart" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No matches yet. Keep exploring!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading matches:', error);
                container.innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <p>Failed to load matches</p>
                    </div>
                `;
            }
        }

        function initializeSearch() {
            const radiusSlider = document.getElementById('search-radius');
            const radiusValue = document.getElementById('radius-value');
            
            if (radiusSlider && radiusValue) {
                radiusSlider.addEventListener('input', function() {
                    radiusValue.textContent = `${this.value} km`;
                });
            }
        }

        function toggleDistanceMode() {
            const anyDistanceCheckbox = document.getElementById('any-distance');
            const distanceSliderContainer = document.getElementById('distance-slider-container');
            
            if (anyDistanceCheckbox.checked) {
                distanceSliderContainer.classList.add('disabled');
            } else {
                distanceSliderContainer.classList.remove('disabled');
            }
        }

        async function performSearch() {
            const ageMin = document.getElementById('search-age-min').value;
            const ageMax = document.getElementById('search-age-max').value;
            const gender = document.getElementById('search-gender').value;
            const location = document.getElementById('search-location').value;
            const anyDistance = document.getElementById('any-distance').checked;
            const radius = anyDistance ? 'unlimited' : document.getElementById('search-radius').value;
            const withImages = document.getElementById('with-images').checked;
            
            const container = document.getElementById('search-results');
            const resultsHeader = document.getElementById('search-results-header');
            const searchCount = document.getElementById('search-count');
            
            container.innerHTML = '<div class="loading">Searching...</div>';
            resultsHeader.style.display = 'none';
            
            try {
                const params = new URLSearchParams({
                    age_min: ageMin,
                    age_max: ageMax,
                    gender: gender,
                    location: location,
                    radius: radius,
                    with_images: withImages ? '1' : '0'
                });
                
                const response = await fetch(`/api/search?${params}`);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    // Filter results based on "with images" setting
                    let filteredResults = data.results;
                    if (withImages) {
                        filteredResults = data.results.filter(user => 
                            user.profile_image && 
                            user.profile_image !== '' && 
                            user.profile_image !== 'default_profile.svg'
                        );
                    }
                    
                    // Show results count
                    searchCount.textContent = filteredResults.length;
                    resultsHeader.style.display = 'block';
                    
                    if (filteredResults.length > 0) {
                        container.innerHTML = filteredResults.map(user => {
                            // Construct image URL - only real photos since we filtered
                            const imageUrl = user.profile_image 
                                ? `/uploads/profile_images/${user.profile_image}` 
                                : '/assets/images/default_profile.svg';
                            
                            return `
                                <div class="online-user-card">
                                    <img src="${imageUrl}" 
                                         alt="${user.username}'s profile" 
                                         class="user-avatar"
                                         onerror="this.src='/assets/images/default_profile.svg'"
                                         loading="lazy">
                                    <div class="user-info">
                                        <h4>${user.username}, ${calculateAge(new Date(user.birthdate))}</h4>
                                        <p class="user-location">
                                            <i class="fas fa-map-marker-alt"></i> ${user.country || 'Unknown'}
                                        </p>
                                        <div class="user-actions">
                                            <button class="action-btn btn-message" onclick="openConversation(${user.id})">
                                                <i class="fas fa-envelope"></i> Message
                                            </button>
                                            <button class="action-btn btn-like" onclick="likeUser(${user.id})">
                                                <i class="fas fa-heart"></i> Like
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; color: var(--muted-color); padding: 2rem;">
                                <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>No users found with photos matching your criteria.</p>
                                <p style="font-size: 0.9rem; margin-top: 1rem;">Try unchecking "Only users with photos" or adjusting other filters.</p>
                            </div>
                        `;
                    }
                } else {
                    // Show "no results" count
                    searchCount.textContent = '0';
                    resultsHeader.style.display = 'block';
                    
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--muted-color); padding: 2rem;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No results found. Try adjusting your search criteria.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error performing search:', error);
                resultsHeader.style.display = 'none';
                container.innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <p>Search failed. Please try again.</p>
                    </div>
                `;
            }
        }

        function updateMessagesBadge(count) {
            const badge = document.getElementById('messages-badge');
            
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count.toString();
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        async function loadMessagesBadgeCount() {
            try {
                const userId = getUserIdFromSession();
                
                // Use sessionManager for authenticated API request to get unread message count
                const response = await window.sessionManager.apiRequest(`/api/messages/count?user_id=${userId}`);
                
                if (response.success) {
                    // Update the messages badge with unread count
                    const unreadCount = response.unread_count || 0;
                    updateMessagesBadge(unreadCount);
                } else {
                    updateMessagesBadge(0);
                }
            } catch (error) {
                // Don't show badge on error
                updateMessagesBadge(0);
            }
        }

        async function loadActivity() {
            const container = document.getElementById('activity-list');
            container.innerHTML = '<div class="loading">Loading activity...</div>';
            
            try {
                const userId = getUserIdFromSession();
                const response = await fetch(`/api/activity/${userId}`);
                const data = await response.json();
                
                if (data.success && data.activities.length > 0) {
                    container.innerHTML = data.activities.map(activity => {
                        const iconClass = activity.type === 'like' ? 'fa-heart' : 
                                        activity.type === 'message' ? 'fa-envelope' : 'fa-eye';
                        const activityClass = `activity-${activity.type}`;
                        
                        return `
                            <div class="activity-item">
                                <div class="activity-icon ${activityClass}">
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-text">${activity.description}</div>
                                    <div class="activity-time">${formatRelativeTime(new Date(activity.created_at))}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--muted-color); padding: 2rem;">
                            <i class="fas fa-bell" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                container.innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <p>Failed to load activity</p>
                    </div>
                `;
            }
        }

        // Action functions for user interactions
        function sendMessage(userId) {
            alert(`Message functionality for user ${userId} coming soon!`);
            // TODO: Implement messaging system
        }

        function likeUser(userId) {
            alert(`Like functionality for user ${userId} coming soon!`);
            // TODO: Implement like system
        }

        function viewProfile(userId) {
            // For now, show an alert since we can't navigate to other users' profiles
            // In a full implementation, this would show a user details modal or navigate to a public profile view
            alert(`Viewing profile for user ${userId} - Feature coming soon!`);
            // TODO: Implement user profile viewing (different from own profile editing)
        }

        // Simplified: Redirect to dedicated chat page
        function openConversation(userId) {
            window.location.href = `/pages/chat.html?user=${userId}`;
        }

        // Remove unused modal function
        function closeChatModal() {
            // Function kept for compatibility but not needed anymore
        }

        // Chat functions removed - now using dedicated chat page at /pages/chat.html

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadSettings() {
            // Settings are loaded when user profile is loaded
            // Just populate the user ID in the settings tab
            if (currentUser) {
                document.getElementById('settings-user-id').textContent = currentUser.id || '--';
            }
            
            // Load countries from database
            loadCountriesFromDatabase();
        }

        // Country selection management
        let selectedCountries = ['all']; // Start with "All Countries" selected
        let allCountries = []; // Store all countries for searching

        async function loadCountriesFromDatabase() {
            const dropdown = document.getElementById('allowed-countries');
            const loadingElement = document.getElementById('loading-countries');
            
            try {
                loadingElement.style.display = 'block';
                
                const response = await fetch('/api/countries');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const countries = data.countries || data;
                    if (Array.isArray(countries) && countries.length > 0) {
                        // Store all countries for searching
                        allCountries = countries.sort((a, b) => a.name.localeCompare(b.name));
                        
                        // Load all countries
                        loadCountriesInDropdown(allCountries);
                    } else {
                        loadFallbackCountries();
                    }
                } else {
                    loadFallbackCountries();
                }
            } catch (error) {
                loadFallbackCountries();
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        function loadCountriesInDropdown(countries) {
            const dropdown = document.getElementById('allowed-countries');
            dropdown.innerHTML = '<option value="">Select a country...</option>';
            
            // Add "All Countries" option first
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'All Countries';
            dropdown.appendChild(allOption);
            
            // Add countries to dropdown
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.id;
                option.textContent = country.name;
                dropdown.appendChild(option);
            });
        }

        function loadFallbackCountries() {
            const dropdown = document.getElementById('allowed-countries');
            dropdown.innerHTML = '<option value="">Select a country...</option>';
            
            // Add "All Countries" option first
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'All Countries';
            dropdown.appendChild(allOption);
            
            // Add fallback countries
            const fallbackCountries = [
                { id: 'US', name: 'United States' },
                { id: 'CA', name: 'Canada' },
                { id: 'GB', name: 'United Kingdom' },
                { id: 'AU', name: 'Australia' },
                { id: 'DE', name: 'Germany' },
                { id: 'FR', name: 'France' },
                { id: 'IT', name: 'Italy' },
                { id: 'ES', name: 'Spain' },
                { id: 'JP', name: 'Japan' },
                { id: 'BR', name: 'Brazil' }
            ];
            
            fallbackCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.id;
                option.textContent = country.name;
                dropdown.appendChild(option);
            });
        }

        function addCountry(selectElement) {
            const countryCode = selectElement.value;
            const countryName = selectElement.options[selectElement.selectedIndex].text;
            
            // Early validation
            if (!countryCode) {
                selectElement.value = '';
                return;
            }
            
            // Check if country is already selected (prevent duplicates)
            if (selectedCountries.includes(countryCode)) {
                selectElement.value = '';
                return;
            }
            
            // If adding "All Countries", remove all specific countries first
            if (countryCode === 'all') {
                // Clear all existing selections
                const container = document.getElementById('selected-countries');
                container.innerHTML = '';
                selectedCountries = [];
                
                // Show all options in dropdown again
                const dropdown = document.getElementById('allowed-countries');
                const options = dropdown.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value && option.value !== 'all') {
                        option.style.display = 'block';
                    }
                });
            } else {
                
                // Check 10-country limit for specific countries
                const currentSpecificCountries = selectedCountries.filter(code => code !== 'all');
                if (currentSpecificCountries.length >= 10) {
                    alert('Maximum 10 countries allowed. Please remove some countries before adding new ones.');
                    selectElement.value = '';
                    return;
                }
                
                // If "All Countries" is selected and we're adding a specific country, remove "All Countries"
                if (selectedCountries.includes('all')) {
                    // Remove "All Countries" from the array
                    selectedCountries = selectedCountries.filter(code => code !== 'all');
                    
                    // Remove "All Countries" tag from UI
                    const allCountryTag = document.querySelector('[data-country="all"]');
                    if (allCountryTag) {
                        allCountryTag.remove();
                    }
                }
            }
            
            // Add the new country to the array
            selectedCountries.push(countryCode);
            
            // Create and add the country tag
            const container = document.getElementById('selected-countries');
            const tag = document.createElement('div');
            tag.className = countryCode === 'all' ? 'country-tag all-countries' : 'country-tag';
            tag.setAttribute('data-country', countryCode);
            tag.innerHTML = `
                <span>${countryName}</span>
                <button type="button" class="remove-country" onclick="removeCountry('${countryCode}')">Ã—</button>
            `;
            
            container.appendChild(tag);
            
            // Reset the dropdown
            selectElement.value = '';
            
            // Hide the selected option from dropdown to prevent duplicates
            const option = selectElement.querySelector(`option[value="${countryCode}"]`);
            if (option) {
                option.style.display = 'none';
            }
            
            // Hide "All Countries" option when specific countries are selected
            if (countryCode !== 'all' && selectedCountries.length > 0) {
                const allOption = selectElement.querySelector('option[value="all"]');
                if (allOption) {
                    allOption.style.display = 'none';
                }
            }
            
            // Update the country counter
            updateCountryCounter();
        }

        function removeCountry(countryCode) {
            // Remove from selected countries array
            selectedCountries = selectedCountries.filter(code => code !== countryCode);
            
            // Remove the tag from UI
            const tag = document.querySelector(`[data-country="${countryCode}"]`);
            if (tag) {
                tag.remove();
            }
            
            // Show the option in dropdown again (except for "all" when other countries are selected)
            const dropdown = document.getElementById('allowed-countries');
            const option = dropdown.querySelector(`option[value="${countryCode}"]`);
            if (option) {
                if (countryCode === 'all') {
                    // Show "All Countries" option only if no specific countries are selected
                    if (selectedCountries.length === 0) {
                        option.style.display = 'block';
                    }
                } else {
                    option.style.display = 'block';
                    // Show "All Countries" option when we have specific countries
                    const allOption = dropdown.querySelector('option[value="all"]');
                    if (allOption) {
                        allOption.style.display = 'block';
                    }
                }
            }
            
            // If no countries are selected, add "All Countries" back
            if (selectedCountries.length === 0) {
                selectedCountries = ['all'];
                const container = document.getElementById('selected-countries');
                const tag = document.createElement('div');
                tag.className = 'country-tag all-countries';
                tag.setAttribute('data-country', 'all');
                tag.innerHTML = `
                    <span>All Countries</span>
                    <button type="button" class="remove-country" onclick="removeCountry('all')">Ã—</button>
                `;
                container.appendChild(tag);
                
                // Hide "All Countries" option again
                const allOption = dropdown.querySelector('option[value="all"]');
                if (allOption) {
                    allOption.style.display = 'none';
                }
            }
            
            // Update the country counter
            updateCountryCounter();
        }

        async function saveAccountSettings() {
            const profileVisibility = document.getElementById('profile-visibility').value;
            const emailNotifications = document.getElementById('email-notifications').checked;
            const showOnlineStatus = document.getElementById('show-online-status').checked;
            
            // Contact preferences - use the selectedCountries array
            const contactAgeMin = document.getElementById('contact-age-min').value;
            const contactAgeMax = document.getElementById('contact-age-max').value;
            const requirePhotos = document.getElementById('require-photos').checked;
            
            const settings = {
                profileVisibility,
                emailNotifications,
                showOnlineStatus,
                contactPreferences: {
                    allowedCountries: selectedCountries,
                    ageRange: {
                        min: parseInt(contactAgeMin),
                        max: parseInt(contactAgeMax)
                    },
                    requirePhotos
                }
            };
            
            try {
                // Get the user ID
                const userId = getUserIdFromSession();
                
                if (!userId) {
                    alert('Error: User ID not found. Please log in again.');
                    return;
                }
                
                // Save settings via API call
                const response = await fetch(`/api/profile-settings/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const countryNames = selectedCountries.map(code => {
                        if (code === 'all') return 'All Countries';
                        const dropdown = document.getElementById('allowed-countries');
                        const option = dropdown.querySelector(`option[value="${code}"]`);
                        return option ? option.textContent : code;
                    });
                    
                    alert(`Settings saved successfully!\n\nContact Preferences:\n- Countries: ${countryNames.join(', ')}\n- Age Range: ${contactAgeMin}-${contactAgeMax}\n- Require Photos: ${requirePhotos ? 'Yes' : 'No'}\n\nOther Settings:\n- Visibility: ${profileVisibility}\n- Email Notifications: ${emailNotifications}\n- Show Online: ${showOnlineStatus}`);
                } else {
                    alert('Error saving settings: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving settings. Please try again.');
            }
        }

        function exportData() {
            alert('Export data functionality coming soon!');
            // TODO: Implement data export functionality
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    alert('Delete account functionality coming soon!');
                    // TODO: Implement account deletion
                }
            }
        }

        // Online Users Functions
        async function loadOnlineUsers() {
            const container = document.getElementById('online-users');
            const countElement = document.getElementById('online-count');
            
            try {
                container.innerHTML = '<div class="loading">Loading online users...</div>';
                
                const response = await fetch('/api/online-users');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.onlineUsers) {
                    // Get current user to filter them out
                    const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : window.currentUser;
                    const currentUserId = currentUser ? currentUser.id : null;
                    
                    // Filter out the current user from the online users list
                    const otherOnlineUsers = data.onlineUsers.filter(user => 
                        user.userId.toString() !== currentUserId?.toString()
                    );
                    
                    // Update count to show total online users
                    countElement.textContent = `(${data.onlineUsers.length || 0})`;
                    
                    if (!otherOnlineUsers || otherOnlineUsers.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--muted-color);">
                                <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h3>No other users currently online</h3>
                                <p>You're online, but no other users are active right now. Check back later!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Display online users (excluding current user)
                    container.innerHTML = otherOnlineUsers.map(user => `
                        <div class="online-user-card">
                            <div class="user-avatar-placeholder" style="
                                width: 100%; 
                                height: 250px; 
                                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                                display: flex; 
                                align-items: center; 
                                justify-content: center;
                                color: white;
                                font-size: 3rem;
                                border-radius: 15px 15px 0 0;
                            ">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h4>${user.username || 'User'}</h4>
                                <div class="user-location">
                                    <i class="fas fa-circle" style="color: #00b894;"></i>
                                    Online now
                                </div>
                                <div class="user-last-seen">
                                    Last seen: ${formatLastSeen(user.lastSeen)}
                                </div>
                                <div class="user-actions">
                                    <button class="action-btn btn-message" onclick="openConversation('${user.userId}')">
                                        <i class="fas fa-envelope"></i> Message
                                    </button>
                                    <button class="action-btn btn-like" onclick="sendLike('${user.userId}')">
                                        <i class="fas fa-heart"></i> Like
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                } else {
                    throw new Error(data.error || 'Invalid response format');
                }
                
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--danger-color);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Failed to load online users</h3>
                        <p>${error.message}</p>
                        <button onclick="loadOnlineUsers()" class="btn-secondary" style="margin-top: 1rem;">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
                
                if (countElement) {
                    countElement.textContent = '(0)';
                }
            }
        }

        function refreshOnlineUsers() {
            loadOnlineUsers();
        }

        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return new Date(timestamp).toLocaleDateString();
        }

        // Old sendMessage function removed - now using async sendMessage() for chat modal

        function sendLike(userId) {
            alert(`Like functionality coming soon! Would send like to user ${userId}`);
            // TODO: Implement like system
        }

        // Auto-refresh online users every 2 minutes
        setInterval(() => {
            const activeTab = document.querySelector('.tab-panel.active');
            if (activeTab && activeTab.id === 'online-tab') {
                loadOnlineUsers();
            }
        }, 120000); // 2 minutes
    </script>
</body>
</html>
